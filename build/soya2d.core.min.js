var soya2d=new function(){this.__roIndex=0,this.version={v:[1,2,0],state:"rc",toString:function(){return soya2d.version.v.join(".")+" "+soya2d.version.state}},this.website="http://soya2d.com",this.ext=function(t,e,n){for(var i=Object.keys(e),s=i.length;s--;){var o=i[s];(!t.hasOwnProperty(o)||n)&&(t[o]=e[o])}},this.inherits=function(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,t.prototype._super=e.prototype},this.module=new function(){var t={};this.install=function(e,n){t[e]=n},this._getAll=function(){return t}}},soya=soya2d;self.Int8Array=self.Int8Array||Array,self.Uint8Array=self.Uint8Array||Array,self.Int16Array=self.Int16Array||Array,self.Uint16Array=self.Uint16Array||Array,self.Int32Array=self.Int32Array||Array,self.Uint32Array=self.Uint32Array||Array,self.Float32Array=self.Float32Array||Array,self.console=self.console||new function(){this.log=function(){},this.info=function(){},this.debug=function(){},this.error=function(){},this.warn=function(){}},soya2d.console=new function(){this.log=function(t,e){soya2d.Device.ie?console.log(t):console.log("%c"+t,e||"padding:1px 50px;font-size:14px;color:#fff;background:#2DB008;")},this.debug=function(t,e){soya2d.Device.ie?console.debug(t):console.debug("%c"+t,e||"padding:1px 50px;font-size:14px;color:#fff;background:#0069D6;")},this.error=function(t,e){soya2d.Device.ie?console.error(t):console.error("%c"+t,e||"padding:1px 50px;font-size:14px;color:#fff;background:#ff0000;")},this.warn=function(t,e){soya2d.Device.ie?console.warn(t):console.warn("%c"+t,e||"padding:1px 50px;font-size:14px;color:#fff;background:#FFB502;")}},self.cancelAFrame=function(t){return t.cancelAnimationFrame||t.webkitCancelRequestAnimationFrame||t.msCancelRequestAnimationFrame||t.mozCancelRequestAnimationFrame||t.oCancelRequestAnimationFrame||t.clearTimeout}(self),self.requestAFrame=function(t){return t.requestAnimationFrame||t.webkitRequestAnimationFrame||t.msRequestAnimationFrame||t.mozRequestAnimationFrame||t.oRequestAnimationFrame||function(e){return t.setTimeout(function(){e(Date.now())},16.7)}}(self),soya2d.BLEND_NORMAL="source-over",soya2d.BLEND_LIGHTER="lighter",soya2d.BLEND_MASK="destination-in",soya2d.BLEND_CLEAR="destination-out",soya2d.LINECAP_BUTT="butt",soya2d.LINECAP_ROUND="round",soya2d.LINECAP_SQUARE="square",soya2d.LINEJOIN_BEVEL="bevel",soya2d.LINEJOIN_ROUND="round",soya2d.LINEJOIN_MITER="miter",soya2d.TEXTALIGN_LEFT="left",soya2d.TEXTALIGN_CENTER="center",soya2d.TEXTALIGN_RIGHT="right",soya2d.TEXTVALIGN_TOP="hanging",soya2d.TEXTVALIGN_MIDDLE="middle",soya2d.TEXTVALIGN_BOTTOM="alphabetic",soya2d.TEXTDIR_LTR="ltr",soya2d.TEXTDIR_RTL="rtl",soya2d.REPEAT="repeat",soya2d.NOREPEAT="no-repeat",soya2d.REPEAT_X="repeat-x",soya2d.REPEAT_Y="repeat-y",soya2d.GRADIENTTYPE_LINEAR=1,soya2d.GRADIENTTYPE_RADIAL=2,soya2d.HITTEST_PATH=1,soya2d.HITTEST_PIXEL=2,soya2d.Math={PI:3.141592654,PIM2:6.283185307,PID2:1.570796327,PID4:.785398163,ONERAD:.017453292,ONEANG:57.295779513,toRadian:function(t){return t*this.ONERAD},toAngle:function(t){return t*this.ONEANG},randomf:function(t,e){return t+Math.random()*(e-t)},randomi:function(t,e){return t+Math.random()*(e-t)>>0},round:function(t){return.5+t>>0},floor:function(t){return 0|t},len2D:function(t,e,n,i){return Math.sqrt((i-e)*(i-e)+(n-t)*(n-t))},len2Df:function(t,e){t=Math.abs(t),e=Math.abs(e);var n=Math.min(t,e);return t+e-(n>>1)-(n>>2)+(n>>4)},SINTABLE:function(){for(var t=new Float32Array(361),e=.017453292,n=0;360>=n;n++){var i=n*e,s=Math.sin(i);t[n]=s}return t}(),COSTABLE:function(){for(var t=new Float32Array(361),e=.017453292,n=0;360>=n;n++){var i=n*e,s=Math.cos(i);t[n]=s}return t}()},soya2d.ResourceManager=function(){this.urlMap={}},soya2d.ResourceManager.prototype={findOne:function(t){if(!t)return null;if("string"==typeof t){var e=t;t={},t.urls=[e]}else t.urls=[t.url];var n=this.find(t);return 0==n.length?null:n[0]},find:function(t){var e=Object.keys(this.urlMap);if("string"==typeof t){var n=t;t={},t.urls=[n]}var i=t?t.fuzzy||!0:!0,s=[];if(t)for(var o=t.urls.length;o--;){var n=t.urls[o];if(i)for(var r=e.length;r--;)e[r].indexOf(n)>-1&&s.push(e[r]);else for(var r=e.length;r--;)e[r]==n&&s.push(e[r])}else s=e;for(var a=[],r=s.length;r--;)a.push(this.urlMap[s[r]]);return a}},soya2d.Circle=function(t,e,n){this.x=t||0,this.y=e||0,this.r=n||0},soya2d.Circle.prototype={toString:function(){return"{x:"+this.x+",y:"+this.y+",r:"+this.r+"}"},clone:function(){return new soya2d.Circle(this.x,this.y,this.r)}},soya2d.Polygon=function(t){this.vtx=t},soya2d.Polygon.prototype={toString:function(){return this.vtx},clone:function(){return new soya2d.Polygon(this.vtx.concat())}},soya2d.Rectangle=function(t,e,n,i){this.x=t||0,this.y=e||0,this.w=n||0,this.h=i||0},soya2d.Rectangle.prototype={toString:function(){return"{x:"+this.x+",y:"+this.y+",w:"+this.w+",h:"+this.h+"}"},clone:function(){return new soya2d.Rectangle(this.x,this.y,this.w,this.h)},getRight:function(){return this.x+this.w},getBottom:function(){return this.y+this.h},contains:function(t,e){return t<this.x||t>this.x+this.w?!1:e<this.y||e>this.y+this.h?!1:!0}},soya2d.Matrix2x2=function(){this.e=new Float32Array(4),this.identity()},soya2d.Matrix2x2.prototype={toString:function(){return"["+this.e[0]+","+this.e[1]+","+this.e[2]+","+this.e[3]+"]"},set:function(t,e,n,i){var s=this.e;return s[0]=t||1,s[1]=e||0,s[2]=n||0,s[3]=i||1,this},clone:function(){return(new soya2d.Matrix2x2).set(this.e[0],this.e[1],this.e[2],this.e[3])},identity:function(){return this.set(1,0,0,1),this},mul:function(t){var e=this.e[0],n=this.e[1],i=this.e[2],s=this.e[3],o=t.e;return this.e[0]=o[0]*e+o[2]*n,this.e[1]=o[1]*e+o[3]*n,this.e[2]=o[0]*i+o[2]*s,this.e[3]=o[1]*i+o[3]*s,this},scale:function(t,e){return this.e[0]*=t,this.e[1]*=e,this.e[2]*=t,this.e[3]*=e,this},rotate:function(t){if(!t)return this;var e=soya2d.Math;t=0>t?360+t%360:t,t>360&&(t%=360);var n=this.e[0],i=this.e[1],s=this.e[2],o=this.e[3],r=e.SINTABLE[t],a=e.COSTABLE[t];return void 0===r&&(r=Math.sin(t*e.ONERAD),a=Math.cos(t*e.ONERAD)),this.e[0]=n*a+i*-r,this.e[1]=n*r+i*a,this.e[2]=s*a+o*-r,this.e[3]=s*r+o*a,this},skew:function(t,e){var n=this.e[0],i=this.e[1],s=this.e[2],o=this.e[3];if(t){var r;this.skewX===t&&this.sx?r=this.sx:(r=Math.tan(.017453292*t),this.sx=r),this.e[0]+=i*r,this.e[2]+=o*r}if(e){var a;this.skewY===t&&this.sy?a=this.sy:(a=Math.tan(.017453292*e),this.sy=a),this.e[1]+=n*a,this.e[3]+=s*a}return this}},soya2d.Vector=function(t,e){this.e=new Float32Array(2),this.e[0]=t||0,this.e[1]=e||0},soya2d.Vector.prototype={toString:function(){return"{x:"+this.e[0]+",y:"+this.e[1]+"}"},clone:function(){return new soya2d.Vector(this.e[0],this.e[1])},set:function(t,e){return this.e[0]=t||0,this.e[1]=e||0,this},dot:function(t){return this.e[0]*t.e[0]+this.e[1]*t.e[1]},negate:function(){return this.e[0]*=-1,this.e[1]*=-1,this},add:function(t){return this.e[0]+=t.e[0],this.e[1]+=t.e[1],this},sub:function(t){return this.e[0]-=t.e[0],this.e[1]-=t.e[1],this},mul:function(t){return this.e[0]*=t,this.e[1]*=t,this},div:function(t){return t?(this.e[0]/=t,this.e[1]/=t):(this.e[0]=0,this.e[1]=0),this},getAngle:function(){return Math.atan2(this.e[1],this.e[0])},getAngleBetween:function(t){var e=this.dot(t),n=e/(this.length()*t.length());return Math.acos(n)},rotate:function(t){var e=soya2d.Math,n=e.SINTABLE[t],i=e.COSTABLE[t];void 0===n&&(n=Math.sin(t*e.ONERAD),i=Math.cos(t*e.ONERAD));var s=this.e[0],o=this.e[1];return this.e[0]=s*i-o*n,this.e[1]=s*n+o*i,this},lengthSq:function(){return this.e[0]*this.e[0]+this.e[1]*this.e[1]},length:function(){return Math.sqrt(this.lengthSq())},normalize:function(){return this.div(this.length())}},soya2d.DisplayObject=function(t){t=t||{},this.__seq=soya2d.__roIndex++,this.roid="roid_"+this.__seq,this.name=t.name||this.roid,this.visible=t.visible===!1?!1:t.visible||!0,this.__opacity=0===t.opacity?0:t.opacity||1,this.__x=t.x||0,this.__y=t.y||0,this.__w=t.w||0,this.__h=t.h||0,this.__originX=0===t.originX?0:t.originX||"50%",this.__originY=0===t.originY?0:t.originY||"50%",this.__rotation=t.rotation||0,this.__scaleX=t.scaleX||1,this.__scaleY=t.scaleY||1,this.__skewX=t.skewX||0,this.__skewY=t.skewY||0,Object.defineProperties(this,{opacity:{set:function(t){t=0==t?0:parseFloat(t)||1,this.__opacity=0>t?0:t>1?1:t},get:function(){return this.__opacity},enumerable:!0},x:{set:function(t){this.__x=t||0,this.__localChange=!0},get:function(){return this.__x},enumerable:!0},y:{set:function(t){this.__y=t||0,this.__localChange=!0},get:function(){return this.__y},enumerable:!0},w:{set:function(t){this.__w=t,this.__originChange=!0},get:function(){return this.__w},enumerable:!0},h:{set:function(t){this.__h=t,this.__originChange=!0},get:function(){return this.__h},enumerable:!0},originX:{set:function(t){this.__originX=t,this.__originChange=!0},get:function(){return this.__originX},enumerable:!0},originY:{set:function(t){this.__originY=t,this.__originChange=!0},get:function(){return this.__originY},enumerable:!0},rotation:{set:function(t){this.__rotation=t,this.__localChange=!0},get:function(){return this.__rotation},enumerable:!0},scaleX:{set:function(t){this.__scaleX=t,this.__localChange=!0},get:function(){return this.__scaleX},enumerable:!0},scaleY:{set:function(t){this.__scaleY=t,this.__localChange=!0},get:function(){return this.__scaleY},enumerable:!0},skewX:{set:function(t){this.__skewX=t,this.__localChange=!0},get:function(){return this.__skewX},enumerable:!0},skewY:{set:function(t){this.__skewY=t,this.__localChange=!0},get:function(){return this.__skewY},enumerable:!0}}),this.z=t.z||0,this.__localChange=!0,this.__originChange=!0,this.__localTransform=new soya2d.Matrix2x2,this.__worldTransform=new soya2d.Matrix2x2,this.__worldPosition=new soya2d.Vector,this.__originPosition=new soya2d.Vector,this.blendMode=t.blendMode||"source-over",this.mask=t.mask||new soya2d.Mask,this.bounds=t.bounds||new soya2d.Rectangle(0,0,this.__w,this.__h),this.__boundRect=new soya2d.Rectangle(0,0,1,1),this.body=null},soya2d.ext(soya2d.DisplayObject.prototype,{toString:function(){return'{roid:"'+this.roid+'";name:"'+this.name+'"}'},updateTransform:function(){var t=this.__x,e=this.__y;this.__localChange&&(this.__localTransform.identity(),this.__localTransform.scale(this.__scaleX,this.__scaleY).rotate(this.__rotation).skew(this.__skewX,this.__skewY));var n=this.__localTransform,i=this.__worldTransform,s=this.__originPosition,o=n.e,r=s.e,a=r[0],h=r[1];if(this.__originChange&&(a=this.__originX,h=this.__originY,a="number"==typeof a?a:parseFloat(a)/100*this.__w,h="number"==typeof h?h:parseFloat(h)/100*this.__h,s.set(a,h)),t+=a,e+=h,i.set(o[0],o[1],o[2],o[3]),this.parent){var l=this.parent.__worldTransform,u=l.e,c=this.parent.__worldPosition.e,d=this.parent.__originPosition.e,f=d[0]*u[0]+d[1]*u[2],y=d[0]*u[1]+d[1]*u[3],g=t*u[0]+e*u[2],_=t*u[1]+e*u[3];t=g+c[0]-f,e=_+c[1]-y,i.mul(l)}this.__worldPosition.set(t,e),this.__localChange=this.__originChange=!1},isRendered:function(){if(!this.visible||0===this.opacity)return!1;for(var t=this.parent;t;){if(!t.visible||0===t.opacity)return!1;t=t.parent}return!0},clone:function(t,e){e=e||new this.constructor;for(var n=Object.keys(this),i=n.length;i--;){var s=n[i];if("parent"!==s&&"__seq"!==s&&"roid"!==s&&"__localTransform"!==s&&"__worldTransform"!==s&&"__worldPosition"!==s&&"__originPosition"!==s&&(t||"children"!==s))if(t&&"children"===s&&this[s]&&this[s].length>0){e[s]=[];for(var o=0;o<this[s].length;o++){var r=this[s][o],a=r.clone(t);a.parent=e,e[s].push(a)}}else e[s]=this[s]instanceof Array?this[s].slice(0):this[s]}return e},moveBy:function(){var t=arguments[0]||0,e=0===arguments[1]?0:arguments[1]||t;return this.x+=t,this.y+=e,this},moveTo:function(){var t=arguments[0]||0,e=0===arguments[1]?0:arguments[1]||t;return this.x=t,this.y=e,this},opacifyTo:function(t){return this.opacity=t>1?1:0>t?0:t,this},opacifyBy:function(t){return this.opacity+=t,this.opacity>1&&(this.opacity=1),this.opacity<0&&(this.opacity=0),this},resizeTo:function(){var t=arguments[0]||0,e=0===arguments[1]?0:arguments[1]||t;return this.w=t,this.h=e,this},scaleBy:function(){var t=arguments[0]||0,e=0===arguments[1]?0:arguments[1]||t;return this.scaleX+=t,this.scaleY+=e,this},scaleTo:function(){var t=arguments[0]||0,e=0===arguments[1]?0:arguments[1]||t;return this.scaleX=t,this.scaleY=e,this},skewBy:function(){var t=arguments[0]||0,e=0===arguments[1]?0:arguments[1]||t;return this.skewX+=t,this.skewY+=e,this},skewTo:function(){var t=arguments[0]||0,e=0===arguments[1]?0:arguments[1]||t;return this.skewX=t,this.skewY=e,this},rotateBy:function(t){return this.angle+=t,this},rotateTo:function(t){return this.angle=t,this},originBy:function(){var t=arguments[0]||0,e=0===arguments[1]?0:arguments[1]||t;return this.originX+=t,this.originY+=e,this},originTo:function(){var t=arguments[0]||0,e=0===arguments[1]?0:arguments[1]||t;return this.originX=t,this.originY=e,this},getBoundingPoints:function(){var t=this.__worldTransform.e,e=this.__worldPosition.e,n=this.__originPosition.e,i=e[0],s=e[1],o=t[0],r=t[1],a=t[2],h=t[3],l=n[0],u=n[1],c=-l,d=-u,f=this.w-l,y=-u,g=-l,_=this.h-u,p=this.w-l,m=this.h-u;return[c*o+d*a+i,c*r+d*h+s,f*o+y*a+i,f*r+y*h+s,p*o+m*a+i,p*r+m*h+s,g*o+_*a+i,g*r+_*h+s]},getBoundingBox:function(){var t,e,n,i,s=this.getBoundingPoints();n=s[0],t=s[0],i=s[1],e=s[1];for(var o=s.length;o--;)o%2===0?(s[o]>n&&(n=s[o]),s[o]<t&&(t=s[o])):(s[o]>i&&(i=s[o]),s[o]<e&&(e=s[o]));return sx=t,sy=e,sw=n-t,sh=i-e,this.__boundRect.x=sx,this.__boundRect.y=sy,this.__boundRect.w=sw,this.__boundRect.h=sh,this.__boundRect},hitTest:function(t,e){var n=this.__worldPosition.e;if(this.bounds instanceof soya2d.Circle){var i=Math.abs(soya2d.Math.len2D(n[0],n[1],t,e));if(i<=this.bounds.r)return!0}else if(this.bounds instanceof soya2d.Rectangle||this.bounds instanceof soya2d.Polygon){var s;if(this.bounds.vtx){var o=this.__worldTransform.e,r=this.__originPosition.e,a=n[0],h=n[1],l=o[0],u=o[1],c=o[2],d=o[3],f=r[0],y=r[1],g=-f,_=-y;s=[];for(var p=0;p<this.bounds.vtx.length;p+=2){var m=this.bounds.vtx[p]+g,v=this.bounds.vtx[p+1]+_;s.push(m*l+v*c+a,m*u+v*d+h)}}else s=this.getBoundingPoints();for(var x=!1,p=0;p<s.length;p+=2){var m=s[p],v=s[p+1],T=s[p+2]||s[0],w=s[p+3]||s[1];if(m===t&&v===e||T===t&&w===e)return!0;if(e>v&&w>=e||v>=e&&e>w){var E=(e-v)/(w-v)*(T-m)+m;if(E===t)return!0;E>t&&(x=!x)}}return x}return!1},getAnchorPosition:function(){var t=this.__worldTransform.e,e=this.__worldPosition.e,n=this.__originPosition.e,i=e[0],s=e[1],o=t[0],r=t[1],a=t[2],h=t[3],l=n[0],u=n[1],c=-l,d=-u,f=this.w*parseInt(this.originX)/100,y=this.h*parseInt(this.originY)/100,g=Math.sqrt(y*y+f*f),_=Math.atan2(y,f);return f=Math.cos(_)*g+c,y=Math.sin(_)*g+d,[f*o+y*a+i,f*r+y*h+s]}}),soya2d.DisplayObjectContainer=function(t){t=t||{},soya2d.DisplayObject.call(this,t),this.children=[],this.parent=null},soya2d.inherits(soya2d.DisplayObjectContainer,soya2d.DisplayObject),soya2d.ext(soya2d.DisplayObjectContainer.prototype,{add:function(){for(var t=0;t<arguments.length;t++){var e=arguments[t];e.parent||(this.children.push(e),e.parent=this)}return this},remove:function(){for(var t=0;t<arguments.length;t++){var e=arguments[t],n=this.children.indexOf(e);0>n||(this.children.splice(n,1),e.parent=null)}return this},clear:function(){for(var t=this.children.length;t--;)this.children[t].parent=null;var e=this.children;return this.children=[],e},find:function(t,e){if(this.children.length<1)return[];var n;return e?(n=[],!function(e){for(var i=e.children.length;i--;){var s=e.children[i];t(s)&&n.push(s),s.children&&s.children.length>0&&arguments.callee(s)}}(this)):n=this.children.filter(t),n}}),soya2d.Mask=function(){this.list=[]},soya2d.ext(soya2d.Mask.prototype,{add:function(){for(var t=0;t<arguments.length;t++){var e=arguments[t];this.list.push(e)}return this},getShape:function(t){return this.list[t]},clear:function(){if(arguments.length>0)for(var t=0;t<arguments.length;t++){var e=arguments[t],n=this.children.indexOf(e);0>n||this.list.splice(n,1)}else this.list=[];return this}}),soya2d.Scene=function(t){function e(t,n){if(t.updateTransform(),t.children)for(var i=t.children.length;i--;){var s=t.children[i];s.opacity>0&&s.visible&&(n.push(s),e(s,n))}}function n(t,e){for(var i=t.length;i--;){var s=t[i];s._onUpdate&&s._onUpdate(e),s.onUpdate&&s.onUpdate(e),s.children&&n(s.children,e)}}t=t||{},soya2d.DisplayObjectContainer.call(this,t),soya2d.ext(this,t),this.__updateMatrix=function(){this.__renderQueue=[],e(this,this.__renderQueue)},this.__update=function(t){this.children&&n(this.children,t)},this.findVisible=function(t){return this.__renderQueue?this.__renderQueue.filter(t):[]}},soya2d.inherits(soya2d.Scene,soya2d.DisplayObjectContainer),soya2d.ScrollSprite=function(t){t=t||{},soya2d.DisplayObjectContainer.call(this,t),soya2d.ext(this,t),this.scope=t.scope,this.freezone=t.freezone,this.__boundContainer=new soya2d.DisplayObjectContainer,this.children.push(this.__boundContainer)},soya2d.inherits(soya2d.ScrollSprite,soya2d.DisplayObjectContainer),soya2d.ext(soya2d.ScrollSprite.prototype,{add:function(){return this.__boundContainer.add.apply(this.__boundContainer,arguments),this},remove:function(){return this.__boundContainer.remove.apply(this.__boundContainer,arguments),this},clear:function(){return this.__boundContainer.clear()},find:function(t,e){return this.__boundContainer.find(t,e)},follow:function(t){var e=this.__boundContainer.find(function(e){return t.roid===e.roid?!0:void 0},!0);return e.length<0&&console.error("soya2d.ScrollSprite: "+t.toString()+" must be a child node of soya2d.ScrollSprite"),this.target=t,this._onUpdate(),this},unfollow:function(){this.target=null},scrollTo:function(t,e){this.target||(this.__boundContainer.x=t,this.__boundContainer.y=e,this.__checkBounds())},scrollBy:function(t,e){this.target||(this.__boundContainer.x+=t,this.__boundContainer.y+=e,this.__checkBounds())},__checkBounds:function(){if(this.scope){var t=this.scope.x,e=this.scope.y,n=this.scope.w,i=this.scope.h,s=this.__boundContainer.x;s>t&&(this.__boundContainer.x=t),n>0&&s<this.w-n&&(this.__boundContainer.x=this.w-n);var o=this.__boundContainer.y;o>e&&(this.__boundContainer.y=e),i>0&&o<this.h-i&&(this.__boundContainer.y=this.h-i)}},setScope:function(t){t&&(this.scope=t,this.__boundContainer.w=t.w,this.__boundContainer.h=t.h)},_onUpdate:function(){if(this.target){var t,e;this.target.updateTransform();var n=this.target.__worldPosition.e;t=n[0],e=n[1];var i,s,o=this.target.w,r=this.target.h,a=this.__boundContainer.getBoundingPoints(),h=a[0],l=a[1],u=t-h,c=e-l;if(this.freezone){var d=-1*this.__boundContainer.x,f=-1*this.__boundContainer.y,y=u-d,g=c-f,_=o/2,p=r/2,m=this.freezone.x,v=this.freezone.y,x=this.freezone.w,T=this.freezone.h;if(m>y-_?i=u-_-m:y+_>m+x&&(i=u+_-m-x),v>g-p?s=c-p-v:g+p>v+T&&(s=c+p-v-T),!i&&!s)return}else i=u-this.w/2,s=c-this.h/2;i&&(this.__boundContainer.x=-i),s&&(this.__boundContainer.y=-s),this.__checkBounds()}},onRender:function(t){t.beginPath(),t.rect(0,0,this.w,this.h),t.clip()}}),soya2d.Shape=function(t){t=t||{},soya2d.DisplayObjectContainer.call(this,t),soya2d.ext(this,t)},soya2d.inherits(soya2d.Shape,soya2d.DisplayObjectContainer),soya2d.Sprite=function(t){t=t||{},soya2d.DisplayObjectContainer.call(this,t),soya2d.ext(this,t);var e=t.textures;this.setTextures(e),this.w=t.w||this.textures[0].w,this.h=t.h||this.textures[0].h,this.multiFrame=this.textures.length>1?!0:!1,this.frameIndex=0,this.__currTex,this.__lastUpdateTime=0,this.frameRate=t.frameRate||10,this.loop=t.loop===!1?!1:t.loop||!0,this.autoplay=t.autoplay||!1},soya2d.inherits(soya2d.Sprite,soya2d.DisplayObjectContainer),soya2d.ext(soya2d.Sprite.prototype,{clone:function(t){var e=new this.constructor({textures:this.textures.concat()});return soya2d.DisplayObject.prototype.clone.call(this,t,e)},onRender:function(t){if(this.multiFrame){if(this.__lastUpdateTime||(this.__lastUpdateTime=(new Date).getTime()),this.autoplay){var e=(new Date).getTime(),n=e-this.__lastUpdateTime,i=n/(16.7*this.frameRate)>>0;i>0&&(this.frameIndex+=i,this.frameIndex>=this.textures.length&&(this.frameIndex=this.loop?0:this.textures.length-1),this.__lastUpdateTime=e)}this.__currTex=this.textures[this.frameIndex],t.map(this.__currTex,0,0,this.w,this.h)}else t.map(this.textures[0],0,0,this.w,this.h)},nextFrame:function(){this.frameIndex++,this.frameIndex>=this.textures.length&&(this.frameIndex=this.loop?0:this.textures.length-1)},prevFrame:function(){this.frameIndex--,this.frameIndex<0&&(this.frameIndex=this.loop?this.textures.length-1:0)},setTextures:function(t){this.textures=t instanceof soya2d.Texture?[t]:t instanceof self.Image?[soya2d.Texture.fromImage(t)]:t instanceof Array?t:[],this.textures[0]||console.error("soya2d.Sprite: invalid param [textures]; "+this.textures[0])}}),soya2d.TileSprite=function(t){t=t||{},soya2d.DisplayObjectContainer.call(this,t),soya2d.ext(this,t),this.sprite=null,t.sprite instanceof soya2d.Texture||t.sprite instanceof self.Image?this.sprite=new soya2d.Sprite({textures:t.sprite}):t.sprite instanceof soya2d.Sprite&&(this.sprite=t.sprite),this.w=t.w||this.sprite.w,this.h=t.h||this.sprite.h,this.autoScroll=t.autoScroll||!1,this.speed=t.speed||1,this.angle=t.angle||0,this.__tileOffx=0,this.__tileOffy=0},soya2d.inherits(soya2d.TileSprite,soya2d.DisplayObjectContainer),soya2d.ext(soya2d.TileSprite.prototype,{scroll:function(t,e){if(t||e)this.__tileOffx+=t||0,this.__tileOffy+=e||0;else{var n=(this.angle>>0)%360;this.__tileOffx+=soya2d.Math.COSTABLE[n]*this.speed,this.__tileOffy+=soya2d.Math.SINTABLE[n]*this.speed}},clone:function(t){var e=new this.constructor({sprite:this.sprite});return soya2d.DisplayObject.prototype.clone.call(this,t,e),e},_onUpdate:function(){if(this.autoScroll){var t=(this.angle>>0)%360;this.__tileOffx+=soya2d.Math.COSTABLE[t]*this.speed,this.__tileOffy+=soya2d.Math.SINTABLE[t]*this.speed}},onRender:function(t){t.beginPath(),t.push(),t.rect(0,0,this.w,this.h),t.clip();var e=this.sprite,n=e.w,i=e.h,s=n*e.scaleX,o=i*e.scaleY;s=0>s?-1*s:s,o=0>o?-1*o:o;var r=(this.w/s>>0)+2,a=(this.h/o>>0)+2,h=this.__tileOffx%s,l=this.__tileOffy%o;this.__tileOffx>0&&(h-=s),this.__tileOffy>0&&(l-=o);for(var u=this.sprite.textures[0],c=a;c--;)for(var d=r;d--;){var f=d*s,y=c*o;t.map(u,f+h,y+l,s,o,0,0,n,i)}t.pop()}}),soya2d.CanvasGraphics=function(t){this.ctx=t,this.opacity=function(t){return 0===t||t?(this.ctx.globalAlpha=t,this):this.ctx.globalAlpha},this.closePath=function(){return this.ctx.closePath(),this},this.moveTo=function(t,e){return this.ctx.moveTo(t,e),this},this.lineTo=function(t,e){return this.ctx.lineTo(t,e),this},this.quadraticCurveTo=function(t,e,n,i){return this.ctx.quadraticCurveTo(t,e,n,i),this},this.bezierCurveTo=function(t,e,n,i,s,o){return this.ctx.bezierCurveTo(t,e,n,i,s,o),this},this.arcTo=function(t,e,n,i,s){return this.ctx.arcTo(t,e,n,i,s),this},this.rect=function(t,e,n,i){return this.ctx.rect(t,e,n,i),this},this.polygon=function(t){var e=this.ctx,n=t.length-1;e.moveTo(t[0],t[1]);for(var i=2;n>i;i+=2)e.lineTo(t[i],t[i+1]);return this},this.ellipse=function(t,e,n,i){var s=.5522848,o=n/2*s,r=i/2*s,a=t+n,h=e+i,l=t+n/2,u=e+i/2,c=this.ctx;return c.moveTo(t,u),c.bezierCurveTo(t,u-r,l-o,e,l,e),c.bezierCurveTo(l+o,e,a,u-r,a,u),c.bezierCurveTo(a,u+r,l+o,h,l,h),c.bezierCurveTo(l-o,h,t,u+r,t,u),this},this.roundRect=function(t,e,n,i,s){var o=this.ctx;return o.moveTo(t+s,e),o.lineTo(t+(n-(s<<1)),e),o.arc(t+n-s,e+s,s,3*Math.PI/2,0),o.lineTo(t+n,e+i-s),o.arc(t+n-s,e+i-s,s,0,soya2d.Math.PID2),o.lineTo(t+s,e+i),o.arc(t+s,e+i-s,s,soya2d.Math.PID2,Math.PI),o.lineTo(t,e+s),o.arc(t+s,e+s,s,Math.PI,3*Math.PI/2),this},this.arc=function(t,e,n,i,s){return this.ctx.arc(t,e,n,i||0,s||soya2d.Math.PIM2),this},this.regularPolygon=function(t,e,n,i,s){t=t||0,e=e||0,n=3>n?3:n;for(var o=soya2d.Math,r=[],a=360/n,h=0,l=0;360>h;h+=a,l++){var u=i;s&&(u=l%2!==0?i:s),o.COSTABLE[h]?r.push(t+u*o.COSTABLE[h],e+u*o.SINTABLE[h]):r.push(t+u*o.COSTABLE[Math.round(h)],e+u*o.SINTABLE[Math.round(h)])}return this.polygon(r),this},this.blendMode=function(t){return t?(this.ctx.globalCompositeOperation=t,this):this.ctx.globalCompositeOperation},this.strokeStyle=function(t){return t?(this.ctx.strokeStyle=t,this):this.ctx.strokeStyle},this.fillStyle=function(t){return t?(this.ctx.fillStyle=t,this):this.ctx.fillStyle},this.shadow=function(t,e,n,i){return this.ctx.shadowBlur=t,this.ctx.shadowColor=e,this.ctx.shadowOffsetX=n,this.ctx.shadowOffsetY=i,this},this.lineStyle=function(t,e,n,i){var s=this.ctx;return s.lineWidth=t,s.lineCap=e||s.lineCap,s.lineJoin=n||s.lineJoin,s.miterLimit=i||s.miterLimit,this},this.font=function(t){var e=this.ctx;return e.font=t.getDesc(),this},this.clip=function(){return this.ctx.clip(),this},this.push=function(){return this.ctx.save(),this},this.pop=function(){return this.ctx.restore(),this},this.beginPath=function(){return this.ctx.beginPath(),this},this.closePath=function(){return this.ctx.closePath(),this},this.fill=function(){return this.ctx.fill(),this},this.stroke=function(){return this.ctx.stroke(),this},this.path=function(t){t._insQ.forEach(function(t){var e=t[0].toLowerCase();switch(e){case"m":this.ctx.moveTo(t[1][0],t[1][1]);break;case"l":var n=t[1];if(n.length>2)for(var i=0;i<n.length;i+=2)this.ctx.lineTo(n[i],n[i+1]);else this.ctx.lineTo(n[0],n[1]);break;case"c":var n=t[1];if(n.length>6)for(var i=0;i<n.length;i+=6)this.ctx.bezierCurveTo(n[i],n[i+1],n[i+2],n[i+3],n[i+4],n[i+5]);else this.ctx.bezierCurveTo(n[0],n[1],n[2],n[3],n[4],n[5]);break;case"q":var n=t[1];if(n.length>4)for(var i=0;i<n.length;i+=4)this.ctx.quadraticCurveTo(n[i],n[i+1],n[i+2],n[i+3]);else this.ctx.quadraticCurveTo(n[0],n[1],n[2],n[3]);break;case"z":this.ctx.closePath()}},this)},this.fillRect=function(t,e,n,i){return this.ctx.fillRect(t,e,n,i),this},this.strokeRect=function(t,e,n,i){return this.ctx.strokeRect(t,e,n,i),this},this.clearRect=function(t,e,n,i){return this.ctx.clearRect(t,e,n,i),this},this.map=function(t,e,n,i,s,o,r,a,h){return o=o||0,r=r||0,a=a||t.w,h=h||t.h,0!==a&&0!==h&&0!==s&&0!==s?(this.ctx.drawImage(t.__data,o>>0,r>>0,a>>0,h>>0,e>>0,n>>0,i>>0,s>>0),this):void 0},this.fillText=function(t,e,n,i){return i?this.ctx.fillText(t,e||0,n||0,i):this.ctx.fillText(t,e||0,n||0),this},this.strokeText=function(t,e,n,i){return i?this.ctx.strokeText(t,e||0,n||0,i):this.ctx.strokeText(t,e||0,n||0),this}},soya2d.CanvasRenderer=function(t){function e(t,n,i,s){if(0!==n.opacity&&n.visible){if(n.mask instanceof soya2d.Mask&&n.mask.list.length>0){t.save(),t.beginPath(),t.setTransform(1,0,0,1,0,0);for(var o=n.mask.list,r=0;r<o.length;r++){var a=o[r];a instanceof soya2d.Rectangle?h.rect(a.x,a.y,a.w,a.h):a instanceof soya2d.Circle?(t.moveTo(a.x+a.r,a.y),h.arc(a.x,a.y,a.r)):a instanceof soya2d.Polygon&&h.polygon(a.vtx)}t.closePath(),t.clip()}if(n instanceof soya2d.ScrollSprite&&t.save(),n.onRender){var l=n.__worldTransform.e,u=n.__worldPosition.e;t.setTransform(l[0],l[1],l[2],l[3],u[0],u[1]),n.opacity<=1&&n.opacity!==i.opacity&&(i.opacity=n.opacity,t.globalAlpha=n.opacity),i.blendMode!==n.blendMode&&(i.blendMode=n.blendMode,t.globalCompositeOperation=n.blendMode);var c=n.__originPosition.e;t.translate(-c[0],-c[1]),n.onRender(h)}if(n.children&&n.children.length>0){var d=n.children;s&&d.sort(function(t,e){return t.z===e.z?t.__seq-e.__seq:t.z-e.z});for(var f=0;f<d.length;f++)e(t,d[f],i,s)}n instanceof soya2d.ScrollSprite&&t.restore(),n.mask instanceof soya2d.Mask&&n.mask.list.length>0&&t.restore()}}t=t||{};var n=t.container;this.w=t.w||(n?n.clientWidth:0),this.h=t.h||(n?n.clientHeight:0),this.autoClear=void 0===t.autoClear?!0:t.autoClear,this.sortEnable=t.sortEnable||!1;var i=t.smoothEnable===!1?!1:t.smoothEnable||!0,s=t.crispEnable||!1,o=document.createElement("canvas");o.style.position="absolute";var r=window.getComputedStyle(t.container,null).position;"absolute"!==r&&"relative"!==r&&(n.style.position="relative"),r=null,n.appendChild(o),n=null;var a=o.getContext("2d"),h=new soya2d.CanvasGraphics(a);o.width=this.w,o.height=this.h,this.ctx=a,a.textBaseline=soya2d.TEXTVALIGN_TOP;var l={opacity:1,blendMode:"source-over"};this.getCanvas=function(){return o},this.render=function(t){!t instanceof soya2d.Scene||(t.__updateMatrix(),a.setTransform(1,0,0,1,0,0),this.autoClear&&a.clearRect(0,0,this.w,this.h),e(a,t,l,this.sortEnable))},this.resize=function(t,e){var n=o.width,i=o.height;this.hr=t/n,this.vr=e/i,o.style.width=t+"px",o.style.height=e+"px"},this.hr=1,this.vr=1,this.smooth=function(t){return void 0!==t?(a.imageSmoothingEnabled=a.webkitImageSmoothingEnabled=a.mozImageSmoothingEnabled=a.oImageSmoothingEnabled=a.msImageSmoothingEnabled=t,i=t,this):i},this.smooth(i),this.crisp=function(t){t?(o.style["image-rendering"]="optimizeSpeed",o.style["image-rendering"]="crisp-edges",o.style["image-rendering"]="-moz-crisp-edges",o.style["image-rendering"]="-webkit-optimize-contrast",o.style["image-rendering"]="optimize-contrast",o.style["image-rendering"]="pixelated",o.style.msInterpolationMode="nearest-neighbor"):(o.style["image-rendering"]="auto",o.style.msInterpolationMode="bicubic")},this.crisp(s),this.getImageData=function(t,e,n,i){return t=t||0,e=e||0,n=n||this.w,i=i||this.h,a.getImageData(t,e,n,i)},this.toDataURL=function(t){return o.toDataURL(t||"image/png")},this.getHitTester=function(t){switch(t){case 2:return this.__pixelTester;case 1:default:return this.__pathTester}},this.__pixelTester=new soya2d.__HitPixelTester(this.w,this.h),this.__pathTester=new soya2d.__HitPathTester(this.w,this.h),this.createPattern=function(t,e){return a.createPattern(t,e||"repeat")},this.createGradient=function(t,e,n,i){var s=0,o=0,r=0,h=soya2d.GRADIENTTYPE_LINEAR,l=0,u=0;i&&(s=i.angle||0,o=i.x||0,r=i.y||0,h=i.type||soya2d.GRADIENTTYPE_LINEAR,l=i.focalRatio||0,u=i.focalRadius||0);var c,d=soya2d.Math;switch(s=Math.abs((s||0)>>0),h){case soya2d.GRADIENTTYPE_LINEAR:c=a.createLinearGradient(o,r,o+n*d.COSTABLE[s],r+n*d.SINTABLE[s]);for(var f=0,y=t.length;y>f;f++)c.addColorStop(t[f],e[f]||"RGBA(0,0,0,0)");break;case soya2d.GRADIENTTYPE_RADIAL:var g=n*l;c=a.createRadialGradient(o,r,u,o+g*d.COSTABLE[s],r+g*d.SINTABLE[s],n);for(var f=0,y=t.length;y>f;f++)c.addColorStop(t[f],e[f]||"RGBA(0,0,0,0)")}return c}},soya2d.CanvasRenderer.prototype.getImageFrom=function(t,e,n){var i=document.createElement("canvas");i.width=e||t.w,i.height=n||t.h;var s=i.getContext("2d"),o=new soya2d.CanvasGraphics(s),r=new Image;return r.src=i.toDataURL("image/png"),o=null,i=null,r},soya2d.__HitPathTester=function(t,e){function n(t){t.stroke=function(){},t.fill=function(){},t.fillRect=function(e,n,i,s){t.rect(e,n,i,s)},t.strokeRect=function(e,n,i,s){t.rect(e,n,i,s)},t.drawImage=function(e,n,i,s,o,r,a,h,l){3===arguments.length?t.rect(n,i,e.width,e.height):5===arguments.length?t.rect(n,i,s,o):9===arguments.length&&t.rect(r,a,h,l)},t.fillText=function(){},t.strokeText=function(){}}function i(t,e,n){var i=t.__worldTransform.e,s=t.__worldPosition.e;if(e.setTransform(i[0],i[1],i[2],i[3],s[0],s[1]),t.onRender){e.beginPath();var o=t.__originPosition.e;e.translate(-o[0],-o[1]),t.onRender(n)}}var s=document.createElement("canvas");s.width=t,s.height=e;var o=s.getContext("2d"),r=new soya2d.CanvasGraphics(o);n(o),this.test=function(t,e,n){return i(t,o,r),o.isPointInPath(e,n)}},soya2d.__HitPixelTester=function(t,e){function n(t,e,n){var i=t.__worldTransform.e,s=t.__worldPosition.e;if(e.setTransform(i[0],i[1],i[2],i[3],s[0],s[1]),t.onRender){e.beginPath();var o=t.__originPosition.e;e.translate(-o[0],-o[1]),t.onRender(n)}}var t,e,i=document.createElement("canvas");i.width=t,i.height=e;var s=i.getContext("2d"),o=new soya2d.CanvasGraphics(s);this.test=function(i,r,a){n(i,s,o);var h=s.getImageData(0,0,t,e).data;return!!h[4*(t*a+r)+3]}},soya2d.HitTester=function(){soya2d.HitTester.prototype.test=function(){}},soya2d.Device=new function(){var t=this.userAgent=self.navigator.userAgent.toLowerCase(),e=t.indexOf("windows")>0?!0:!1,n=t.indexOf("linux")>0?!0:!1,i=t.indexOf("mac os")>0?!0:!1,s=t.indexOf("android")>0?!0:!1,o=t.indexOf("iphone")>0?!0:!1,r=t.indexOf("ipad")>0?!0:!1,a=t.indexOf("windows phone")>0?!0:!1;this.iphone=o,this.ipad=r,this.ios=o||r,this.android=s,this.wp=a,this.mobile=this.ios||s||a,this.windows=e,this.linux=n,this.mac=i;
var h={Firefox:t.indexOf("firefox")+1,Opera:t.indexOf("opera")+1,Chrome:t.indexOf("chrome")+1,Safari:t.indexOf("safari")>-1&&t.indexOf("chrome")<0};this.ie=/msie|trident.*rv:/.test(t.toLowerCase()),this.ff=h.Firefox?!0:!1,this.opera=h.Opera?!0:!1,this.chrome=h.Chrome?!0:!1,this.safari=h.Safari?!0:!1},!function(){function t(t,e,n,i,s,o,r,a){n=r&&n>r?r:n,i=a&&i>a?a:i;var h=Math.max(n/t,i/e),l=t*h,u=e*h;return[l,u]}function e(t,e,n,i,s,o,r,a){n=r&&n>r?r:n,i=a&&i>a?a:i;var h=Math.min(n/t,i/e),l=t*h,u=e*h;return[l,u]}function n(t,e,n,i,s,o,r,a){var h,l;return h=s&&s>n?s:r&&n>r?r:n,l=o&&o>i?o:a&&i>a?a:i,[h,l]}soya2d.View=function(i){function s(){var t,e=window.innerWidth,n=window.innerHeight;return t=e>n?"landscape":"portrait"}function o(t,e,n,i){switch(e){case soya2d.ROTATEMODE_90:rs="rotate(90deg)";break;case soya2d.ROTATEMODE_180:rs="rotate(180deg)";break;case soya2d.ROTATEMODE_270:rs="rotate(270deg)";break;case soya2d.ROTATEMODE_0:default:rs="rotate(0deg)",h=soya2d.ROTATEMODE_0}if(n.style.transform=n.style.webkitTransform=n.style.mozTransform=n.style.msTransform=n.style.oTransform=rs,n.style.left=n.style.top=0,e===soya2d.ROTATEMODE_90||e===soya2d.ROTATEMODE_270){var s=n.offsetWidth,o=n.offsetHeight;if(t===soya2d.SCALEMODE_NOBORDER){var r=this.game.w,a=this.game.h;s=s>a?a:s,o=o>r?r:o}if(i.resize(o,s),t===soya2d.SCALEMODE_EXACTFIT){var l=(s-o)/2;l=o%2===0?l:Math.floor(l);var u=(o-s)/2;u=s%2===0?u:Math.floor(u),n.style.left=l+"px",n.style.top=u+"px"}}}this.game=i,this.scaleMode=soya2d.SCALEMODE_SHOWALL,this.minWidth=0,this.minHeight=0,this.maxWidth=0,this.maxHeight=0,this.autoScale=!0,this.scan=function(){if(this.game){var i,s=this.game.w,r=this.game.h;switch(this.scaleMode){case soya2d.SCALEMODE_NOSCALE:break;case soya2d.SCALEMODE_NOBORDER:i=t;break;case soya2d.SCALEMODE_EXACTFIT:i=n;break;case soya2d.SCALEMODE_SHOWALL:default:i=e}if(i){var a=this.game.getRenderer(),l=a.getCanvas().parentNode,u=l.clientWidth,c=l.clientHeight;"BODY"===l.tagName&&(c=window.innerHeight);var d=i(s,r,u,c,this.minWidth,this.minHeight,this.maxWidth,this.maxHeight);a.resize(d[0],d[1]),this.w=d[0],this.h=d[1],o(this.scaleMode,h,a.getCanvas(),a)}}},this.orientation=s();var r,a=this;window.addEventListener("orientationchange",function(){clearTimeout(r),r=setTimeout(function(){a.orientation=s()},500),a.autoScale&&a.scan()},!1),window.addEventListener("resize",function(){a.orientation=s(),a.autoScale&&a.scan()},!1);var h=soya2d.ROTATEMODE_0;this.rotate=function(t){return this.game?t?(h=t,this.scan(),this):h:void 0};var l=soya2d.ALIGNMODE_CENTER;this.align=function(t){if(this.game){if(t&&this.scaleMode===soya2d.SCALEMODE_SHOWALL){var e=this.game.getRenderer().getCanvas();switch(l=t,t){case soya2d.ALIGNMODE_LEFT:e.style.left=0,e.style.right="auto";break;case soya2d.ALIGNMODE_RIGHT:e.style.left="auto",e.style.right=0;break;case soya2d.ALIGNMODE_CENTER:default:e.style.left=0,e.style.right=0,l=soya2d.ALIGNMODE_CENTER}return e.style.margin="auto",this}return l}}},soya2d.SCALEMODE_NOSCALE=0,soya2d.SCALEMODE_SHOWALL=1,soya2d.SCALEMODE_NOBORDER=2,soya2d.SCALEMODE_EXACTFIT=3,soya2d.ALIGNMODE_LEFT=1,soya2d.ALIGNMODE_CENTER=2,soya2d.ALIGNMODE_RIGHT=3,soya2d.ROTATEMODE_0=1,soya2d.ROTATEMODE_90=2,soya2d.ROTATEMODE_180=3,soya2d.ROTATEMODE_270=4}(),soya2d.Font=function(t){var e=document.createElement("span");e.style.cssText="position:absolute;top:-9999px;left:-9999px;white-space:nowrap;font:"+(t||"normal 400 13px/normal sans-serif"),this.fontString=e.style.font,this.fontSize=parseInt(e.style.fontSize)||13,this.__renderText=function(t){if(t.font(this.font),this.__lines){t.fillStyle(this.fillStyle);for(var e=0,n=this.__lines.length;n>e;e++){var i=this.__lines[e];if(this.letterSpacing>0)for(var s=0,o=0,r=i.length;r>o;o++)t.fillText(i[o],s,(this.__lh+this.lineSpacing)*e),s+=this.letterSpacing+this.__uw;else t.fillText(i,0,(this.__lh+this.lineSpacing)*e)}}},this.clone=function(){return new soya2d.Font(this.getDesc())},this.getDesc=function(){return e.style.font},this.style=function(t){return arguments.length>0?(e.style.fontStyle=t,this.fontString=e.style.font,this):e.style.fontStyle},this.weight=function(t){return arguments.length>0?(e.style.fontWeight=t,this.fontString=e.style.font,this):e.style.fontWeight},this.size=function(t){return arguments.length>0?(e.style.fontSize=t+"px",this.fontString=e.style.font,this.fontSize=t,this):e.style.fontSize},this.family=function(t){return arguments.length>0?(t&&(e.style.fontFamily=t,this.fontString=e.style.font),this):e.style.fontFamily},this.getBounds=function(t,e){var n=e.ctx;n.font=this.getDesc();var i=n.measureText(t).width;return{w:i,h:this.fontSize}}},soya2d.ImageFont=function(t){this.__fontMap=t;var e=t.texs[Object.keys(t.texs)[0]].h;this.fontSize=e;var n=t.texs[Object.keys(t.texs)[0]].w,i=1;this.__renderText=function(t){if(this.__lines)for(var e=0,n=0,s=0,o=this.__lines.length;o>s;s++){for(var r=this.__lines[s],a=0,h=0,l=r.length;l>h;h++){var u=r[h],c=this.font.__fontMap.getTexture(u);if(c){var d=c.w*i,f=c.h*i;n=d,t.map(c,a,e,d,f,0,0,c.w,c.h)}a+=n+this.letterSpacing}e+=this.font.fontSize+this.lineSpacing}},this.clone=function(){return new soya2d.ImageFont(this.__fontMap)},this.size=function(t){return arguments.length>0?(this.fontSize=parseInt(t)||e,i=this.fontSize/e,this):this.fontSize},this.getBounds=function(t){var e=t.length;return{w:e*n*i,h:this.fontSize}}},soya2d.Text=function(t){t=t||{},soya2d.DisplayObjectContainer.call(this,t),soya2d.ext(this,t),this.text=t.text||"",this.letterSpacing=t.letterSpacing||0,this.lineSpacing=t.lineSpacing||0,this.font=t.font,"string"==typeof this.font&&(this.font=new soya2d.Font(this.font));var e=this.font||new soya2d.Font;this.font=e,this.__changed=!0,this.__lines,this.__renderer=this.font.__renderText},soya2d.inherits(soya2d.Text,soya2d.DisplayObjectContainer),soya2d.ext(soya2d.Text.prototype,{onRender:function(t){this.__renderer(t)},refresh:function(){this.__changed=!0},setFont:function(t){t&&(this.font=t,this.__renderer=this.font.__renderText)},setText:function(t){this.text=t+"",this.refresh()},_onUpdate:function(t){if(!this.__lh){var e=this.font.getBounds("s",t.getRenderer()),n=this.font.getBounds("豆",t.getRenderer());this.__lh=(e.h+n.h)/2>>0,this.__uw=(e.w+n.w)/2>>0}this.__changed&&(this.__lines=this.__calc(t.getRenderer()),this.__changed=!1)},__calc:function(t){var e=this.letterSpacing,n=this.w/(this.__uw+e)>>0;1>n&&(this.w=1.5*this.__uw,n=1);for(var i=this.font,s=this.text.split("\n"),o=[],r=0,a=s.length;a>r;r++){var h=s[r];if(h)for(var l=h.length,u=0;l>u;){var c=h.substr(u,n+1),d=i.getBounds(c,t).w+c.length*e;if(d>this.w){for(var f=n+1;f--;)if(c=c.substr(0,c.length-1),d=i.getBounds(c,t).w+c.length*e,d<=this.w){if(0===d)return;o.push(c),u+=c.length;break}}else{for(var y=u,f=1;l-u>f;f++){if(c=h.substr(u,n+1+f),d=i.getBounds(c,t).w+c.length*e,d>this.w){o.push(c.substr(0,c.length-1)),u+=c.length-1;break}if(c===h){n=h.length-1;break}}if(u===y){c=h.substr(u,n+1),o.push(c);break}}}else o.push("")}return o}}),soya2d.Texture=function(t,e,n){this.__data=t,this.w=parseInt(e)||t.width,this.h=parseInt(n)||t.height},soya2d.ext(soya2d.Texture,{fromImage:function(t){return new soya2d.Texture(t,t.width,t.height)},fromColor:function(t,e,n){var i=document.createElement("canvas");i.width=t,i.height=e;var s=i.getContext("2d");if(n instanceof Array){for(var o=soya2d.RGBColor.parse(n[0]||"#000000"),r=soya2d.RGBColor.parse(n[1]||"#000000"),a=soya2d.RGBColor.parse(n[2]||"#000000"),h=soya2d.RGBColor.parse(n[3]||"#000000"),l=new soya2d.HSLColor(o[0],o[1],o[2]),u=l.l,c=new soya2d.HSLColor(r[0],r[1],r[2]),d=c.l,f=new soya2d.HSLColor(a[0],a[1],a[2]),y=f.l,g=new soya2d.HSLColor(h[0],h[1],h[2]),_=g.l,p=s.createImageData(t,e),m=p.data,v=0,x=m.length;x>v;v+=4){var T=v/4%t,w=v/4/t>>0,E=(t-T)/t,A=(e-w)/e,b=E*A;l.lighteness(b*u);var S=l.getRGB();E=T/t,A=(e-w)/e,b=E*A,c.lighteness(b*d);var C=c.getRGB();E=(t-T)/t,A=w/e,b=E*A,f.lighteness(b*y);var R=f.getRGB();E=T/t,A=w/e,b=E*A,g.lighteness(b*_);var O=g.getRGB();m[v]=S[0]+C[0]+R[0]+O[0],m[v+1]=S[1]+C[1]+R[1]+O[1],m[v+2]=S[2]+C[2]+R[2]+O[2],m[v+3]=255}s.putImageData(p,0,0)}else s.fillStyle=n,s.fillRect(0,0,t,e);return new soya2d.Texture(i,t,e)}}),soya2d.Texture.prototype={dispose:function(){this.__data=null}},soya2d.TextureAtlas=function(t,e){this.texs={},e.forEach(function(e){var n=document.createElement("canvas");n.width=e.w,n.height=e.h;var i=n.getContext("2d");i.translate(e.w/2,e.h/2),i.rotate((e.r||0)*Math.PI/180);var s=e.w>>0,o=e.h>>0;return 0===s||0===o?(console.error("soya2d.TextureAtlas: invalid ssheet unit，w/h must be a positive;[w:"+s+",h:"+o+"] "),void 0):(i.drawImage(t.__data,e.x>>0,e.y>>0,s,o,-s/2>>0,-o/2>>0,s,o),this.texs[e.n]=new soya2d.Texture(n,s,o),void 0)},this)},soya2d.TextureAtlas.prototype={getTextures:function(t){var e=[];for(var n in this.texs)0===n.indexOf(t)&&e.push(this.texs[n]);return e},getTexture:function(t){return this.texs[t]},dispose:function(){for(var t in this.texs)this.texs[t].dispose();this.texs=null}},soya2d.TextureAtlasManager=function(){soya2d.ResourceManager.call(this),this._add=function(t,e){this.urlMap[t]=e}},soya2d.inherits(soya2d.TextureAtlasManager,soya2d.ResourceManager),soya2d.TextureManager=function(){soya2d.ResourceManager.call(this),this._add=function(t,e){this.urlMap[t]=e}},soya2d.inherits(soya2d.TextureManager,soya2d.ResourceManager),soya2d.AJAXLoader=new function(){function t(t){var e="";for(var n in t)e+="&"+n+"="+escape(t[n]);return e.substr(1)}function e(e,n,s,o,r,a,h,l,u,c){var d=new XMLHttpRequest;e=e||"get","get"===e&&(u="string"==typeof u?u:t(u),n.indexOf("?")>-1?(n=n.replace(/&$/,""),n+="&"+u.replace(/^&/,"")):n+="?"+u.replace(/^&/,""),u=null),d.open(e,n,s===!1?!1:!0),d.timeout=l||i,d.ontimeout=a,d.onerror=h,null===d.onload?(d.onload=function(){(0===d.status||d.status>=200&&d.status<300||304===d.status)&&o(d)},d.onprogress=function(t){r&&t.lengthComputable&&r(d,t.loaded,t.total)}):d.onreadystatechange=function(){(0===d.status||(d.status>=200&&d.status<300||304===d.status)&&4===d.readyState)&&o(d)},"post"===e&&(u="string"==typeof u?u:t(u),d.setRequestHeader("Content-Type",c||"application/x-www-form-urlencoded")),d.send(u)}function n(e,n,s,o,r,a,h,l,u,c){var d=new XMLHttpRequest;d.open("post",n,s===!1?!1:!0),d.timeout=l||i,d.ontimeout=a,d.upload&&(d.upload.addEventListener("progress",function(t){if(r&&t.lengthComputable){{t.loaded/t.total}r(d,t.loaded,t.total)}},!1),d.upload.addEventListener("error",h,!1)),null===d.onload?d.onload=function(){(0===d.status||d.status>=200&&d.status<300||304===d.status)&&o(d)}:d.onreadystatechange=function(){(0===d.status||(d.status>=200&&d.status<300||304===d.status)&&4===d.readyState)&&o(d)},d.setRequestHeader("Content-Type",c||"application/x-www-form-urlencoded"),u="string"==typeof u?u:t(u),d.send(u)}var i=5e3;this.loadText=function(t){t&&t.onLoad instanceof Function&&e(t.type,t.url,t.async,function(e){t.onLoad(e.responseText)},t.onProgress,t.onTimeout,t.onError,t.timeout,t.data)},this.loadJSON=function(t){t&&t.onLoad instanceof Function&&e(t.type,t.url,t.async,function(e){var n;try{n=new Function("return "+e.responseText)()}catch(i){n=i}t.onLoad(n)},t.onProgress,t.onTimeout,t.onError,t.timeout,t.data)},this.uploadText=function(t){t&&t.onLoad instanceof Function&&n(t.type,t.url,t.async,function(e){t.onLoad(e.responseText)},t.onProgress,t.onTimeout,t.onError,t.timeout,t.data+"")}},soya2d.Loader=new function(){function t(e,n,i,s,o){var r=document.createElement("script");r.onload=function(){return this.onerror=null,this.onload=null,document.body.removeChild(this),i&&i.call&&i(this.src),n--,n?(t(e,n,i,s,o),void 0):(o&&o.call&&o(),void 0)},r.onerror=function(){return this.onerror=null,this.onload=null,document.body.removeChild(this),s&&s.call&&s(this.src),n--,n?(t(e,n,i,s,o),void 0):(o&&o.call&&o(),void 0)},r.src=e.shift(),document.body.appendChild(r)}function e(t,e,i,s,o,r){for(var a=["serif","sans-serif"],h="border:none;position:absolute;top:-999px;left:-999px;font-size:100px;width:auto;height:auto;line-height:normal;margin:0;padding:0;font-variant:normal;white-space:nowrap;font-family:",l={},u={},c={},d=a.length;d--;){var f=document.createElement("div");f.style.cssText=h+"'"+a[d]+"'",f.innerHTML=e.family,document.body.appendChild(f),c[a[d]]=f,l[a[d]]=f.offsetWidth,u[a[d]]=f.offsetHeight}var y=document.createElement("style");y.id="FontLoader_"+(new Date).getTime(),y.innerHTML="@font-face {font-family: '"+e.family+"';src: url("+e.url+")}",document.head.appendChild(y);for(var d in c)c[d].style.fontFamily=e.family+","+c[d].style.fontFamily;var g=(new Date).getTime();setTimeout(function(){n(t,g,r,c,l,u,i,o,s,e.family)},100)}function n(t,e,s,o,r,a,h,l,u,c){setTimeout(function(){if((new Date).getTime()-e>s)return u&&u.call&&u(c),i--,!i&&l&&l.call&&l(),void 0;for(var d in o){o[d].style.left="-1000px";var f=o[d].offsetWidth,y=o[d].offsetHeight;if(f!==r[d]||y!==a[d]){var g;return h&&h.call&&(g=(new soya2d.Font).family(c),h(g,c)),t[i--]=g,!i&&l&&l.call&&l(t),void 0}}n(t,e,s,o,r,a,h,l,u,c)},20)}this.loadTextures=function(t){for(var e=t.urls.length,n=t.onLoad,i=t.onEnd,s=t.onError,o=(t.onTimeout,t.timeout||soya2d.TIMEOUT,t.crossOrigin),r=new Array(e),a=t.urls.length;a--;){var h=new Image;void 0!==o&&(h.crossOrigin=o),h.i=a,h.path=t.urls[a],h.onload=function(){var t=new soya2d.Texture.fromImage(this);r[this.i]=t,delete this.i,n&&n.call&&n(t,this.path),e--,!e&&i&&i.call&&i(r),this.onerror=null,this.onload=null},h.onerror=function(){s&&s.call&&s(this.src),e--,!e&&i&&i.call&&i(),this.onerror=null,this.onload=null},h.src=t.urls[a],h.complete&&h.onload()}return this},this.loadScripts=function(e){var n=e.urls.length,i=e.onLoad,s=e.onEnd,o=e.onError,r=document,a=document.body,h=e.mode||soya2d.LOADMODE_SEQU;if(h===soya2d.LOADMODE_SEQU)t(e.urls.concat(),n,i,o,s);else for(var l=e.urls.length;l--;){var u=r.createElement("script");u.async||(u.defer=!0),u.onload=function(){this.onerror=null,this.onload=null,document.body.removeChild(this),i&&i.call&&i(this.src),n--,!n&&s&&s.call&&s()},u.onerror=function(){this.onerror=null,this.onload=null,document.body.removeChild(this),o&&o.call&&o(this.src),n--,!n&&s&&s.call&&s()},u.src=e.urls[l],a.appendChild(u)}return this},this.loadSounds=function(t){for(var e=t.urls.length,n=t.onLoad,i=t.onEnd,s=t.onError,o=[],r=t.urls.length;r--;){var a=t.urls[r];new Howl({urls:a instanceof Array?a:[a],onload:function(){if(n&&n.call){var t=new soya2d.Sound;t.__handler=this,o.push(t),n(this._src,t)}e--,!e&&i&&i.call&&i(o)},onloaderror:function(t){if(s&&s.call){var n=soya2d.MEDIA_ERR_DECODE;t&&(n=t.type),s(this._src,n)}e--,!e&&i&&i.call&&i(o)}})}return this};var i=0;this.loadFonts=function(t){var n=t.urls.length,s=t.onLoad,o=t.onEnd,r=t.onTimeout,a=t.timeout||soya2d.TIMEOUT,h=new Array(n);i=n;for(var l=t.urls.length;l--;)e(h,t.urls[l],s,r,o,a)},this.loadTexAtlas=function(t){for(var e=t.urls.length,n=t.onLoad,i=t.onEnd,s=t.onError,o=[],r={},a=e;a--;)o.push(t.urls[a].image),r[t.urls[a].image]=t.urls[a].ssheet;var h=[];this.loadTextures({urls:o,onLoad:function(t,o){soya2d.AJAXLoader.loadJSON({url:r[o],onLoad:function(s){var a=new soya2d.TextureAtlas(t,s);n&&n(a,t,s,o,r[o]),h.push(a),0===--e&&i&&i(h)},onError:function(){e--,s&&s(o,r[o])}})},onError:function(t){e--,s&&s(t,r[t])}})}},soya2d.TIMEOUT=5e3,soya2d.MEDIA_ERR_UNCERTAIN=-1,soya2d.MEDIA_ERR_ABORTED=1,soya2d.MEDIA_ERR_NETWORK=2,soya2d.MEDIA_ERR_DECODE=3,soya2d.MEDIA_ERR_SRC_NOT_SUPPORTED=4,soya2d.MEDIA_ERR_SRC_NOT_FORTHCOMING=101,soya2d.LOADMODE_PARA=1,soya2d.LOADMODE_SEQU=2,soya2d.Game=function(t){function e(t,e,n,i,s){"use strict";for(var o={},r=n.length;r--;)o[n[r].image+"/"+n[r].ssheet]=n[r].id;e.loadTexAtlas({crossOrigin:t,urls:n,onLoad:function(t,e,n,s,r){c.textureManager._add(s,e);var a=o[s+"/"+r];c.texAtlasManager._add(a,t),i(t,e,n)},onError:function(t,e){i(t,e)},onEnd:function(){s()}})}function n(t,e,n,i,s){"use strict";e.loadScripts({crossOrigin:t,urls:n,onLoad:function(t){i(t)},onError:function(t){i(t)},onEnd:function(){s()}})}function i(t,e,n,i,s){"use strict";e.loadSounds({urls:n,onLoad:function(t,e){c.soundManager._add(t,e),i(t)},onError:function(t){i(t)},onEnd:function(t){s(t)}})}function s(t,e,n,i,s){"use strict";e.loadTextures({crossOrigin:t,urls:n,onLoad:function(t,e){c.textureManager._add(e,t),i()},onError:function(t){i(t)},onEnd:function(){s()}})}function o(t,e,n,i,s){"use strict";e.loadFonts({urls:n,timeout:1e3,onLoad:function(t,e){i(t,e)},onTimeout:function(t){i(t)},onEnd:function(){s()}})}function r(t){c.running&&(f=requestAFrame(function(e){0===y&&(y=e);var n=e-y;if(y=e,p>d){var i=Date.now();t&&t(i,n),p%=d}p+=n,r(t)}))}t=t||{};var a=t.container||document.body;"string"==typeof a&&(a=document.querySelector(a));var h=(t.rendererType||soya2d.RENDERER_TYPE_CANVAS,a.offsetWidth||100),l=a.offsetHeight||100,u=null;u=new soya2d.CanvasRenderer({smoothEnable:t.smoothEnable,autoClear:t.autoClear,container:a,sortEnable:!0,w:t.w||h,h:t.h||l}),soya2d.ext(this,t),this.scene=null,this.getRenderer=function(){return u},this.view=new soya2d.View(this),this.textureManager=new soya2d.TextureManager,this.texAtlasManager=new soya2d.TextureAtlasManager,this.loadRes=function(t){var r=t.textures||[],a=t.texAtlas||[],h=t.fonts||[],l=t.sounds||[],u=t.scripts||[],c=t.onLoad||function(){},d=t.onEnd||function(){},f=t.crossOrigin,y=soya2d.Loader,g=[];r.length>0&&g.push([s,r]),a.length>0&&g.push([e,a]),soya2d.Sound&&l.length>0&&g.push([i,l]),h.length>0&&g.push([o,h]),u.length>0&&g.push([n,u]);var _=g.length;_>0&&g[0][0](f,y,g[0][1],c,function(){_>1?g[1][0](f,y,g[1][1],c,function(){_>2?g[2][0](f,y,g[2][1],c,function(){_>3?g[3][0](f,y,g[3][1],c,function(){_>4?g[4][0](f,y,g[4][1],c,d):d()}):d()}):d()}):d()})};var c=this;this.w=u.w,this.h=u.h,this.running=!1,this.start=function(t){if(!this.running){this.running=!0,this.scene||this.cutTo(t),soya2d.console.log("game starting..."),t.children.length<1&&soya2d.console.warn("empty scene be showing..."),this.view.scan(this.w,this.h,a,u),this.view.align(this.view.align());var e=soya2d.module._getAll(),n=[],i=[],s=[],o=[],h=[];for(var l in e)e[l].onStart&&e[l].onStart(this),e[l].onBeforeUpdate&&n.push(e[l].onBeforeUpdate),e[l].onUpdate&&i.push(e[l].onUpdate),e[l].onAfterUpdate&&s.push(e[l].onAfterUpdate),e[l].onBeforeRender&&o.push(e[l].onBeforeRender),e[l].onAfterRender&&h.push(e[l].onAfterRender);return d=1e3/_,r(function(t,e){n.forEach(function(n){n(c,t,e)}),i.length>0&&(t=Date.now(),i.forEach(function(n){n(c,t,e)})),c.scene.__update(c),s.length>0&&(t=Date.now(),s.forEach(function(n){n(c,t,e)})),o.length>0&&(t=Date.now(),o.forEach(function(n){n(c,t,e)})),u.render(c.scene),h.length>0&&(t=Date.now(),h.forEach(function(n){n(c,t,e)}))}),this}};var d,f,y=0,g=60,_=60,p=0;this.setFPS=function(t){return _=parseInt(t)||g,_=_>g?g:_,d=1e3/_,this},this.stop=function(){cancelAFrame(f),this.running=!1;var t=soya2d.module._getAll();for(var e in t)t[e].onStop&&t[e].onStop(this);return this},this.cutTo=function(t){if(t){var e=!1;if(this.scene&&(e=!0,this.scene.clear()),this.scene=t,this.scene.game=this,this.scene.onInit&&this.scene.onInit.call&&this.scene.onInit(this),e){var n=soya2d.module._getAll();for(var i in n)n[i].onSceneChange&&n[i].onSceneChange(this,t)}return this}};var m=soya2d.module._getAll(),v=0;for(var x in m)m[x].onInit&&m[x].onInit(this),v++;var T="soya2d Game instance created...",w=v+" plugins loaded...";soya2d.console.log(T),soya2d.console.log(w)};var t1="soya2d is working...",t2="==== thank you for using soya2d, you'll love it! ====";soya2d.console.log(t1),soya2d.console.log(t2),soya2d.RENDERER_TYPE_AUTO=1,soya2d.RENDERER_TYPE_CANVAS=2,soya2d.RENDERER_TYPE_WEBGL=3,soya2d.LoaderScene=function(t){t=t||{},soya2d.Scene.call(this,t),soya2d.ext(this,t),this.nextScene=t.nextScene,this.nextScene instanceof soya2d.Scene||console.error("soya2d.LoaderScene: invalid param [nextScene], it must be a instance of soya2d.Scene"),this.textures=t.textures||[],this.texAtlas=t.texAtlas||[],this.sounds=t.sounds||[],this.scripts=t.scripts||[],this.fonts=t.fonts||[];var e=t.onStart,n=t.onProgress,i=t.onEnd;this.onInit=function(t){var s=0,o=this.textures.length+this.sounds.length+this.fonts.length;if(1>o)return soya2d.console.warn("empty resources be loaded..."),t.cutTo(this.nextScene),void 0;this.onStart&&this.onStart(t,o),e instanceof Function&&e.call(this,t,o);var r=this;t.loadRes({textures:this.textures,texAtlas:this.texAtlas,sounds:this.sounds,fonts:this.fonts,scripts:this.scripts,onLoad:function(){r.onProgress&&r.onProgress(t,o,++s),n instanceof Function&&n.call(r,t,o,s)},onEnd:function(){r.onEnd&&r.onEnd(t,o),i instanceof Function&&i.call(r,t,o),t.cutTo(r.nextScene)}})},this.onStart=function(t){var e=new soya2d.Shape({x:t.w/2-11,y:t.h/2-30-20}),n=new soya2d.Rect({w:23,h:20,skewY:-30,fillStyle:"#69CA14"}),i=new soya2d.Rect({w:23,h:20,skewY:30,y:13,opacity:.9,fillStyle:"#2A5909"}),s=new soya2d.Rect({w:23,h:20,skewY:-30,y:28,blendMode:soya2d.BLEND_LIGHTER,fillStyle:"#69CA14"});e.add(n,i,s),this.add(e);var o=new soya2d.Font("normal 400 23px/normal Arial,Helvetica,sans-serif");this.tip=new soya2d.Text({x:e.x-70,y:e.y+60+10,font:o,text:"Loading... 0/0",w:200,fillStyle:this.fillStyle||"#fff"}),this.add(this.tip)},this.onProgress=function(t,e,n){this.tip&&this.tip.setText("Loading... "+n+"/"+e)},this.onEnd=function(){}},soya2d.inherits(soya2d.LoaderScene,soya2d.Scene);