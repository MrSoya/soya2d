/*
 * Soya2D is a web interactive animation(game) engine for modern web browsers 
 *
 *
 * Copyright 2015-2017 MrSoya and other contributors
 * Released under the MIT license
 *
 * website: http://soya2d.com
 * last build: 2017-09-14
 */
!function(t){"use strict";function e(t,e,i){Object.defineProperties(this,{x:{set:function(t){this.__view.x=t,this.__checkBounds()},get:function(){return this.__view.x}},y:{set:function(t){this.__view.y=t,this.__checkBounds()},get:function(){return this.__view.y}},w:{get:function(){return this.__view.w}},h:{get:function(){return this.__view.h}}}),this.freezone=null,this.__view=new soya2d.Rectangle(0,0,t,e),this.__game=i}function i(t,e){if(t.__renderable){if(t.__fixedToCamera)return;if(!e.intersectWith(t.getBoundingBox()))return t.__renderable=!1,void 0;if(t.children)for(var s=t.children.length;s--;){var n=t.children[s];n.__renderable&&i(n,e)}}}function s(t,e,i){if(t.__renderable){var n=null,o=null;if(t.__fixedToCamera){var n=t.cameraOffset.x+t.anchorPosition.x,o=t.cameraOffset.y+t.anchorPosition.y;i=!0}else i?(n=t.parent.__screenPosition.x-t.parent.anchorPosition.x+t.x+t.anchorPosition.x,o=t.parent.__screenPosition.y-t.parent.anchorPosition.y+t.y+t.anchorPosition.y):(n=t.worldPosition.x,o=t.worldPosition.y,n-=e.x,o-=e.y);if(t.__screenPosition.set(n,o),t.children)for(var a=t.children.length;a--;){var r=t.children[a];r.__renderable&&s(r,e,i)}}}function n(){this.__assets={image:{},sound:{},imageFont:{},atlas:{},text:{},xml:{},json:{}}}function o(t,e,i,s,n){var o=new XMLHttpRequest;o.open("get",t,!0),o.timeout=e,o.ontimeout=i,o.onerror=s,null===o.onload?o.onload=function(){(0===o.status||o.status>=200&&o.status<300||304===o.status)&&n(o)}:o.onreadystatechange=function(){(0===o.status||(o.status>=200&&o.status<300||304===o.status)&&4===o.readyState)&&n(o)},o.send(null)}function a(t,e,i,s,n,o,r,h){setTimeout(function(){if((new Date).getTime()-t>e)return o(h),void 0;for(var c in i){i[c].style.left="-1000px";var l=i[c].offsetWidth,u=i[c].offsetHeight;if(l!==s[c]||u!==n[c])return r(h),void 0}a(t,e,i,s,n,o,r,h)},20)}function r(t,e){soya2d.ext(this,t),this.views={},this.game=e}function h(t,e,i,s){for(var n=0;n<e.childNodes.length;n++){var o=e.childNodes[n];if(3!=o.nodeType){for(var a=o.tagName,r=o.attributes.id?o.attributes.id.value:null,u={},d=o.attributes,f=0;f<d.length;f++){var _=d[f].name;u[_]=d[f].value}s.objects.map[a].prototype.onBuild&&s.objects.map[a].prototype.onBuild(u,o,s);var g=l(a,u,s);c(u,g,t),r&&(t.views[r]=g),i.add(g),o.childNodes.length>0&&h(t,o,g,s)}}}function c(t,e,i){for(var s=Object.keys(t),n=s.length;n--;){var o=s[n],a=t[o];if(0===o.indexOf("on-")){var r=i[a];if(r instanceof Function){var h=o.replace(/-([\w])/gim,function(t,e){return e.toUpperCase()});e.events[h]&&e.events[h](r)}else soya2d.console.warn('invalid callback "'+a+'" of '+o)}}}function l(t,e,i){var s=new i.objects.map[t](e);return s}function u(t){this.map={},this.game=t}function d(t){this.exp=t,this.times=0,this.priority=0,this.milliseconds=0,this._lastTriggerMilliseconds=-1e3,this._t=[],this._reset=function(){this.times=0,this.milliseconds=0,this._lastTriggerMilliseconds=-1e3,this._t=[],delete this._frameInfo,delete this._timeInfo},this._canUnload=function(){var t=this._timeInfo.hour;if(1===t[2]){if(this._t[2]>t[0])return!0}else if(t[2]>1&&this._t[2]>t[3][t[3].length-1])return!0},this.canTrigger=function(){return _(this)},/^(\*|(?:[0-9]+(?:,[0-9]+)*)|(?:[0-9]+-[0-9]+)|(?:(?:(?:[0-9]+(?:-[0-9]+)?)|\*)\/[0-9]+)) (\*|(?:[0-9]+(?:,[0-9]+)*)|(?:[0-9]+-[0-9]+)|(?:(?:(?:[0-9]+(?:-[0-9]+)?)|\*)\/[0-9]+)) (\*|(?:[0-9]+(?:,[0-9]+)*)|(?:[0-9]+-[0-9]+)|(?:(?:(?:[0-9]+(?:-[0-9]+)?)|\*)\/[0-9]+))$/.test(t)||soya2d.console.error("invalid timer expression -- "+t);var e=f(RegExp.$1),i=f(RegExp.$2),s=f(RegExp.$3);this._timeInfo={sec:e,min:i,hour:s}}function f(t){var e,i,s,n,o;if("*"==t)e=-1,i=0,s=-1;else if((i=parseInt(t))==t)s=1,e=0;else if(2===(o=t.split("/")).length){e=parseInt(o[1]);var a;if(2===(a=o[0].split("-")).length){n=[];for(var r=a[0]>>0,h=a[1]>>0;h>=r;r++)n.push(r);n.sort(function(t,e){return t-e}),s=n.length}else(i=parseInt(o[0]))||(i=0),s=-1}else if((o=t.split(",")).length>1){n=[];for(var e=o.length;e--;)n.push(o[e]>>0);n.sort(function(t,e){return t-e}),s=o.length}else if(2===(o=t.split("-")).length){n=[];for(var r=o[0]>>0,h=o[1]>>0;h>=r;r++)n.push(r);n.sort(function(t,e){return t-e}),s=n.length}return[e,i,s,n]}function _(t){var e=t.milliseconds/1e3,i=t._t[0]=e%60>>0,s=t._t[1]=e/60%60>>0,n=t._t[2]=e/60/60>>0;return g(t._timeInfo.hour,n)?g(t._timeInfo.min,s)?g(t._timeInfo.sec,i)?!0:!1:!1:!1}function g(t,e){if(1===t[2]){if(t[1]!==e)return!1}else if(-1===t[2]&&-1===t[0]);else if(t[3]&&!t[0]){if(t[3].indexOf(e)<0)return!1}else if(-1===t[2]&&t[0]>0||t[0]>0&&t[3]){if(t[3]&&t[3].indexOf(e)<0)return!1;var i=e-t[1];if(0>=i&&0!=t[1])return!1;if(i%t[0])return!1}return!0}function p(t){this.sprite=t,this.rigid=null}function m(t){this.map={},this.game=t}function y(t){this.game=t,this.__newInstanceAndAppend=function(t,e){e.game=this.game;var i=new this.game.objects.map[t](e);return this.game.world.add(i),i}}function v(t,e){if(/^(-?\d+)%$/.test(t)){var i=parseFloat(RegExp.$1)/100;return b(e,i)}return t}function w(t,e){if(/^(-?\d+)%$/.test(t)){var i=parseFloat(RegExp.$1)/100;return T(e,i)}return t}function x(t,e){if(!isNaN(t))return parseFloat(t);var i=e,s=0;return/^(-?\d+)%$/.test(t)&&(s=parseFloat(RegExp.$1)/100),i*s}function b(t,e){var i=t.w;return 0===i&&t.parent?b(t.parent,e):i*e}function T(t,e){var i=t.h;return 0===i&&t.parent?T(t.parent,e):i*e}function E(t,e,i){for(var s=t.children.length;s--;){var n=t.children[s];e(n)&&i.push(n),n.children&&n.children.length>0&&E(n,e,i)}}function A(t){if(t.transform(),t.__renderable=!0,t.children)for(var e=t.children.length;e--;){var i=t.children[e];i.visible&&A(i)}}function O(t,e,i){for(var s=t.length;s--;){var n=t[s];n._onUpdate&&n._onUpdate(e,i),n.onUpdate&&n.onUpdate(e,i),n.children&&n.children.length>0&&O(n.children,e,i)}}function S(t,e,i){for(var s=t.length;s--;){var n=t[s];n._onPostUpdate&&n._onPostUpdate(e,i),n.onPostUpdate&&n.onPostUpdate(e,i),n.children&&n.children.length>0&&S(n.children,e,i)}}function M(t,e,i,s,n){var o;switch(e){case soya2d.ROTATEMODE_90:o="rotate(90deg)";break;case soya2d.ROTATEMODE_180:o="rotate(180deg)";break;case soya2d.ROTATEMODE_270:o="rotate(270deg)";break;case soya2d.ROTATEMODE_0:default:o="rotate(0deg)",n.__rotat=soya2d.ROTATEMODE_0}if(i.style.transform=i.style.webkitTransform=i.style.mozTransform=i.style.msTransform=i.style.oTransform=o,i.style.left=i.style.top=0,e===soya2d.ROTATEMODE_90||e===soya2d.ROTATEMODE_270){var a=i.offsetWidth,r=i.offsetHeight;if(t===soya2d.SCALEMODE_NOBORDER){var h=this.game.w,c=this.game.h;a=a>c?c:a,r=r>h?h:r}if(s.resize(r,a),t===soya2d.SCALEMODE_EXACTFIT){var l=(a-r)/2;l=r%2===0?l:Math.floor(l);var u=(r-a)/2;u=a%2===0?u:Math.floor(u),i.style.left=l+"px",i.style.top=u+"px"}}}function k(){var t,e=window.innerWidth,i=window.innerHeight;return t=e>i?"landscape":"portrait"}function R(t,e,i,s,n,o,a,r){i=a&&i>a?a:i,s=r&&s>r?r:s;var h=Math.max(i/t,s/e),c=t*h,l=e*h;return[c,l]}function C(t,e,i,s,n,o,a,r){i=a&&i>a?a:i,s=r&&s>r?r:s;var h=1;(t>i||e>s)&&(h=Math.min(i/t,s/e));var c=t*h,l=e*h;return[c,l]}function L(t,e,i,s,n,o,a,r){var h,c;return h=n&&n>i?n:a&&i>a?a:i,c=o&&o>s?o:r&&s>r?r:s,[h,c]}function I(t,e,i){this.frames=t,this.index=0,this.lastUpdateTime=0,this.frameRate=e||10,this.loop=i===!1?!1:i||!0}function D(t){this.obj=t,this.disabled=!1,this.clear=function(){this.obj.game.__pointerSignal.off(null,null,this.obj),H.off(null,null,this.obj)},this.onPointerDown=function(t){this.obj.game.__pointerSignal.on("pointerdown",t,this.obj)},this.onPointerTap=function(t){this.obj.game.__pointerSignal.on("pointertap",t,this.obj)},this.onPointerDblTap=function(t){this.obj.game.__pointerSignal.on("pointerdbltap",t,this.obj)},this.onPointerUp=function(t){this.obj.game.__pointerSignal.on("pointerup",t,this.obj)},this.onPointerMove=function(t){this.obj.game.__pointerSignal.on("pointermove",t,this.obj)},this.onPointerOver=function(t){this.obj.game.__pointerSignal.on("pointerover",t,this.obj)},this.onPointerOut=function(t){this.obj.game.__pointerSignal.on("pointerout",t,this.obj)},this.onPointerCancel=function(t){this.obj.game.__pointerSignal.on("pointercancel",t,this.obj)},this.onEnterStage=function(t){this.obj.game.__pointerSignal.on("enterstage",t,this.obj)},this.onLeaveStage=function(t){this.obj.game.__pointerSignal.on("leavestage",t,this.obj)},this.onCollisionStart=function(t){this.obj.game.__pointerSignal.on("collisionstart",t,this.obj)},this.onCollisionEnd=function(t){this.obj.game.__pointerSignal.on("collisionend",t,this.obj)},this.onKeyDown=function(t){H.on("keydown",t,this.obj)},this.onKeyPress=function(t){H.on("keypress",t,this.obj)},this.onKeyUp=function(t){H.on("keyup",t,this.obj)},this.onDeviceHov=function(t){H.on("hov",t,this.obj)},this.onDeviceTilt=function(t){H.on("tilt",t,this.obj)},this.onDeviceMotion=function(t){H.on("motion",t,this.obj)}}function P(t){this.eventMap={},soya2d.ext(this,t)}t.soya2d=new function(){function t(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,t.prototype._super=e.prototype}this.__roIndex=0,this.version={v:[2,1,0],state:"alpha",toString:function(){return soya2d.version.v.join(".")+" "+soya2d.version.state}},this.website="http://soya2d.com",this.ext=function(t,e,i){for(var s=Object.keys(e),n=s.length;n--;){var o=s[n];(!t.hasOwnProperty(o)||i)&&(t[o]=e[o])}},this.class=function(e,i){var s=i.constructor,n=i.extends,o=function(){n&&n.apply(this,arguments),s&&s.apply(this,arguments)};n&&t(o,n);for(var a in i)"extends"!==a&&"constructor"!==a&&(o.prototype[a]=i[a]);if(e){var r=e.split("."),h=r[r.length-1],c=self;if(r.length>1)for(var l=0;l<r.length;l++)r[l]!==h&&(c=c[r[l]],c||(c={}));c[h]=o,o.prototype.class=e}return o},this.module=new function(){var t={};this.install=function(e,i){t[e]=i},this._getAll=function(){return t}},this.render=function(t,e,i,s){var n=new soya2d.Game({w:e,h:i,container:t});return n.start(),n.scene.start(s),n}},t.soya=soya2d,self.Int8Array=self.Int8Array||Array,self.Uint8Array=self.Uint8Array||Array,self.Int16Array=self.Int16Array||Array,self.Uint16Array=self.Uint16Array||Array,self.Int32Array=self.Int32Array||Array,self.Uint32Array=self.Uint32Array||Array,self.Float32Array=self.Float32Array||Array,self.console=self.console||new function(){this.log=function(){},this.info=function(){},this.debug=function(){},this.error=function(){},this.warn=function(){}},soya2d.console=new function(){var t=1;this.level=function(e){t=0==e?0:e||1},this.debug=function(e,i){1==t&&(soya2d.Device.ie?console.debug(e):console.debug("%c"+e,i||"padding:1px 50px;font-size:14px;color:#fff;background:#0069D6;"))},this.info=function(e,i){1>t||t>2||(soya2d.Device.ie?console.log(e):console.log("%c"+e,i||"padding:1px 50px;font-size:14px;color:#fff;background:#2DB008;"))},this.warn=function(e,i){1>t||t>3||(soya2d.Device.ie?console.warn(e):console.warn("%c"+e,i||"padding:1px 50px;font-size:14px;color:#fff;background:#FFB502;"))},this.error=function(e,i){1>t||(soya2d.Device.ie?console.error(e):console.error("%c"+e,i||"padding:1px 50px;font-size:14px;color:#fff;background:#ff0000;"))}},self.cancelAFrame=function(t){return t.cancelAnimationFrame||t.webkitCancelRequestAnimationFrame||t.msCancelRequestAnimationFrame||t.mozCancelRequestAnimationFrame||t.oCancelRequestAnimationFrame||t.clearTimeout}(self),self.requestAFrame=function(t){return t.requestAnimationFrame||t.webkitRequestAnimationFrame||t.msRequestAnimationFrame||t.mozRequestAnimationFrame||t.oRequestAnimationFrame||function(e){return t.setTimeout(function(){e(Date.now())},16.7)}}(self),soya2d.BLEND_NORMAL="source-over",soya2d.BLEND_LIGHTER="lighter",soya2d.BLEND_MASK="destination-in",soya2d.BLEND_CLEAR="destination-out",soya2d.LINECAP_BUTT="butt",soya2d.LINECAP_ROUND="round",soya2d.LINECAP_SQUARE="square",soya2d.LINEJOIN_BEVEL="bevel",soya2d.LINEJOIN_ROUND="round",soya2d.LINEJOIN_MITER="miter",soya2d.TEXTALIGN_LEFT="left",soya2d.TEXTALIGN_CENTER="center",soya2d.TEXTALIGN_RIGHT="right",soya2d.TEXTVALIGN_TOP="hanging",soya2d.TEXTVALIGN_MIDDLE="middle",soya2d.TEXTVALIGN_BOTTOM="alphabetic",soya2d.TEXTDIR_LTR="ltr",soya2d.TEXTDIR_RTL="rtl",soya2d.GRADIENT_LINEAR=1,soya2d.GRADIENT_RADIAL=2,e.prototype={follow:function(t){var e=this.__game.world.find(function(e){return t.roid===e.roid?!0:void 0},!0);e.length<0&&soya2d.console.error("camera: "+t.toString()+" must be a child node of game.world"),this.target=t},unfollow:function(){this.target=null},moveTo:function(t,e){this.target||(this.__view.x=t,this.__view.y=e,this.__checkBounds())},moveBy:function(t,e){this.target||(this.__view.x+=t,this.__view.y+=e,this.__checkBounds())},reset:function(){this.__view.x=this.__view.y=0},__checkBounds:function(){var t=this.__game.world.bounds,e=t.x,i=t.y,s=t.w,n=t.h,o=this.__view.x;e>o&&(this.__view.x=e),s>0&&o+this.__view.w>s&&(this.__view.x=s-this.__view.w);var a=this.__view.y;i>a&&(this.__view.y=i),n>0&&a+this.__view.h>n&&(this.__view.y=n-this.__view.h)},setFreezone:function(t){t&&(this.freezone=t)},__onUpdate:function(){if(this.target&&this.target.game){var t,e,i=this.target.worldPosition;t=i.x,e=i.y;{var s=this.target.w,n=this.target.h;t-this.__view.x,e-this.__view.y}if(this.freezone){var o=this.freezone.x,a=this.freezone.y,r=this.freezone.w,h=this.freezone.h,c=this.__view.x+o,l=this.__view.y+a,u=this.__view.x+o+r,d=this.__view.y+a+h,f=s/2,_=n/2;c>t-f?this.__view.x=t-o-f:t+f>u&&(this.__view.x=t-r-o+f),l>e-_?this.__view.y=e-a-_:e+_>d&&(this.__view.y=e-h-a+_)}else this.__view.x=t-this.__view.w/2,this.__view.y=e-this.__view.h/2;this.__checkBounds()}},__cull:function(t){for(var e=t.children,s=e.length;s--;)i(e[s],this.__view)},__viewport:function(t){for(var e=t.children,i=e.length;i--;)s(e[i],this.__view)}},soya2d.Math={PI:3.141592654,PIM2:6.283185307,PID2:1.570796327,PID4:.785398163,ONERAD:.017453292,ONEANG:57.295779513,toRadian:function(t){return t*this.ONERAD},toAngle:function(t){return t*this.ONEANG},randomf:function(t,e){return t+Math.random()*(e-t)},randomi:function(t,e){return t+Math.random()*(e-t)>>0},round:function(t){return.5+t>>0},floor:function(t){return 0|t},len2D:function(t,e,i,s){return Math.sqrt((s-e)*(s-e)+(i-t)*(i-t))},len2Df:function(t,e){t=Math.abs(t),e=Math.abs(e);var i=Math.min(t,e);return t+e-(i>>1)-(i>>2)+(i>>4)},SINTABLE:function(){for(var t=new Float32Array(361),e=.017453292,i=0;360>=i;i++){var s=i*e,n=Math.sin(s);t[i]=n}return t}(),COSTABLE:function(){for(var t=new Float32Array(361),e=.017453292,i=0;360>=i;i++){var s=i*e,n=Math.cos(s);t[i]=n}return t}()},n.prototype={image:function(t){return this.__assets.image[t]},sound:function(t){return this.__assets.sound[t]},imageFont:function(t){return this.__assets.imageFont[t]},atlas:function(t){return this.__assets.atlas[t]},text:function(t){return this.__assets.text[t]},xml:function(t){return this.__assets.xml[t]},json:function(t){return this.__assets.json[t]}},soya2d.Atlas=function(t,e){this.texs={},e.forEach(function(e){var i=document.createElement("canvas");i.width=e.w,i.height=e.h;var s=i.getContext("2d");s.translate(e.w/2,e.h/2),s.rotate((e.r||0)*Math.PI/180);var n=e.w>>0,o=e.h>>0;return 0===n||0===o?(soya2d.console.error("soya2d.Atlas: invalid ssheet unit，w/h must be a positive;[w:"+n+",h:"+o+"] "),void 0):(s.drawImage(t,e.x>>0,e.y>>0,n,o,-n/2>>0,-o/2>>0,n,o),this.texs[e.n]=i,void 0)},this)},soya2d.Atlas.prototype={getAll:function(t){var e=[];for(var i in this.texs)(!t||"*"===t||t&&0===i.indexOf(t))&&e.push(this.texs[i]);return e},getByIndex:function(t,e){for(var i=[],s=Object.keys(this.texs),n=t;e>=n;n++){var o=this.texs[s[n]];i.push(o)}return i},get:function(t){return this.texs[t]},destroy:function(){this.texs=null}};var N=soya2d.Signal=function(){this.__sigmap={}};soya2d.Signal.prototype={on:function(t,e,i){for(var s=t.replace(/\s+/gm," ").split(" "),n=s.length;n--;){var o=this.__sigmap[s[n]];o||(o=this.__sigmap[s[n]]=[]),o.push([e,i||this])}return this},once:function(t,e,i){for(var s=t.replace(/\s+/gm," ").split(" "),n=s.length;n--;){var o=this.__sigmap[s[n]];o||(o=this.__sigmap[s[n]]=[]),o.push([e,i||this,!0])}return this},off:function(t,e,i){var s=null;s=t?t.replace(/\s+/gm," ").split(" "):Object.keys(this.__sigmap);for(var n=s.length;n--;){var o=this.__sigmap[s[n]];if(o){for(var a=[],r=o.length;r--;)(i||this)!==o[r][1]||(e?o[r][0]!==e:0)||a.push(o[r]);a.forEach(function(t){var e=o.indexOf(t);o.splice(e,1)})}}return this},emit:function(){var t=this.__sigmap[arguments[0]];if(t){for(var e=[],i=1;i<arguments.length;i++)e.push(arguments[i]);t.filter(function(t){t[1].events?t[1].events.disabled||t[0].apply(t[1],e):t[0].apply(t[1],e)});var s=t.filter(function(t){return t[2]?void 0:!0});return this.__sigmap[arguments[0]]=s,this}},emitTo:function(){var t=this.__sigmap[arguments[0]];if(t){for(var e=arguments[1],i=[],s=2;s<arguments.length;s++)i.push(arguments[s]);t.filter(function(t){t[1]===e&&(t[1].events?t[1].events.disabled||(t[0].apply(t[1],i),t.__called=!0):(t[0].apply(t[1],i),t.__called=!0))});var n=t.filter(function(t){return t.__called?t[2]?void 0:!0:!0});return this.__sigmap[arguments[0]]=n,this}},__emitPointer:function(t,e,i,s,n){var o=this.__sigmap[arguments[0]];if(o){o.filter(function(t){var o=t[1],a=t[0];if(o.hitTest(s)&&!o.events.disabled&&o.isRendered())a.call(o,e,i),t.__called=!0;else for(var r=n.length;r--;)if(o.hitTest(n[r])&&!o.events.disabled&&o.isRendered()){a.call(o,e,i),t.__called=!0;break}});var a=o.filter(function(t){return t.__called?t[2]?void 0:!0:!0});this.__sigmap[arguments[0]]=a}}};var B=soya2d.class("",{"extends":N,timeout:5e3,constructor:function(t){this.__assetsQueue=[],this.game=t,this.__assets=t.assets.__assets,this.baseUrl="";var e=!0;Object.defineProperties(this,{show:{set:function(t){e=t},get:function(){return e}},fillStyle:{set:function(t){this.__tip.fillStyle=t},get:function(){return this.__tip.fillStyle}}}),this.__logo=new soya2d.Shape({game:t,opacity:0,x:t.w/2-11,y:t.h/2-30-20,z:9999});var i=new soya2d.Shape({w:23,h:20,skewY:-30,game:t,fillStyle:"#69CA14",onRender:function(t){t.beginPath(),t.fillStyle(this.fillStyle),t.rect(0,0,this.w,this.h),t.fill(),t.closePath()}}),s=new soya2d.Shape({game:t,w:23,h:20,skewY:30,y:13,opacity:.9,fillStyle:"#2A5909",onRender:function(t){t.beginPath(),t.fillStyle(this.fillStyle),t.rect(0,0,this.w,this.h),t.fill(),t.closePath()}}),n=new soya2d.Shape({game:t,w:23,h:20,skewY:-30,y:28,blendMode:soya2d.BLEND_LIGHTER,fillStyle:"#69CA14",onRender:function(t){t.beginPath(),t.fillStyle(this.fillStyle),t.rect(0,0,this.w,this.h),t.fill(),t.closePath()}}),o=new soya2d.Font("normal 400 23px/normal Arial,Helvetica,sans-serif");this.__tip=new soya2d.Text({game:t,x:-70,y:70,font:o,text:"Loading... 0/0",w:200,fillStyle:"#000"}),this.__logo.add(i,s,n,this.__tip),t.world.add(this.__logo)},__addToAssets:function(t,e){for(var i in e)this.__assetsQueue.push({type:t,k:i,data:e[i],baseUrl:this.baseUrl})},image:function(t){var e=t;t instanceof Array&&(e={},t.forEach(function(t){var i=t.lastIndexOf("/")+1,s=t.lastIndexOf("."),n=t.substring(i,s);e[n]=t})),this.__addToAssets("image",e)},sound:function(t){this.__addToAssets("sound",t)},font:function(t){this.__addToAssets("font",t)},imageFont:function(t){this.__addToAssets("imageFont",t)},atlas:function(t){var e=t;if(4===arguments.length){e={};var i=arguments[0],s=arguments[1],n=arguments[2],o=arguments[3];e[i]=[s,n,o]}this.__addToAssets("atlas",e)},text:function(t){this.__addToAssets("text",t)},xml:function(t){this.__addToAssets("xml",t)},json:function(t){this.__addToAssets("json",t)},__loadImage:function(t,e,i){var s=new Image;void 0!==this.crossOrigin&&(s.crossOrigin=this.crossOrigin),s.path=e;s.onload=function(){i("load",this),this.onerror=null,this.onload=null},s.onerror=function(){i("error",this.path),this.onerror=null,this.onload=null},s.src=t+e,s.complete&&(i("load",s),s.onerror=null,s.onload=null)},__loadSound:function(t,e,i){for(var s=e instanceof Array?e:[e],n=s.length;n--;)s[n]=t+s[n];new Howl({src:s,onload:function(){var t=new soya2d.Sound;t.__handler=this,i("load",t)},onloaderror:function(t){var e=soya2d.MEDIA_ERR_DECODE;t&&(e=t.type),i("error",this._src,e)}})},__loadFont:function(t,e,i,s){for(var n=["serif","sans-serif"],o="border:none;position:absolute;top:-999px;left:-999px;font-size:100px;width:auto;height:auto;line-height:normal;margin:0;padding:0;font-variant:normal;white-space:nowrap;font-family:",r={},h={},c={},l=n.length;l--;){var u=document.createElement("div");u.style.cssText=o+"'"+n[l]+"'",u.innerHTML=e,document.body.appendChild(u),c[n[l]]=u,r[n[l]]=u.offsetWidth,h[n[l]]=u.offsetHeight}var d=document.createElement("style");d.id="FontLoader_"+(new Date).getTime(),d.innerHTML="@font-face {font-family: '"+e+"';src: url("+t+i+")}",document.head.appendChild(d);for(var l in c)c[l].style.fontFamily=e+","+c[l].style.fontFamily;var f=(new Date).getTime(),_=this;setTimeout(function(){a(f,_.timeout,c,r,h,function(t){s("timeout",t)},function(t){s("load",t)},e)},100)},__loadAtlas:function(t,e,i,s){var n=this;this.__loadImage(t,i[0],function(o,a){if("load"===o)if("string"==typeof i[1]&&2===i.length)n.__getXhr(t,i[1],function(t,e){var i=e;if("load"===t){var n;try{n=new Function("return "+e.responseText)()}catch(o){n=o}i=new soya2d.Atlas(a,n)}s(t,i)});else{var r=i[1];if(i.length>2){r=[];for(var h=a.width,c=a.height,l=i[1],u=i[2],d=1,f=u;c>=f;f+=u)for(var _=l;h>=_;_+=l)r.push({n:e+"_"+d,x:_-l,y:f-u,w:l,h:u}),d++}var g=new soya2d.Atlas(a,r);s(o,g)}else s(o,a)})},__getXhr:function(t,e,i){o(t+e,this.timeout,function(){i("timeout",e)},function(){i("error",e)},function(t){i("load",t)})},__loadAssets:function(){var t=this;return this.__assetsQueue.length<1?(this.emit("end"),void 0):(this.__assetsQueue.forEach(function(e){switch(e.type){case"image":t.__loadImage(e.baseUrl,e.data,function(i,s){"load"===i&&(t.__assets.image[e.k]=s),t.__onLoad(i,s)});break;case"sound":if(!soya2d.Sound)return soya2d.console.warn("can't load sounds, module [sound] needs to be loaded"),void 0;t.__loadSound(e.baseUrl,e.data,function(i,s){"load"===i&&(t.__assets.sound[e.k]=s),t.__onLoad(i,s,arguments[2])});break;case"atlas":t.__loadAtlas(e.baseUrl,e.k,e.data,function(i,s){"load"===i&&(t.__assets.atlas[e.k]=s),t.__onLoad(i,s)});break;case"font":t.__loadFont(e.baseUrl,e.k,e.data,function(i,s){var n=s;"load"===i&&(n=(new soya2d.Font).family(s),t.__assets.imageFont[e.k]=n),t.__onLoad(i,n)});break;case"imageFont":t.__loadAtlas(e.baseUrl,e.k,e.data,function(i,s){var n=s;"load"===i&&(n=new soya2d.ImageFont(s),t.__assets.imageFont[e.k]=n),t.__onLoad(i,n)});break;case"text":t.__getXhr(e.baseUrl,e.data,function(i,s){var n=s;"load"===i&&(t.__assets.text[e.k]=s.responseText,n=s.responseText),t.__onLoad(i,n)});break;case"xml":t.__getXhr(e.baseUrl,e.data,function(i,s){var n=s;"load"===i&&(n=t.__assets.xml[e.k]=s.responseXML),t.__onLoad(i,n)});break;case"json":t.__getXhr(e.baseUrl,e.data,function(i,s){var n=s;if("load"===i){try{n=new Function("return "+s.responseText)()}catch(o){n=o}t.__assets.json[e.k]=n}t.__onLoad(i,n)})}}),void 0)},__onLoad:function(t,e){this.__tip.setText("Loading... "+ ++this.__index+"/"+this.__assetsQueue.length),"load"===t?this.emit(t,e,this.__index,this.__assetsQueue.length):this.emit(t,e,arguments[2]),this.__index==this.__assetsQueue.length&&(this.__assetsQueue=[],this.emit("end"),this.__logo.parent.remove(this.__logo),this.__logo.opacity=0)},start:function(){this.__index=0,this.show&&(this.__logo.parent||this.game.world.add(this.__logo),this.__logo.opacity=1),this.__loadAssets()}});soya2d.MEDIA_ERR_UNCERTAIN=-1,soya2d.MEDIA_ERR_ABORTED=1,soya2d.MEDIA_ERR_NETWORK=2,soya2d.MEDIA_ERR_DECODE=3,soya2d.MEDIA_ERR_SRC_NOT_SUPPORTED=4,soya2d.MEDIA_ERR_SRC_NOT_FORTHCOMING=101,r.prototype={setView:function(t){var e=t.childNodes[0];h(this,e,this.game.world,this.game)},findView:function(t){return this.views[t]}},u.prototype={start:function(t,e){var i=this.game;t="string"==typeof t?this.map[t]:new r(t,i),i.currentScene=t,e&&(i.world.clear(!0),i.world.events.clear(),i.camera.reset()),t.onPreload?(t.onPreload(i),i.load.once("end",function(){i.currentScene.onInit&&setTimeout(function(){i.currentScene.onInit(i)},0)}),i.load.start()):t.onInit&&t.onInit(i);var s=soya2d.module._getAll();for(var n in s)s[n].onSceneChange&&s[n].onSceneChange(i,t);return this},add:function(t,e){return this.map[t]=new r(e,game),this.map[t]}};var F=soya2d.class("",{"extends":N,constructor:function(){this.triggerList=[],this.expMap={},this.threshold=1e3},on:function(t,e,i){var s=this;return t=t.replace(/\[(.*?)\]/gm,function(t,e){if(!s.expMap[e]){var i=new d(e);s.triggerList.push(i),s.expMap[e]=i}return e.replace(/\s+/gm,"_")}),this._super.on.call(this,t,e,i)},once:function(t,e,i){var s=this;return t=t.replace(/\[(.*?)\]/gm,function(t,e){if(!s.expMap[e]){var i=new d(e);s.triggerList.push(i),s.expMap[e]=i}return e.replace(/\s+/gm,"_")}),this._super.once.call(this,t,e,i)},off:function(t,e){var i=[];t=t.replace(/\[(.*?)\]/gm,function(t,e){return i.push(e),e.replace(/\s+/gm,"_")}),this._super.off.call(this,t,e),i.forEach(function(t){var e=this.__sigmap[t.replace(/\s+/gm,"_")];Object.keys(e).length<1&&(this.expMap[t]=null,this.__removeTrigger(t))},this)},__scan:function(t){for(var e=[],i=[],s=this.triggerList.length;s--;){var n=this.triggerList[s],o=this.__sigmap[n.exp.replace(/\s+/gm,"_")],a=!1;n.milliseconds+=t;var r=n.milliseconds-n._lastTriggerMilliseconds;n.canTrigger()&&r>=this.threshold&&(a=!0,n._lastTriggerMilliseconds=n.milliseconds),n._canUnload()&&e.push(n.exp),a&&(n.times++,o.forEach(function(t){t[3]&&i.push([n.exp,t[0]]),t[0].call(this,n.milliseconds,n.times,n._t)},this))}for(var s=e.length;s--;)this.__removeTrigger(e[s]);for(var s=i.length;s--;)this.off(i[s][0],i[s][1])},__removeTrigger:function(t){for(var e=this.triggerList.length;e--;){var i=this.triggerList[e];if(i.exp===t)break}this.triggerList.splice(e,1)}});soya2d.Circle=function(t,e,i){this.x=t||0,this.y=e||0,this.r=i||0},soya2d.Circle.prototype={toString:function(){return"{x:"+this.x+",y:"+this.y+",r:"+this.r+"}"},clone:function(){return new soya2d.Circle(this.x,this.y,this.r)},intersectWith:function(t){if(t instanceof soya2d.Circle&&t.r>0){if(soya2d.Math.len2Df(t.x-this.x,t.y-this.y)<=this.r+t.r)return!1}else if(t instanceof soya2d.Rectangle&&t.w>0&&t.h>0){var e=t.w/2,i=t.h/2,s=this.x-(t.x+e),n=this.y-(t.y+i);if(s>e+this.r||n>i+this.r)return!1;var o=Math.min(s,e),a=Math.max(o,-e),r=Math.min(n,i),h=Math.max(r,-i);return(a-s)*(a-s)+(h-n)*(h-n)<=this.r*this.r}return!0}},soya2d.Polygon=function(t){this.vtx=t},soya2d.Polygon.prototype={toString:function(){return this.vtx},clone:function(){return new soya2d.Polygon(this.vtx.concat())}},soya2d.Rectangle=function(t,e,i,s){this.x=t||0,this.y=e||0,this.w=i||0,this.h=s||0},soya2d.Rectangle.prototype={toString:function(){return"{x:"+this.x+",y:"+this.y+",w:"+this.w+",h:"+this.h+"}"},clone:function(){return new soya2d.Rectangle(this.x,this.y,this.w,this.h)},getRight:function(){return this.x+this.w},getBottom:function(){return this.y+this.h},contains:function(t,e){return t<this.x||t>this.x+this.w?!1:e<this.y||e>this.y+this.h?!1:!0},intersectWith:function(t){if(t instanceof soya2d.Rectangle&&t.w>0&&t.h>0){if(this.x>t.x+t.w||this.y>t.y+t.h)return!1;if(this.x+this.w<t.x||this.y+this.h<t.y)return!1}else if(t instanceof soya2d.Circle&&t.r>0)return t.intersectWith(this);return!0}},soya2d.Point=function(t,e){this.x=t||0,this.y=e||0},soya2d.Point.prototype={toString:function(){return"{x:"+this.x+",y:"+this.y+"}"},clone:function(){return new soya2d.Point(this.x,this.y)},set:function(t,e){return this.x=t,this.y=e,this}},soya2d.Matrix2x2=function(){this.e=new Float32Array(4),this.identity()},soya2d.Matrix2x2.prototype={toString:function(){return"["+this.e[0]+","+this.e[1]+","+this.e[2]+","+this.e[3]+"]"},set:function(t,e,i,s){var n=this.e;return n[0]=0==t?0:t||1,n[1]=e||0,n[2]=i||0,n[3]=0==s?0:s||1,this},clone:function(){return(new soya2d.Matrix2x2).set(this.e[0],this.e[1],this.e[2],this.e[3])},identity:function(){return this.set(1,0,0,1),this},mul:function(t){var e=this.e[0],i=this.e[1],s=this.e[2],n=this.e[3],o=t.e;return this.e[0]=o[0]*e+o[2]*i,this.e[1]=o[1]*e+o[3]*i,this.e[2]=o[0]*s+o[2]*n,this.e[3]=o[1]*s+o[3]*n,this},scale:function(t,e){return this.e[0]*=t,this.e[1]*=e,this.e[2]*=t,this.e[3]*=e,this},rotate:function(t){if(!t)return this;var e=soya2d.Math;t=0>t?360+t%360:t,t>360&&(t%=360);var i=this.e[0],s=this.e[1],n=this.e[2],o=this.e[3],a=e.SINTABLE[t],r=e.COSTABLE[t];return void 0===a&&(a=Math.sin(t*e.ONERAD),r=Math.cos(t*e.ONERAD)),this.e[0]=i*r+s*-a,this.e[1]=i*a+s*r,this.e[2]=n*r+o*-a,this.e[3]=n*a+o*r,this},skew:function(t,e){var i=this.e[0],s=this.e[1],n=this.e[2],o=this.e[3];if(t){var a;this.skewX===t&&this.sx?a=this.sx:(a=Math.tan(.017453292*t),this.sx=a),this.e[0]+=s*a,this.e[2]+=o*a}if(e){var r;this.skewY===t&&this.sy?r=this.sy:(r=Math.tan(.017453292*e),this.sy=r),this.e[1]+=i*r,this.e[3]+=n*r}return this}},soya2d.Vector=function(t,e){this.e=new Float32Array(2),this.e[0]=t||0,this.e[1]=e||0},soya2d.Vector.prototype={toString:function(){return"{x:"+this.e[0]+",y:"+this.e[1]+"}"},clone:function(){return new soya2d.Vector(this.e[0],this.e[1])},set:function(t,e){return this.e[0]=t||0,this.e[1]=e||0,this},dot:function(t){return this.e[0]*t.e[0]+this.e[1]*t.e[1]},negate:function(){return this.e[0]*=-1,this.e[1]*=-1,this},add:function(t){return this.e[0]+=t.e[0],this.e[1]+=t.e[1],this},sub:function(t){return this.e[0]-=t.e[0],this.e[1]-=t.e[1],this},mul:function(t){return this.e[0]*=t,this.e[1]*=t,this},div:function(t){return t?(this.e[0]/=t,this.e[1]/=t):(this.e[0]=0,this.e[1]=0),this},getAngle:function(){return Math.atan2(this.e[1],this.e[0])},getAngleBetween:function(t){var e=this.dot(t),i=e/(this.length()*t.length());return Math.acos(i)},rotate:function(t){var e=soya2d.Math,i=e.SINTABLE[t],s=e.COSTABLE[t];void 0===i&&(i=Math.sin(t*e.ONERAD),s=Math.cos(t*e.ONERAD));var n=this.e[0],o=this.e[1];return this.e[0]=n*s-o*i,this.e[1]=n*i+o*s,this},lengthSq:function(){return this.e[0]*this.e[0]+this.e[1]*this.e[1]},length:function(){return Math.sqrt(this.lengthSq())},normalize:function(){return this.div(this.length())}},p.prototype={sensor:function(t){return this.__cbk&&this.__cbk.sensor(this.rigid,t),this},moveTo:function(t,e){return this.__cbk&&this.__cbk.moveTo(this.rigid,t,e),this},moveBy:function(t,e){return this.__cbk&&this.__cbk.moveBy(this.rigid,t,e),this},"static":function(t){return this.__cbk&&this.__cbk.static(this.rigid,t),this},mass:function(t){return this.__cbk&&this.__cbk.mass(this.rigid,t),this},rotateBy:function(t){return this.__cbk&&this.__cbk.rotateBy(this.rigid,t),this},rotateTo:function(t){return this.__cbk&&this.__cbk.rotateTo(this.rigid,t),this},friction:function(t){return this.__cbk&&this.__cbk.friction(this.rigid,t),this},restitution:function(t){return this.__cbk&&this.__cbk.restitution(this.rigid,t),this},velocity:function(t,e){return this.__cbk&&this.__cbk.velocity(this.rigid,t||0,e||0),this},inertia:function(t){return this.__cbk&&this.__cbk.inertia(this.rigid,t||0),this}};var j=soya2d.class("",{"extends":N,constructor:function(){this.running=!1},setup:function(t){this.__cbk=t||{}},start:function(t){t=t||{},t.gravity=t.gravity||[0,1],t.gravity[0]=t.gravity[0]||0,t.gravity[1]=t.gravity[1]||1,t.enableSleeping=t.enableSleeping||!1,this.__cbk.onStart&&this.__cbk.onStart(t),this.running=!0},stop:function(){this.__cbk.onStop&&this.__cbk.onStop(),this.running=!1},update:function(){this.__cbk.onUpdate&&this.__cbk.onUpdate()},bind:function(t){var e;this.__cbk.onBind&&(e=this.__cbk.onBind(t)),t.body.rigid=e,t.body.__cbk=this.__cbk.body,e.__sprite=t},unbind:function(t){var e=t.body.rigid;e&&(t.body.__cbk=null,this.__cbk.onUnbind&&(e.__sprite=null,this.__cbk.onUnbind(e)),t.body={})},enable:function(t){var e=t;if(t instanceof Array||arguments.length>1){arguments.length>1&&(e=arguments);for(var i=e.length;i--;)this.bind(e[i])}else this.bind(e)},unable:function(t){var e=t;if(t instanceof Array||arguments.length>1){arguments.length>1&&(e=arguments);for(var i=e.length;i--;)this.unbind(e[i])}else this.unbind(e)}});m.prototype={register:function(t,e){this.map[t]=e,e.prototype instanceof soya2d.DisplayObject&&(this.game.add[t]=function(e){return this.__newInstanceAndAppend(t,e)
})}},soya2d.DisplayObject=function(t){if(t=t||{},this.__seq=soya2d.__roIndex++,this.roid="roid_"+this.__seq,this.name=t.name||this.roid,this.visible=t.visible===!1?!1:t.visible||!0,this.layout=t.layout,this.__opacity=0===t.opacity?0:t.opacity||1,this.__x=t.x||0,this.__y=t.y||0,this.__w=t.w||0,this.__h=t.h||0,this.__anchorX=0===t.anchorX?0:t.anchorX||"50%",this.__anchorY=0===t.anchorY?0:t.anchorY||"50%",this.__angle=t.angle||0,this.__scaleX=0==t.scaleX?0:t.scaleX||1,this.__scaleY=0==t.scaleY?0:t.scaleY||1,this.__skewX=t.skewX||0,this.__skewY=t.skewY||0,Object.defineProperties(this,{opacity:{set:function(t){t=0==t?0:parseFloat(t)||1,this.__opacity=0>t?0:t>1?1:t},get:function(){return this.__opacity},enumerable:!0},x:{set:function(t){this.__x=t||0,this.__localChange=!0,this.game.physics.running&&this.body.moveTo(this.__x,this.__y)},get:function(){return this.__x},enumerable:!0},y:{set:function(t){this.__y=t||0,this.__localChange=!0,this.game.physics.running&&this.body.moveTo(this.__x,this.__y)},get:function(){return this.__y},enumerable:!0},w:{set:function(t){this.__w=t,this.__anchorChange=!0},get:function(){return this.__w},enumerable:!0},h:{set:function(t){this.__h=t,this.__anchorChange=!0},get:function(){return this.__h},enumerable:!0},anchorX:{set:function(t){this.__anchorX=t,this.__anchorChange=!0},get:function(){return this.__anchorX},enumerable:!0},anchorY:{set:function(t){this.__anchorY=t,this.__anchorChange=!0},get:function(){return this.__anchorY},enumerable:!0},angle:{set:function(t){this.__angle=t,this.__localChange=!0,this.game.physics.running&&this.body.rotateTo(this.__angle)},get:function(){return this.__angle},enumerable:!0},scaleX:{set:function(t){this.__scaleX=t,this.__localChange=!0},get:function(){return this.__scaleX},enumerable:!0},scaleY:{set:function(t){this.__scaleY=t,this.__localChange=!0},get:function(){return this.__scaleY},enumerable:!0},skewX:{set:function(t){this.__skewX=t,this.__localChange=!0},get:function(){return this.__skewX},enumerable:!0},skewY:{set:function(t){this.__skewY=t,this.__localChange=!0},get:function(){return this.__skewY},enumerable:!0}}),this.z=t.z||0,this.__localChange=!0,this.__anchorChange=!0,this.__localTransform=new soya2d.Matrix2x2,this.__worldTransform=new soya2d.Matrix2x2,this.worldPosition=new soya2d.Point,this.anchorPosition=new soya2d.Point,this.__screenPosition=new soya2d.Point(1/0,1/0),this.blendMode=t.blendMode||"source-over",this.__mask=t.mask||null,this.__fixedToCamera=t.fixedToCamera||!1,Object.defineProperties(this,{mask:{set:function(t){t&&(t.__masker&&(t.__masker.__mask=null),this.__mask=t,t.__masker=this)},get:function(){return this.__mask},enumerable:!0},fixedToCamera:{set:function(t){this.__fixedToCamera=t,t&&this.cameraOffset.set(this.x,this.y)},get:function(){return this.__fixedToCamera},enumerable:!0}}),this.__masker=null,this.bounds=t.bounds||new soya2d.Rectangle(0,0,this.__w,this.__h),this.__boundRect=new soya2d.Rectangle(0,0,1,1),this.body=new p(this),this.game=t.game||soya2d.games[0],this.imageCache=null,this.__updateCache=!1,this.cameraOffset=new soya2d.Point,!this.game)throw new Error("soya2d.DisplayObject: invalid param [game]; "+this.game);soya2d.ext(this,t),this.fixedToCamera=this.__fixedToCamera,this.events=new D(this)},soya2d.DisplayObject.prototype={onBuild:function(t){for(var e in t){var i=e,s=t[e];switch(i){case"x":case"w":case"y":case"h":case"z":case"angle":case"scaleX":case"scaleY":case"skewX":case"skewY":s=parseFloat(s);break;case"fixedToCamera":case"visible":s=new Function("return "+s)()}0===i.indexOf("layout-")?(t.layout||(t.layout={}),t.layout[i.split("-")[1]]=s):t[i]=s}return t},_onAdded:function(){this.centerX=this.w/2,this.centerY=this.h/2,this.setLayout(this.layout),this.fixedToCamera&&this.layout&&this.cameraOffset.set(this.x,this.y),this.onAdded&&this.onAdded()},setLayout:function(t){if(!t)return this;var e=t.left||0,i=t.top||0,s=t.width,n=t.height,o=t.offsetLeft,a=t.offsetTop;s&&(this.__w=v(s,this.parent)||0),n&&(this.__h=w(n,this.parent)||0);var r=0,h=0;return o&&(r=x(o,this.__w)),a&&(h=x(a,this.__h)),(e||o)&&(this.__x=v(e,this.parent)+r),(i||a)&&(this.__y=w(i,this.parent)+h),this},refreshLayout:function(){return this.setLayout(this.layout),this},toString:function(){return'{roid:"'+this.roid+'";name:"'+this.name+'"}'},transform:function(){var t=this.__x,e=this.__y;this.__localChange&&(this.__localTransform.identity(),this.__localTransform.scale(this.__scaleX,this.__scaleY).rotate(this.__angle).skew(this.__skewX,this.__skewY));var i=this.__localTransform,s=this.__worldTransform,n=this.anchorPosition,o=i.e,a=n.x,r=n.y;if(this.__anchorChange&&(a=this.__anchorX,r=this.__anchorY,a="number"==typeof a?a:parseFloat(a)/100*this.__w,r="number"==typeof r?r:parseFloat(r)/100*this.__h,n.set(a,r)),t+=a,e+=r,s.set(o[0],o[1],o[2],o[3]),this.parent){var h=this.parent.__worldTransform,c=h.e,l=this.parent.worldPosition,u=this.parent.anchorPosition,d=u.x*c[0]+u.y*c[2],f=u.x*c[1]+u.y*c[3],_=t*c[0]+e*c[2],g=t*c[1]+e*c[3];t=_+l.x-d,e=g+l.y-f,s.mul(h)}this.body.rigid&&(t-=n.x,e-=n.y),this.worldPosition.set(t,e),this.__localChange=this.__anchorChange=!1},isRendered:function(){if(!this.visible||0===this.opacity)return!1;for(var t=this.parent;t;){if(!t.visible||0===t.opacity)return!1;if(!(t.parent||t instanceof U))return!1;t=t.parent}return!0},clone:function(t,e){e=e||new this.constructor;for(var i=Object.keys(this),s=i.length;s--;){var n=i[s];if("parent"!==n&&"__seq"!==n&&"roid"!==n&&"__localTransform"!==n&&"__worldTransform"!==n&&"worldPosition"!==n&&"anchorPosition"!==n&&"__screenPosition"!==n&&(t||"children"!==n))if(t&&"children"===n&&this[n]&&this[n].length>0){e[n]=[];for(var o=0;o<this[n].length;o++){var a=this[n][o],r=a.clone(t);r.parent=e,e[n].push(r)}}else e[n]=this[n]instanceof Array?this[n].slice(0):this[n]}return e},moveBy:function(){var t=arguments[0]||0,e=0===arguments[1]?0:arguments[1]||t;return this.x+=t,this.y+=e,this},moveTo:function(){var t=arguments[0]||0,e=0===arguments[1]?0:arguments[1]||t;return this.x=t,this.y=e,this},opacifyTo:function(t){return this.opacity=t>1?1:0>t?0:t,this},opacifyBy:function(t){return this.opacity+=t,this.opacity>1&&(this.opacity=1),this.opacity<0&&(this.opacity=0),this},resizeTo:function(){var t=arguments[0]||0,e=0===arguments[1]?0:arguments[1]||t;return this.w=t,this.h=e,this},scaleBy:function(){var t=arguments[0]||0,e=0===arguments[1]?0:arguments[1]||t;return this.scaleX+=t,this.scaleY+=e,this},scaleTo:function(){var t=arguments[0]||0,e=0===arguments[1]?0:arguments[1]||t;return this.scaleX=t,this.scaleY=e,this},skewBy:function(){var t=arguments[0]||0,e=0===arguments[1]?0:arguments[1]||t;return this.skewX+=t,this.skewY+=e,this},skewTo:function(){var t=arguments[0]||0,e=0===arguments[1]?0:arguments[1]||t;return this.skewX=t,this.skewY=e,this},rotateBy:function(t){return this.angle+=t,this},rotateTo:function(t){return this.angle=t,this},anchorBy:function(){var t=arguments[0]||0,e=0===arguments[1]?0:arguments[1]||t;return this.anchorX+=t,this.anchorY+=e,this},anchorTo:function(){var t=arguments[0]||0,e=0===arguments[1]?0:arguments[1]||t;return this.anchorX=t,this.anchorY=e,this},getBoundingPoints:function(){var t=this.__worldTransform.e,e=this.worldPosition,i=this.anchorPosition,s=e.x,n=e.y,o=t[0],a=t[1],r=t[2],h=t[3],c=i.x,l=i.y,u=-c,d=-l,f=this.w-c,_=-l,g=-c,p=this.h-l,m=this.w-c,y=this.h-l;return[u*o+d*r+s,u*a+d*h+n,f*o+_*r+s,f*a+_*h+n,m*o+y*r+s,m*a+y*h+n,g*o+p*r+s,g*a+p*h+n]},getBoundingBox:function(){var t,e,i,s,n=this.getBoundingPoints();i=n[0],t=n[0],s=n[1],e=n[1];for(var o=n.length;o--;)o%2===0?(n[o]>i&&(i=n[o]),n[o]<t&&(t=n[o])):(n[o]>s&&(s=n[o]),n[o]<e&&(e=n[o]));var a=t,r=e,h=i-t,c=s-e;return this.__boundRect.x=a,this.__boundRect.y=r,this.__boundRect.w=h,this.__boundRect.h=c,this.__boundRect},hitTest:function(t,e){if(t instanceof soya2d.Point){var i=t;t=i.x,e=i.y}var s=this.worldPosition;if(this.bounds instanceof soya2d.Circle){var n=Math.abs(soya2d.Math.len2D(s.x,s.y,t,e));if(n<=this.bounds.r)return!0}else if(this.bounds instanceof soya2d.Rectangle||this.bounds instanceof soya2d.Polygon){var o;if(this.bounds.vtx){var a=this.__worldTransform.e,r=this.anchorPosition,h=s.x,c=s.y,l=a[0],u=a[1],d=a[2],f=a[3],_=r.x,g=r.y,p=-_,m=-g;o=[];for(var y=0;y<this.bounds.vtx.length;y+=2){var v=this.bounds.vtx[y]+p,w=this.bounds.vtx[y+1]+m;o.push(v*l+w*d+h,v*u+w*f+c)}}else o=this.getBoundingPoints();for(var x=!1,y=0;y<o.length;y+=2){var v=o[y],w=o[y+1],b=o[y+2]||o[0],T=o[y+3]||o[1];if(v===t&&w===e||b===t&&T===e)return!0;if(e>w&&T>=e||w>=e&&e>T){var E=(e-w)/(T-w)*(b-v)+v;if(E===t)return!0;E>t&&(x=!x)}}return x}return!1},intersectWith:function(t){var e=this.getBoundingBox(),i=t.getBoundingBox();return e.intersectWith(i)},getAnchorPosition:function(){var t=this.__worldTransform.e,e=this.worldPosition,i=this.anchorPosition,s=e.x,n=e.y,o=t[0],a=t[1],r=t[2],h=t[3],c=i.x,l=i.y,u=-c,d=-l,f=this.w*parseInt(this.anchorX)/100,_=this.h*parseInt(this.anchorY)/100,g=Math.sqrt(_*_+f*f),p=Math.atan2(_,f);return f=Math.cos(p)*g+u,_=Math.sin(p)*g+d,new soya2d.Point(f*o+_*r+s,f*a+_*h+n)},cache:function(){if(!(this.__w>1024||this.__h>1024)){this.imageCache||(this.imageCache=document.createElement("canvas")),this.imageCache.width=this.__w,this.imageCache.height=this.__h,this.transform(),this.__updateCache=!0,this.__renderable=!0;var t=this.imageCache.getContext("2d"),e=new soya2d.CanvasGraphics(t);this.game.renderer.renderDO(this.game.camera.__view,t,this,e,!0),this.__updateCache=!1}},destroy:function(){if(this.game.physics.unbind(this),this.__seq){this.children.length>0&&this.children.forEach(function(t){t.destroy()});for(var t=Object.keys(this),e=t.length;e--;)t[e].indexOf("__")<0||(this[t[e]]=null);this.parent&&this.parent.remove(this),this.events.clear(),this.onRender=this.onUpdate=this.parent=this.children=this.imageCache=this.fillStyle=this.game=this.events=this.body=null}}},soya2d.class("soya2d.DisplayObjectContainer",{"extends":soya2d.DisplayObject,constructor:function(){this.children=[],this.parent=null},add:function(){for(var t=0;t<arguments.length;t++){var e=arguments[t];e.parent&&e.parent.remove(e),this.children.push(e),e.parent=this,e._onAdded()}return this},remove:function(){for(var t=0;t<arguments.length;t++){var e=arguments[t],i=this.children.indexOf(e);0>i||(this.children.splice(i,1),e.parent=null)}return this},clear:function(t){for(var e=this.children.length;e--;)this.children[e].parent=null;var i=this.children;if(this.children=[],t)for(var e=i.length;e--;)i[e].destroy();return i},find:function(t,e){if(this.children.length<1)return[];var i;return e?(i=[],E(this,t,i)):i=this.children.filter(t),i}});var U=soya2d.class("",{"extends":soya2d.DisplayObjectContainer,constructor:function(t){this.game=t.game,this.__anchorX=this.__anchorY=0,this.minWidth=0,this.minHeight=0,this.maxWidth=0,this.maxHeight=0,this.autoScale=!0,this.orientation=k();var e,i=this;window.addEventListener("orientationchange",function(){clearTimeout(e),e=setTimeout(function(){i.orientation=k()},500),i.autoScale&&i.__scan()},!1),window.addEventListener("resize",function(){i.orientation=k(),i.autoScale&&i.__scan()},!1),this.__bg=null,this.__rotat=soya2d.ROTATEMODE_0;var s=soya2d.ALIGNMODE_CENTER,n=soya2d.SCALEMODE_SHOWALL;Object.defineProperties(this,{scaleMode:{set:function(t){n=t,this.__scan()},get:function(){return n}},alignMode:{set:function(t){if(t&&this.scaleMode===soya2d.SCALEMODE_SHOWALL){var e=this.game.renderer.getCanvas();switch(s=t,t){case soya2d.ALIGNMODE_LEFT:e.style.left=0,e.style.right="auto";break;case soya2d.ALIGNMODE_RIGHT:e.style.left="auto",e.style.right=0;break;case soya2d.ALIGNMODE_CENTER:default:e.style.left=0,e.style.right=0,s=soya2d.ALIGNMODE_CENTER}e.style.margin="auto"}},get:function(){return s}},rotateMode:{set:function(t){this.__rotat=t,this.__scan()},get:function(){return this.__rotat}}})},__updateMatrix:function(){A(this)},__preUpdate:function(t,e){this.onUpdate&&this.onUpdate(t,e),this.children&&O(this.children,t,e)},__postUpdate:function(t,e){this.onPostUpdate&&this.onPostUpdate(t,e),this.children&&S(this.children,t,e)},onRender:function(t){this.__bg&&(t.fillStyle(this.__bg),t.fillRect(0,0,this.w,this.h))},background:function(t){if("string"==typeof t)this.__bg=t;else if(t instanceof self.Image)this.__bg=this.game.renderer.createPattern(t,arguments[1]);else if(!isNaN(t)){var e={};arguments[4]&&soya2d.ext(e,arguments[4]),e.type=t;var i=this.game.renderer.createGradient(arguments[1],arguments[2],arguments[3]||1,e);this.__bg=i}},__scan:function(){var t,e=this.game.w,i=this.game.h;switch(this.scaleMode){case soya2d.SCALEMODE_NOSCALE:break;case soya2d.SCALEMODE_NOBORDER:t=R;break;case soya2d.SCALEMODE_EXACTFIT:t=L;break;case soya2d.SCALEMODE_SHOWALL:default:t=C}if(t){var s=this.game.renderer,n=s.getCanvas().parentNode,o=n.clientWidth,a=n.clientHeight;"BODY"===n.tagName&&(a=window.innerHeight);var r=t(e,i,o,a,this.minWidth,this.minHeight,this.maxWidth,this.maxHeight);s.resize(r[0],r[1]),M(this.scaleMode,this.__rotat,s.getCanvas(),s,this)}}});soya2d.SCALEMODE_NOSCALE=0,soya2d.SCALEMODE_SHOWALL=1,soya2d.SCALEMODE_NOBORDER=2,soya2d.SCALEMODE_EXACTFIT=3,soya2d.ALIGNMODE_LEFT=1,soya2d.ALIGNMODE_CENTER=2,soya2d.ALIGNMODE_RIGHT=3,soya2d.ROTATEMODE_0=1,soya2d.ROTATEMODE_90=2,soya2d.ROTATEMODE_180=3,soya2d.ROTATEMODE_270=4,soya2d.BG_REPEAT="repeat",soya2d.BG_NOREPEAT="no-repeat",soya2d.BG_REPEAT_X="repeat-x",soya2d.BG_REPEAT_Y="repeat-y";var z=soya2d.class("",{"extends":soya2d.DisplayObjectContainer,constructor:function(){this.__soya_type="world"},setBounds:function(t,e){this.bounds.w=t,this.bounds.h=e,this.w=t,this.h=e}});soya2d.class("soya2d.Shape",{"extends":soya2d.DisplayObjectContainer}),I.prototype.reset=function(){this.index=0,this.lastUpdateTime=0};var G=soya2d.class("",{"extends":N,constructor:function(t,e){this.map={};for(var i=[],s=0;e>s;s++)i.push(s);this.defaultAnimation=new I(i),this.animation=null,this.playingK=null},destroy:function(){this.defaultAnimation=null,this.animation=null,this.playingK=null,this.__signalHandler=null},add:function(t,e,i,s){return this.map[t]=new I(e,i,s),this},remove:function(t){return this.playingK===t&&this.stop(),this.map[t]=null,delete this.map[t],this},play:function(t){return this.playingK===t?this:(this.animation=t?this.map[t]:this.defaultAnimation,this.playingK=t||!0,this)},stop:function(){return this.playingK=null,this.animation&&this.animation.reset(),this.animation=null,this}});soya2d.class("soya2d.Sprite",{"extends":soya2d.DisplayObjectContainer,constructor:function(t){var e=t.images;e&&(this.animations=null,this.setImages(e),this.w=t.w||this.images[0].width,this.h=t.h||this.images[0].height,this.__frameIndex=t.frameIndex||0,this.__scale9grid=t.scale9grid,Object.defineProperties(this,{frameIndex:{set:function(t){this.__frameIndex=t,this.__cacheGrid=!0},get:function(){return this.__frameIndex},enumerable:!0},scale9grid:{set:function(t){t instanceof soya2d.Rectangle&&(this.__scale9grid=t,this.__cacheGrid=!0,this.__parseScale9())},get:function(){return this.__scale9grid},enumerable:!0}}))},clone:function(t){var e=new this.constructor({images:this.images.concat()});return soya2d.DisplayObject.prototype.clone.call(this,t,e)},onBuild:function(t){soya2d.DisplayObject.prototype.onBuild(t);for(var e in t){var i=e,s=t[e];switch(i){case"images":t[i]=s.split(",");break;case"frameIndex":t[i]=parseFloat(s);break;case"atlas":var n=t["atlas-prefix"];t.images=game.assets.atlas(s).getAll(n);break;case"scale9grid":var o=s.split(",");t[i]=new soya2d.Rectangle(parseFloat(o[0]),parseFloat(o[1]),parseFloat(o[2]),parseFloat(o[3]))}}},_onAdded:function(){soya2d.DisplayObject.prototype._onAdded.call(this),!this.__scale9grid||this.__w==this.images[0].width&&this.__h==this.images[0].height||(this.__cacheGrid=!0,this.__parseScale9())},_onUpdate:function(){this.__cacheGrid&&this.__scale9grid instanceof soya2d.Rectangle&&(this.cache(),this.__cacheW=this.__w,this.__cacheH=this.__h,this.__cacheGrid=!1)},__parseScale9:function(){var t=this.images[0].width,e=this.images[0].height,i=this.__scale9grid.y+this.__scale9grid.h,s=e-i,n=this.__scale9grid.x+this.__scale9grid.w,o=t-n,a=this.__w-this.__scale9grid.x-o,r=this.__h-this.__scale9grid.y-s,h=a+this.__scale9grid.x,c=r+this.__scale9grid.y,l=this.__scale9grid.x,u=this.__scale9grid.y,d=this.__scale9grid.w,f=this.__scale9grid.h;this.__scale9Data={t1:{x:0,y:0,w:l,h:u},t2:{x:l,y:0,w:d,h:u,dw:a},t3:{x:n,y:0,w:o,h:u,dx:h},m1:{x:0,y:u,w:l,h:f,dh:r},m2:{x:l,y:u,w:d,h:f,dw:a,dh:r},m3:{x:n,y:u,w:o,h:f,dx:h,dh:r},b1:{x:0,y:i,w:l,h:s,dy:c},b2:{x:l,y:i,w:d,h:s,dw:a,dy:c},b3:{x:n,y:i,w:o,h:s,dx:h,dy:c}}},onRender:function(t){if(this.animations.playingK){var e=this.animations.animation;e.lastUpdateTime||(e.lastUpdateTime=(new Date).getTime());var i=(new Date).getTime(),s=i-e.lastUpdateTime,n=s/(16.7*e.frameRate)>>0;if(n>0){if(e.index+=n,e.index>=e.frames.length){if(!e.loop){var o=this.animations.playingK;return this.animations.stop(),this.animations.emit("stop",o),void 0}e.index=0}e.lastUpdateTime=i}var a=e.frames[e.index];t.map(this.images[a],0,0,this.w,this.h)}else if(this.__scale9grid&&this.__updateCache){var r=this.images[this.__frameIndex],h=this.__scale9Data,c=h.t1,l=h.t2,u=h.t3,d=h.m1,f=h.m2,_=h.m3,g=h.b1,p=h.b2,m=h.b3;t.map(r,c.x,c.y,c.w,c.h,c.x,c.y,c.w,c.h),t.map(r,l.x,l.y,l.dw,l.h,l.x,l.y,l.w,l.h),t.map(r,u.dx,u.y,u.w,u.h,u.x,u.y,u.w,u.h),t.map(r,d.x,d.y,d.w,d.dh,d.x,d.y,d.w,d.h),t.map(r,f.x,f.y,f.dw,f.dh,f.x,f.y,f.w,f.h),t.map(r,_.dx,_.y,_.w,_.dh,_.x,_.y,_.w,_.h),t.map(r,g.x,g.dy,g.w,g.h,g.x,g.y,g.w,g.h),t.map(r,p.x,p.dy,p.dw,p.h,p.x,p.y,p.w,p.h),t.map(r,m.dx,m.dy,m.w,m.h,m.x,m.y,m.w,m.h)}else t.map(this.images[this.frameIndex],0,0,this.w,this.h)},nextFrame:function(t){this.frameIndex++,this.frameIndex>=this.images.length&&(this.frameIndex=t?0:this.images.length-1)},prevFrame:function(t){this.frameIndex--,this.frameIndex<0&&(this.frameIndex=t?this.images.length-1:0)},setImages:function(t,e){if("string"==typeof t)this.images=[this.game.assets.image(t)];else if(t instanceof self.Image||t.getContext&&1==t.nodeType)this.images=[t];else if(t instanceof Array){var i=[];t.forEach(function(t){"string"==typeof t?i.push(this.game.assets.image(t)):i.push(t)},this),this.images=i}else this.images=[];return this.images[0]||soya2d.console.error("soya2d.Sprite: invalid param [images]; "+this.images[0]),this.frameIndex=0,e&&(this.w=this.images[0].width,this.h=this.images[0].height),this.animations&&this.animations.destroy(),this.animations=new G(this,this.images.length),this}}),soya2d.class("soya2d.Button",{"extends":soya2d.Sprite,constructor:function(t){t.action&&this.events.onPointerTap(t.action);var e=t.frameMap||{},i=this;void 0!=e.over&&this.events.onPointerOver(function(){this.frameIndex=e.over}),void 0!=e.out&&this.events.onPointerOut(function(){this.frameIndex=e.out}),void 0!=e.down&&this.events.onPointerDown(function(){this.frameIndex=e.down}),void 0!=e.up&&this.game.stage.events.onPointerUp(function(){i.frameIndex=e.up}),this.frameIndex=e.up||0}}),soya2d.class("soya2d.TileSprite",{"extends":soya2d.DisplayObjectContainer,constructor:function(t){this.sprite=null,this.sprite=t.sprite instanceof soya2d.Sprite?t.sprite:new soya2d.Sprite({images:t.sprite}),this.w=t.w||this.sprite.w,this.h=t.h||this.sprite.h,this.autoScroll=t.autoScroll||!1,this.speed=t.speed||1,this.scrollAngle=t.scrollAngle||0,this.__tileOffx=0,this.__tileOffy=0},scroll:function(t,e){if(t||e)this.__tileOffx+=t||0,this.__tileOffy+=e||0;else{var i=(this.scrollAngle>>0)%360;this.__tileOffx+=soya2d.Math.COSTABLE[i]*this.speed,this.__tileOffy+=soya2d.Math.SINTABLE[i]*this.speed}},clone:function(t){var e=new this.constructor({sprite:this.sprite});return soya2d.DisplayObject.prototype.clone.call(this,t,e),e},_onUpdate:function(){if(this.autoScroll){var t=(this.scrollAngle>>0)%360;this.__tileOffx+=soya2d.Math.COSTABLE[t]*this.speed,this.__tileOffy+=soya2d.Math.SINTABLE[t]*this.speed}},onRender:function(t){t.beginPath(),t.push(),t.rect(0,0,this.w,this.h),t.clip();var e=this.sprite,i=e.w,s=e.h,n=i*e.scaleX,o=s*e.scaleY;n=0>n?-1*n:n,o=0>o?-1*o:o;var a=(this.w/n>>0)+2,r=(this.h/o>>0)+2,h=this.__tileOffx%n,c=this.__tileOffy%o;this.__tileOffx>0&&(h-=n),this.__tileOffy>0&&(c-=o);for(var l=this.sprite.images[0],u=r;u--;)for(var d=a;d--;){var f=d*n,_=u*o;t.map(l,f+h,_+c,n,o,0,0,i,s)}t.pop()}}),soya2d.CanvasGraphics=function(t){this.ctx=t,this.opacity=function(t){return 0===t||t?(this.ctx.globalAlpha=t,this):this.ctx.globalAlpha},this.closePath=function(){return this.ctx.closePath(),this},this.moveTo=function(t,e){return this.ctx.moveTo(t,e),this},this.lineTo=function(t,e){return this.ctx.lineTo(t,e),this},this.quadraticCurveTo=function(t,e,i,s){return this.ctx.quadraticCurveTo(t,e,i,s),this},this.bezierCurveTo=function(t,e,i,s,n,o){return this.ctx.bezierCurveTo(t,e,i,s,n,o),this},this.arcTo=function(t,e,i,s,n){return this.ctx.arcTo(t,e,i,s,n),this},this.arc=function(t,e,i,s,n){return this.ctx.arc(t,e,i,s||0,n||soya2d.Math.PIM2),this},this.eArc=function(e,i,s,n,o,a){o=(o||0)>>0,a=(a||360)>>0;var r=soya2d.Math,h=e+s*r.COSTABLE[o],c=i+n*r.SINTABLE[o];t.moveTo(h,c);var l=0;l=o>a?360-o+a:a-o;for(var u=1;l>=u;u++){var d=(o+u)%360;h=e+s*r.COSTABLE[d],c=i+n*r.SINTABLE[d],t.lineTo(h,c)}return this},this.rect=function(t,e,i,s){return this.ctx.rect(t,e,i,s),this},this.blendMode=function(t){return t?(this.ctx.globalCompositeOperation=t,this):this.ctx.globalCompositeOperation},this.strokeStyle=function(t){return t?(this.ctx.strokeStyle=t,this):this.ctx.strokeStyle},this.fillStyle=function(t){return t?(this.ctx.fillStyle=t,this):this.ctx.fillStyle},this.shadow=function(t,e,i,s){return this.ctx.shadowBlur=t,this.ctx.shadowColor=e,this.ctx.shadowOffsetX=i,this.ctx.shadowOffsetY=s,this},this.lineStyle=function(t,e,i,s){var n=this.ctx;return n.lineWidth=t,n.lineCap=e||n.lineCap,n.lineJoin=i||n.lineJoin,n.miterLimit=s||n.miterLimit,this},this.font=function(t){var e=this.ctx;return e.font=t.getDesc(),this},this.clip=function(){return this.ctx.clip(),this},this.push=function(){return this.ctx.save(),this},this.pop=function(){return this.ctx.restore(),this},this.beginPath=function(){return this.ctx.beginPath(),this},this.closePath=function(){return this.ctx.closePath(),this},this.fill=function(){return this.ctx.fill(),this},this.stroke=function(){return this.ctx.stroke(),this},this.path=function(t,e){e=e&&e instanceof Array?e.concat():[];for(var i=0;i<t.length;){var s=e.shift(),n=2;switch(s){case"m":this.ctx.moveTo(t[i],t[i+1]);break;case"c":this.ctx.bezierCurveTo(t[i],t[i+1],t[i+2],t[i+3],t[i+4],t[i+5]),n=6;break;case"q":this.ctx.quadraticCurveTo(t[i],t[i+1],t[i+2],t[i+3]),n=4;break;case"z":this.ctx.closePath();break;case"l":default:this.ctx.lineTo(t[i],t[i+1])}i+=n}return this},this.fillRect=function(t,e,i,s){return this.ctx.fillRect(t,e,i,s),this},this.strokeRect=function(t,e,i,s){return this.ctx.strokeRect(t,e,i,s),this},this.clearRect=function(t,e,i,s){return this.ctx.clearRect(t,e,i,s),this},this.map=function(t,e,i,s,n,o,a,r,h){return o=o||0,a=a||0,r=r||t.width,h=h||t.height,0!==r&&0!==h&&0!==s&&0!==n?(this.ctx.drawImage(t,o>>0,a>>0,r>>0,h>>0,e>>0,i>>0,s>>0,n>>0),this):void 0},this.fillText=function(t,e,i,s){return s?this.ctx.fillText(t,e||0,i||0,s):this.ctx.fillText(t,e||0,i||0),this},this.strokeText=function(t,e,i,s){return s?this.ctx.strokeText(t,e||0,i||0,s):this.ctx.strokeText(t,e||0,i||0),this}},soya2d.CanvasRenderer=function(t){function e(t){t.stroke=function(){},t.fill=function(){},t.fillRect=function(e,i,s,n){t.rect(e,i,s,n)},t.strokeRect=function(e,i,s,n){t.rect(e,i,s,n)},t.drawImage=function(e,i,s,n,o,a,r,h,c){3===arguments.length?t.rect(i,s,e.width,e.height):5===arguments.length?t.rect(i,s,n,o):9===arguments.length&&t.rect(a,r,h,c)},t.fillText=function(){},t.strokeText=function(){},t.beginPath=function(){},t.closePath=function(){}}function i(t){t.stroke=_.stroke,t.fill=_.fill,t.fillRect=_.fillRect,t.strokeRect=_.strokeRect,t.drawImage=_.drawImage,t.fillText=_.fillText,t.strokeText=_.strokeText,t.beginPath=_.beginPath,t.closePath=_.closePath}function s(t,e){if(e.onRender){var i=e.__worldTransform.e,n=e.worldPosition;t.setTransform(i[0],i[1],i[2],i[3],n.x,n.y);var o=e.anchorPosition;t.translate(-o.x,-o.y),e.onRender(u)}if(e.children&&e.children.length>0)for(var a=e.children,r=0;r<a.length;r++)s(t,a[r])}function n(t,o,a,r,h,c){if(0!==a.opacity&&a.visible&&!a.__masker){var l=a.__screenPosition;if(a.__renderable||1/0==l.x||1/0==l.y){if(f++,a.mask instanceof soya2d.DisplayObject&&(o.save(),o.beginPath(),e(o),s(o,a.mask),o.clip(),i(o),o.closePath()),a.onRender){var u=a.__worldTransform.e,d=a.anchorPosition,_=a.worldPosition;if(a.__updateCache){var g=d.x,p=d.y;o.setTransform(1,0,0,1,g,p)}else{var g=l.x,p=l.y;1/0==g&&1/0==p&&(g=_.x,p=_.y),o.setTransform(u[0],u[1],u[2],u[3],g,p)}c&&a.opacity<=1&&a.opacity!==c.opacity&&(c.opacity=a.opacity,o.globalAlpha=a.opacity),c&&c.blendMode!==a.blendMode&&(c.blendMode=a.blendMode,o.globalCompositeOperation=a.blendMode),o.translate(-d.x,-d.y),a.imageCache&&!a.__updateCache?o.drawImage(a.imageCache,0,0):a.onRender(r)}if(a.__renderable=!1,a.children&&a.children.length>0&&!a.__updateCache){var m=a.children;h&&m.sort(function(t,e){return t.z===e.z?t.__seq-e.__seq:t.z-e.z});for(var y=0;y<m.length;y++)n(t,o,m[y],r,h,c)}a.mask instanceof soya2d.DisplayObject&&o.restore()}}}t=t||{};var o=t.container;this.w=t.w||(o?o.clientWidth:0),this.h=t.h||(o?o.clientHeight:0),this.autoClear=void 0===t.autoClear?!0:t.autoClear,this.sortEnable=t.sortEnable||!1;var a=t.smoothEnable===!1?!1:t.smoothEnable||!0,r=t.crispEnable||!1,h=document.createElement("canvas");h.style.position="absolute";var c=window.getComputedStyle(t.container,null).position;"absolute"!==c&&"relative"!==c&&(o.style.position="relative"),c=null,o.appendChild(h),o=null;var l=h.getContext("2d"),u=new soya2d.CanvasGraphics(l);h.width=this.w,h.height=this.h,this.ctx=l,l.textBaseline=soya2d.TEXTVALIGN_TOP;var d={opacity:1,blendMode:"source-over"};this.getCanvas=function(){return h};var f=0;this.render=function(t,e){if(!(!t instanceof U)){l.setTransform(1,0,0,1,0,0),this.autoClear&&l.clearRect(0,0,this.w,this.h);var i=e.__view;return f=0,n(i,l,t,u,this.sortEnable,d),f}};var _={stroke:l.stroke,fill:l.fill,fillRect:l.fillRect,strokeRect:l.strokeRect,drawImage:l.drawImage,fillText:l.fillText,strokeText:l.strokeText,beginPath:l.beginPath,closePath:l.closePath};this.renderDO=n,this.destroy=function(){h.parentNode&&h.parentNode.removeChild(h),_=u=this.ctx=null},this.resize=function(t,e){var i=h.width,s=h.height;this.hr=t/i,this.vr=e/s,h.style.width=t+"px",h.style.height=e+"px"},this.hr=1,this.vr=1,this.smooth=function(t){return void 0!==t?(l.imageSmoothingEnabled=l.mozImageSmoothingEnabled=l.oImageSmoothingEnabled=l.msImageSmoothingEnabled=t,a=t,this):a},this.smooth(a),this.crisp=function(t){t?(h.style["image-rendering"]="optimizeSpeed",h.style["image-rendering"]="crisp-edges",h.style["image-rendering"]="-moz-crisp-edges",h.style["image-rendering"]="-webkit-optimize-contrast",h.style["image-rendering"]="optimize-contrast",h.style["image-rendering"]="pixelated",h.style.msInterpolationMode="nearest-neighbor"):(h.style["image-rendering"]="auto",h.style.msInterpolationMode="bicubic")},this.crisp(r),this.getImageData=function(t,e,i,s){return t=t||0,e=e||0,i=i||this.w,s=s||this.h,l.getImageData(t,e,i,s)},this.toDataURL=function(t){return h.toDataURL(t||"image/png")},this.createPattern=function(t,e){return l.createPattern(t,e||"repeat")},this.createGradient=function(t,e,i,s){var n=0,o=0,a=0,r=soya2d.GRADIENT_LINEAR,h=0,c=0;s&&(n=s.angle||0,o=s.x||0,a=s.y||0,r=s.type||soya2d.GRADIENT_LINEAR,h=s.focalRatio||0,c=s.focalRadius||0);var u,d=soya2d.Math;switch(n=Math.abs((n||0)>>0),r){case soya2d.GRADIENT_LINEAR:u=l.createLinearGradient(o,a,o+i*d.COSTABLE[n],a+i*d.SINTABLE[n]);for(var f=0,_=t.length;_>f;f++)u.addColorStop(t[f],e[f]||"RGBA(0,0,0,0)");break;case soya2d.GRADIENT_RADIAL:var g=i*h;u=l.createRadialGradient(o,a,c,o+g*d.COSTABLE[n],a+g*d.SINTABLE[n],i);for(var f=0,_=t.length;_>f;f++)u.addColorStop(t[f],e[f]||"RGBA(0,0,0,0)")}return u}},soya2d.CanvasRenderer.prototype.getImageFrom=function(t,e,i){var s=document.createElement("canvas");s.width=e||t.w,s.height=i||t.h;var n=s.getContext("2d"),o=new soya2d.CanvasGraphics(n),a=new Image;return a.src=s.toDataURL("image/png"),o=null,s=null,a},soya2d.Path=function(t){this.d=t||"",this.cmd=["m","l","c","q","z"],this.vtx=[],this.cmds=[],this.__parse()},soya2d.ext(soya2d.Path.prototype,{__parse:function(){var t=new RegExp("["+this.cmd.join("")+"]([^"+this.cmd.join("")+"]+|$)","img"),e=this.d.replace(/^\s+|\s+$/,"").match(t);e.forEach(function(t){t=t.replace(/^\s+|\s+$/,"");var e=t[0].toLowerCase();if(this.cmd.indexOf(e)>-1){var i=t.substr(1).replace(/^\s/gm,"").split(/\n|,|\s/gm),s=2;switch(e){case"q":s=4;break;case"c":s=6}for(var n=0;n<i.length;n++){var o=i[n]>>0;this.vtx.push(o),n%s==0&&this.cmds.push(e)}}},this)},setPath:function(t){this.d=t,this.__parse()}}),soya2d.Device=new function(){var t=this.userAgent=self.navigator.userAgent.toLowerCase(),e=t.indexOf("windows")>0?!0:!1,i=t.indexOf("linux")>0?!0:!1,s=t.indexOf("mac os")>0?!0:!1,n=t.indexOf("android")>0?!0:!1,o=t.indexOf("iphone")>0?!0:!1,a=t.indexOf("ipad")>0?!0:!1,r=t.indexOf("windows phone")>0?!0:!1;this.iphone=o,this.ipad=a,this.ios=o||a,this.android=n,this.wp=r,this.mobile=this.ios||n||r,this.windows=e,this.linux=i,this.mac=s;var h={Firefox:t.indexOf("firefox")+1,Opera:t.indexOf("opera")+1,Chrome:t.indexOf("chrome")+1,Safari:t.indexOf("safari")>-1&&t.indexOf("chrome")<0};this.ie=/msie|trident.*rv:/.test(t.toLowerCase()),this.ff=h.Firefox?!0:!1,this.opera=h.Opera?!0:!1,this.chrome=h.Chrome?!0:!1,this.safari=h.Safari?!0:!1},soya2d.Font=function(t){var e=document.createElement("span"),i=["padding:0 !important;","margin:0 !important;","top:-9999px !important;","left:-9999px !important;","white-space:nowrap !important;","position:absolute !important;"];e.style.cssText=i.join("")+"font:"+(t||"normal 400 13px/normal sans-serif"),document.body.appendChild(e),this.fontString=e.style.font,this.__textRenderer=function(t){if(t.font(this.font),this.__lines){t.fillStyle(this.fillStyle);for(var e=0,i=this.__lines.length;i>e;e++){var s=this.__lines[e];if(this.letterSpacing>0)for(var n=0,o=0,a=s.length;a>o;o++)t.fillText(s[o],n,(this.__lh+this.lineSpacing)*e),n+=this.letterSpacing+this.__uw;else t.fillText(s,0,(this.__lh+this.lineSpacing)*e)}}},this.clone=function(){return new soya2d.Font(this.getDesc())},this.getDesc=function(){return e.style.font},this.style=function(t){return arguments.length>0?(e.style.fontStyle=t,this.fontString=e.style.font,this):e.style.fontStyle},this.weight=function(t){return arguments.length>0?(e.style.fontWeight=t,this.fontString=e.style.font,this):e.style.fontWeight},this.size=function(t){return arguments.length>0?(e.style.fontSize=t+"px",this.fontString=e.style.font,this):e.style.fontSize},this.family=function(t){return arguments.length>0?(t&&(e.style.fontFamily=t,this.fontString=e.style.font),this):e.style.fontFamily},this.getBounds=function(t){e.innerText=t;var i=e.offsetHeight,s=e.offsetWidth;return{w:s,h:i}}},soya2d.ImageFont=function(t,e){this.__fontMap=t;var i=t.texs[Object.keys(t.texs)[0]].height;this.fontSize=e||i,this.fontWidth=t.texs[Object.keys(t.texs)[0]].width;var s=1;this.__textRenderer=function(t){if(this.__lines)for(var e=0,i=0,n=0,o=this.__lines.length;o>n;n++){for(var a=this.__lines[n],r=0,h=0,c=a.length;c>h;h++){var l=a[h],u=this.font.__fontMap.get(l);if(u){var d=u.width*s,f=u.height*s;i=d,t.map(u,r,e,d,f,0,0,u.width,u.height)}r+=i+this.letterSpacing}e+=this.font.fontSize+this.lineSpacing}},this.clone=function(){return new soya2d.ImageFont(this.__fontMap)},this.size=function(t){return arguments.length>0?(this.fontSize=parseInt(t)||i,s=this.fontSize/i,this):this.fontSize},this.getBounds=function(t){var e=t.length;return{w:e*this.fontWidth*s,h:this.fontSize}},e&&this.size(e)},soya2d.class("soya2d.Text",{"extends":soya2d.DisplayObjectContainer,constructor:function(t){this.text=t.text||"",this.letterSpacing=t.letterSpacing||0,this.lineSpacing=t.lineSpacing||0,this.font=t.font||new soya2d.Font,"string"==typeof this.font?this.font=new soya2d.Font(this.font):this.font instanceof soya2d.Atlas&&(this.font=new soya2d.ImageFont(this.font,t.size)),this.__changed=!0,this.__lines,this.__renderer=this.font.__textRenderer,this.fillStyle=t.fillStyle||"#000";
var e=this.font.getBounds(this.text);this.w||(this.w=e.w),this.h||(this.h=e.h)},onBuild:function(t,e,i){soya2d.DisplayObject.prototype.onBuild(t);for(var s="",n=0;n<e.childNodes.length;n++)3===e.childNodes[n].nodeType&&(s+=e.childNodes[n].nodeValue);t.text=s.replace(/(^\s+)|(\s+$)/gm,"");var o=t.atlas;o&&(t.size=parseInt(t.size),t.font=i.assets.atlas(o));for(var n in t){var a=n,r=t[n];switch(a){case"letterSpacing":case"lineSpacing":t[a]=parseFloat(r)}}},onRender:function(t){this.__renderer(t)},refresh:function(){return this.__changed=!0,this},setFont:function(t){return t?(this.font=t,this.__renderer=this.font.__textRenderer,this):this},setText:function(t,e){return this.text=t+"",this.refresh(),e&&(this.w=this.font.getBounds(this.text).w),this},_onUpdate:function(){if(!this.__lh){var t=this.font.getBounds("s"),e=this.font.getBounds("豆");this.__lh=(t.h+e.h)/2>>0,this.__uw=(t.w+e.w)/2>>0}this.__changed&&(this.__lines=this.__calc(),this.__changed=!1)},__calc:function(){var t=this.letterSpacing>>0,e=this.w/(this.__uw+t)>>0;1>e&&(this.w=1.5*this.__uw,e=1);for(var i=this.font,s=this.text.split("\n"),n=[],o=0,a=s.length;a>o;o++){var r=s[o];if(r)for(var h=r.length,c=0;h>c;){var l=r.substr(c,e+1),u=i.getBounds(l).w+l.length*t;if(u>this.w){for(var d=e+1;d--;)if(l=l.substr(0,l.length-1),u=i.getBounds(l).w+l.length*t,u<=this.w){if(0===u)return;n.push(l),c+=l.length;break}}else{for(var f=c,d=1;h-c>d;d++){if(l=r.substr(c,e+1+d),u=i.getBounds(l).w+l.length*t,u>this.w){n.push(l.substr(0,l.length-1)),c+=l.length-1;break}if(l===r){e=r.length-1;break}}if(c===f){l=r.substr(c,e+1),n.push(l);break}}}else n.push("")}return n}}),soya2d.Game=function(t){function i(t){d.running&&(l=requestAFrame(function(e){0===f&&(f=e);var s=e-f;if(f=e,p>c){var n=Date.now();t&&t(n,s),p%=c}p+=s,i(t)}))}t=t||{};var s=t.container||document.body;"string"==typeof s&&(s=document.querySelector(s));var o=(t.rendererType||soya2d.RENDERER_TYPE_CANVAS,s.offsetWidth||100),a=s.offsetHeight||100,r=null;r=new soya2d.CanvasRenderer({smoothEnable:t.smoothEnable,autoClear:t.autoClear,container:s,sortEnable:!0,w:t.w||o,h:t.h||a}),soya2d.ext(this,t),this.renderer=r,this.objects=new m(this),this.add=new y(this),this.scene=new u(this),this.stage=new U({game:this,w:r.w,h:r.h}),this.world=new z({game:this,w:r.w,h:r.h}),this.stage.add(this.world),this.camera=new e(r.w,r.h,this),this.assets=new n,this.load=new B(this),this.timer=new F,this.physics=new j,this.w=r.w,this.h=r.h,this.running=!1,this.input={pointer:{changeType:function(t){h.changeType(t)}},keyboard:{},device:{}};var h=new P(K);this.__pointerSignal=new N,this.start=function(){if(!this.running){this.running=!0,this.stage.__scan(this.w,this.h,s,r);var t=soya2d.module._getAll(),e=[],n=[],o=[],a=[];for(var l in t)t[l].onStart&&t[l].onStart(this),t[l].onBeforeUpdate&&e.push([t[l],t[l].onBeforeUpdate]),t[l].onPostUpdate&&n.push([t[l],t[l].onPostUpdate]),t[l].onBeforeRender&&o.push([t[l],t[l].onBeforeRender]),t[l].onPostRender&&a.push([t[l],t[l].onPostRender]);return h.start(this),W.start(this),q.start(this),c=1e3/g,i(function(t,i){e.forEach(function(e){e[1].call(e[0],d,t,i)}),d.physics.running&&d.physics.update(),d.camera.__onUpdate(),d.timer.__scan(i),h.scan(d),W.scan(d),q.scan(d),d.currentScene.onUpdate&&d.currentScene.onUpdate(d,i),d.stage.__preUpdate(d,i),d.stage.__updateMatrix(),d.stage.__postUpdate(d,i),n.length>0&&(t=Date.now(),n.forEach(function(e){e[1].call(e[0],d,t,i)})),h.clear(),W.clear(),q.clear(),d.camera.__cull(d.stage),d.camera.__viewport(d.world),o.length>0&&(t=Date.now(),o.forEach(function(e){e[1].call(e[0],d,t,i)}));var s=r.render(d.stage,d.camera);a.length>0&&(t=Date.now(),a.forEach(function(e){e[1].call(e[0],d,t,i,s)}))}),this}};var c,l,d=this,f=0,_=60,g=60,p=0;this.setFPS=function(t){return g=parseInt(t)||_,g=g>_?_:g,c=1e3/g,this},this.stop=function(){cancelAFrame(l),this.running=!1;var t=soya2d.module._getAll();for(var e in t)t[e].onStop&&t[e].onStop(this);return this},this.destroy=function(){this.running&&this.stop();var t=soya2d.module._getAll();for(var e in t)t[e].onDestroy&&t[e].onDestroy(this);this.renderer.destroy(),this.stage.destroy();var i=soya2d.games.indexOf(this);i>-1&&soya2d.games.splice(i,1)};var v=soya2d.module._getAll(),w=0;for(var x in v)v[x].onInit&&v[x].onInit(this),w++;this.objects.register("shape",soya2d.Shape),this.objects.register("sprite",soya2d.Sprite),this.objects.register("tileSprite",soya2d.TileSprite),this.objects.register("group",soya2d.DisplayObjectContainer),this.objects.register("text",soya2d.Text),this.objects.register("button",soya2d.Button);var b="soya2d Game instance created...",T=w+" plugins loaded...";soya2d.console.info(b),soya2d.console.info(T),soya2d.games.push(this)},soya2d.games=[];var X="soya2d "+soya2d.version.toString()+" is working...",Y="==== thank you for using soya2d, you'll love it! ====";soya2d.console.info(X),soya2d.console.info(Y),soya2d.RENDERER_TYPE_AUTO=1,soya2d.RENDERER_TYPE_CANVAS=2,soya2d.RENDERER_TYPE_WEBGL=3;var H=new N;soya2d.KeyCode={DELETE:46,BACKSPACE:8,TAB:9,ENTER:13,SHIFT:16,CONTROL:17,ALT:18,ESC:27,SPACE:32,LEFT:37,UP:38,RIGHT:39,DOWN:40,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,a:97,b:98,c:99,d:100,e:101,f:102,g:103,h:104,i:105,j:106,k:107,l:108,m:109,n:110,o:111,p:112,q:113,r:114,s:115,t:116,u:117,v:118,w:119,x:120,y:121,z:122,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,"[":219,"]":221,"\\":220,"=":187,"-":189,",":188,".":190,"/":191,";":186,"'":222},P.prototype={setEvent:function(t,e){this.eventMap[t]=e},clear:function(){for(var t in this.eventMap)this.eventMap[t]=null;this.eventMap={}},start:function(t){this.onInit(t)},scan:function(t){this.onScan(t)}};var K={onInit:function(t){var e=t.renderer.getCanvas();this.cvs=e,this.fn_md=this.doMousedown.bind(this),this.fn_mm=this.doMousemove.bind(this),this.fn_mu=this.doMouseup.bind(this),this.fn_mo=this.doMouseout.bind(this),this.fn_mov=this.doMouseover.bind(this),this.fn_ts=this.doStart.bind(this),this.fn_tm=this.doMove.bind(this),this.fn_te=this.doEnd.bind(this),this.fn_tc=this.doCancel.bind(this),soya2d.Device.mobile?this.bindTouch(e):this.bindMouse(e),this.lastTapTime=0,this.lastClickTime=0,this.inList=[],this.pressStartTime=0},bindMouse:function(t){this.pointerType="mouse",t.addEventListener("mousedown",this.fn_md,!0),t.addEventListener("mousemove",this.fn_mm,!0),t.addEventListener("mouseup",this.fn_mu,!0),window.addEventListener("blur",this.fn_tc,!0),t.addEventListener("mouseout",this.fn_mo,!0),t.addEventListener("mouseover",this.fn_mov,!0)},bindTouch:function(t){this.pointerType="touch",t.addEventListener("touchstart",this.fn_ts,!0),t.addEventListener("touchmove",this.fn_tm,!0),t.addEventListener("touchend",this.fn_te,!0),t.addEventListener("touchcancel",this.fn_tc,!0)},changeType:function(t){if(this.pointerType!=t){var e=this.cvs;switch(this.pressing=!1,t){case"mouse":e.removeEventListener("touchstart",this.fn_ts,!0),e.removeEventListener("touchmove",this.fn_tm,!0),e.removeEventListener("touchend",this.fn_te,!0),e.removeEventListener("touchcancel",this.fn_tc,!0),this.bindMouse(e);break;case"touch":e.removeEventListener("mousedown",this.fn_md,!0),e.removeEventListener("mousemove",this.fn_mm,!0),e.removeEventListener("mouseup",this.fn_mu,!0),window.removeEventListener("blur",this.fn_tc,!0),e.removeEventListener("mouseout",this.fn_mo,!0),e.removeEventListener("mouseover",this.fn_mov,!0),this.bindTouch(e)}}},onScan:function(t){var e=t.input.pointer,i=t.renderer,s=t.__pointerSignal,n=!1,o=!1,a=!1,r=null;if(this.eventMap.down&&(n=!0,r=this.eventMap.down),this.eventMap.up&&(o=!0,r=this.eventMap.up),this.eventMap.move&&(a=!0,r=this.eventMap.move),this.eventMap.tap&&(r=this.eventMap.tap),this.eventMap.dbltap&&(r=this.eventMap.dbltap),this.eventMap.enterstage&&(r=this.eventMap.enterstage),this.eventMap.leavestage&&(r=this.eventMap.leavestage),this.eventMap.cancel&&(r=this.eventMap.cancel),e.isDown=n,e.isUp=o,e.isMove=a,e.isPressing=this.pressing||!1,e.duration=0==this.pressStartTime?0:Date.now()-this.pressStartTime,e.e=r,e.touches=[],e.position=e.position?e.position:{},r){if(r.changedTouches){var h=this.handleTouches(r,r.changedTouches,t);if(e.position=h[0],e.touches=h,a)for(var c=h.length;c--&&!this.handleOverOut(r,h[c],s););}else{e.button={left:0==r.button||1==r.button,right:2==r.button,middle:4==r.button||2==r.which};var l=(r.offsetX||r.layerX)/i.hr,u=(r.offsetY||r.layerY)/i.vr;e.position=new soya2d.Point(l,u),a&&this.handleOverOut(r,e.position,s)}this.eventMap.down&&s.__emitPointer("pointerdown",e,r,e.position,e.touches),this.eventMap.up&&s.__emitPointer("pointerup",e,r,e.position,e.touches),this.eventMap.move&&s.__emitPointer("pointermove",e,r,e.position,e.touches),this.eventMap.tap&&s.__emitPointer("pointertap",e,r,e.position,e.touches),this.eventMap.dbltap&&s.__emitPointer("pointerdbltap",e,r,e.position,e.touches),this.eventMap.enterstage&&s.emit("enterstage",e,r),this.eventMap.leavestage&&s.emit("leavestage",e,r),this.eventMap.cancel&&s.emit("pointercancel",e,r)}},handleOverOut:function(t,e,i){var s=i.__sigmap,n=s.pointerover,o=s.pointerout,a={},r={},h={};if(n&&n.forEach(function(t){var e=t[1].roid;r[e]||(r[e]=[]),h[e]=t[1],r[e].push(t[0])}),o&&o.forEach(function(t){var e=t[1].roid;a[e]||(a[e]=[]),h[e]=t[1],a[e].push(t[0])}),Object.keys(r).length>0){var c=[],l=!1;for(var u in r){var d=r[u],f=h[u];f.hitTest&&f.hitTest(e.x,e.y)&&!f.events.disabled&&(c.push(f),this.inList.indexOf(f)>-1||(this.inList.push(f),d.forEach(function(e){e.call(f,t)}),l=!0))}var _=[];if(this.inList.forEach(function(t){c.indexOf(t)<0&&_.push(t)}),_.length<1)return;for(var g=_.length;g--;){var p=this.inList.indexOf(_[g]);this.inList.splice(p,1);var m=_[g];if(m.events&&!m.events.disabled){for(var y=a[m.roid],v=y.length;v--;)y[v].call(m,t);l=!0}}return l}},doMousedown:function(t){this.setEvent("down",t),this.pressing=!0,this.pressStartTime=Date.now(),this.canceled=!1},doMousemove:function(t){this.setEvent("move",t)},doMouseup:function(t){this.pressing=!1,this.pressStartTime=0,this.setEvent("up",t),this.canceled||0===t.button&&(this.setEvent("tap",t),Date.now()-this.lastClickTime<300&&this.setEvent("dbltap",t),this.lastClickTime=Date.now())},doMouseover:function(t){this.setEvent("enterstage",t)},doMouseout:function(t){this.setEvent("leavestage",t)},handleTouches:function(t,e,i){var s=[],n=[];if(e&&e.length>0){for(var o=t.target||t.srcElement,a=o.offsetLeft,r=o.offsetTop;(o=o.offsetParent)&&"BODY"!=o.tagName;)a+=o.offsetLeft-o.scrollLeft,r+=o.offsetTop-o.scrollTop;for(var h=document.body.scrollTop||document.documentElement.scrollTop,c=document.body.scrollLeft||document.documentElement.scrollLeft,l=0;l<e.length;l++){var u=e[l];s[l]=u.clientX-a+c,s[l+1]=u.clientY-r+h}}var d=i.renderer,f=d.getCanvas(),_=window.getComputedStyle(f,null).marginLeft;_=parseFloat(_)||0;var g=window.getComputedStyle(f,null).marginTop;g=parseFloat(g)||0;for(var l=0;l<s.length;l+=2){var p=s[l],m=s[l+1];switch(i.stage.rotateMode){case soya2d.ROTATEMODE_90:p=p+f.offsetLeft-g,m=m+f.offsetTop-_;var y=p;p=m,m=thisGame.stage.w-Math.abs(y);break;case soya2d.ROTATEMODE_270:p=p+f.offsetLeft-g,m=m+f.offsetTop-_;var y=m;m=p,p=thisGame.stage.h-Math.abs(y);break;case soya2d.ROTATEMODE_180:p=thisGame.stage.w-Math.abs(p),m=thisGame.stage.h-Math.abs(m)}p/=d.hr,m/=d.vr,n.push(new soya2d.Point(p,m))}return n},doStart:function(t){this.setEvent("down",t),this.pressing=!0,this.pressStartTime=Date.now(),this.hasMoved=!1,this.canceled=!1},doMove:function(t){this.setEvent("move",t),this.hasMoved=!0},doCancel:function(t){this.canceled=!0,this.setEvent("cancel",t),this.pressing=!1,this.pressStartTime=0},doEnd:function(t){this.setEvent("up",t),t.touches.length<1&&(this.pressing=!1,this.pressStartTime=0),this.canceled||this.hasMoved||(this.setEvent("tap",t),Date.now()-this.lastTapTime<300&&this.setEvent("dbltap",t),this.lastTapTime=Date.now())}},W=new P({onInit:function(){window.addEventListener("keyup",this.doKeyUp.bind(this),!1),window.addEventListener("keydown",this.doKeyDown.bind(this),!1),window.addEventListener("blur",this.doBlur.bind(this),!1),this.preesingKeys=[],this.pressing=!1,this.lastEv=null},onScan:function(t){var e=t.input.keyboard,i=!1,s=!1,n=this.lastEv;this.eventMap.down?(i=!0,this.lastEv=n=this.eventMap.down,H.emit("keydown",e,n)):this.eventMap.up&&(s=!0,this.lastEv=n=this.eventMap.up,H.emit("keyup",e,n)),this.pressing&&H.emit("keypress",e,n),e.isDown=i,e.isUp=s,e.isPressing=this.pressing,e.e=n,e.shiftKey=n?n.shiftKey:!1,e.metaKey=n?n.metaKey:!1,e.ctrlKey=n?n.ctrlKey:!1,e.altKey=n?n.altKey:!1,e.keys=this.preesingKeys},doKeyUp:function(t){var e=this.preesingKeys,i=t.keyCode||t.which,s=e.indexOf(i);s>-1&&e.splice(s,1),e.length<1&&(this.pressing=!1),this.setEvent("up",t)},doKeyDown:function(t){var e=this.preesingKeys,i=t.keyCode||t.which;e.indexOf(i)<0&&(e.push(i),this.pressing=!0,this.setEvent("down",t))},doBlur:function(){this.preesingKeys=[],this.pressing=!1}}),q=new P({onInit:function(){window.addEventListener("orientationchange",this.doHOV.bind(this),!1),window.addEventListener("deviceorientation",this.doTilt.bind(this),!1),window.addEventListener("devicemotion",this.doMotion.bind(this),!1)},onScan:function(t){var e=t.input.device,i=null;if(this.eventMap.hov){i=this.eventMap.hov,this.timer&&clearTimeout(this.timer);var s=this;this.timer=setTimeout(function(){var t=s.getOrientation();e.orientation=t,H.emit("hov",e,t)},500)}if(this.eventMap.tilt){i=this.eventMap.tilt;var n={z:i.alpha,x:i.beta,y:i.gamma,absolute:i.absolute};e.tilt=n,H.emit("tilt",e,n)}if(this.eventMap.motion){i=this.eventMap.motion;var o={x:i.acceleration.x,y:i.acceleration.y,z:i.acceleration.z,interval:i.interval};e.motion=o,H.emit("motion",e,o)}e.e=i},getOrientation:function(){var t,e=window.innerWidth,i=window.innerHeight;return t=e>i?"landscape":"portrait"},doHOV:function(t){this.setEvent("hov",t)},doTilt:function(t){this.setEvent("tilt",t)},doMotion:function(t){this.setEvent("motion",t)}})}(window||this);