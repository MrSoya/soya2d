/*
 * Soya2D is a web interactive animation(game) engine for modern web browsers 
 *
 *
 * Copyright 2015-2016 MrSoya and other contributors
 * Released under the MIT license
 *
 * website: http://soya2d.com
 * last build: 2016-09-02
 */
!function(t){"use strict";function e(t,e,i){Object.defineProperties(this,{x:{set:function(t){this.__view.x=t,this.__checkBounds()},get:function(){return this.__view.x}},y:{set:function(t){this.__view.y=t,this.__checkBounds()},get:function(){return this.__view.y}},w:{get:function(){return this.__view.w}},h:{get:function(){return this.__view.h}}}),this.freezone=null,this.__view=new soya2d.Rectangle(0,0,t,e),this.__game=i}function i(t,e){if(t.__renderable){if(t.__fixedToCamera)return;if(!e.intersectWith(t.getBoundingBox()))return t.__renderable=!1,void 0;if(t.children)for(var s=t.children.length;s--;){var n=t.children[s];n.__renderable&&i(n,e)}}}function s(t,e,i){if(t.__renderable){var n=null,a=null;if(t.__fixedToCamera){var n=t.cameraOffset.x+t.anchorPosition.x,a=t.cameraOffset.y+t.anchorPosition.y;i=!0}else i?(n=t.parent.__screenPosition.x-t.parent.anchorPosition.x+t.x+t.anchorPosition.x,a=t.parent.__screenPosition.y-t.parent.anchorPosition.y+t.y+t.anchorPosition.y):(n=t.worldPosition.x,a=t.worldPosition.y,n-=e.x,a-=e.y);if(t.__screenPosition.set(n,a),t.children)for(var r=t.children.length;r--;){var o=t.children[r];o.__renderable&&s(o,e,i)}}}function n(){this.__assets={image:{},sound:{},imageFont:{},atlas:{},text:{},xml:{},json:{}}}function a(){}function r(){this.map={}}function o(t,e,i,s,n){var a=new XMLHttpRequest;a.open("get",t,!0),a.timeout=e,a.ontimeout=i,a.onerror=s,null===a.onload?a.onload=function(){(0===a.status||a.status>=200&&a.status<300||304===a.status)&&n(a)}:a.onreadystatechange=function(){(0===a.status||(a.status>=200&&a.status<300||304===a.status)&&4===a.readyState)&&n(a)},a.send(null)}function h(t,e,i,s,n,a,r,o){setTimeout(function(){if((new Date).getTime()-t>e)return a(o),void 0;for(var c in i){i[c].style.left="-1000px";var l=i[c].offsetWidth,u=i[c].offsetHeight;if(l!==s[c]||u!==n[c])return r(o),void 0}h(t,e,i,s,n,a,r,o)},20)}function c(t,e){soya2d.ext(this,t),this.map={},this.game=e}function l(t,e,i,s){for(var n=0;n<e.children.length;n++){var a=e.children[n],r=a.tagName,o=a.attributes.id?a.attributes.id.value:null,h=u(a.attributes,i),c=h.atlas;if("sprite"===r&&c){var d=h["atlas-prefix"];h.images=s.assets.atlas(c).getAll(d)}if("text"===r){for(var c=h.atlas,g="",y=0;y<a.childNodes.length;y++)3===a.childNodes[y].nodeType&&(g+=a.childNodes[y].nodeValue);h.text=g.replace(/(^\s+)|(\s+$)/gm,""),c&&(h.font=s.assets.atlas(c)),h.size=parseInt(h.size)}var m=_(r,h,s);f(a.attributes,m,t),o&&(t.map[o]=m),i.add(m),a.children.length>0&&l(t,a,m,s)}}function u(t,e){for(var i={},s=Object.keys(t),n=s.length;n--;){var a=s[n],r=t[a].name;0===r.indexOf("layout-")?(i.layout||(i.layout={}),i.layout[r.split("-")[1]]=d(r,t[a].value,e)):i[r]=d(r,t[a].value,e)}return i}function f(t,e,i){for(var s=Object.keys(t),n=s.length;n--;){var a=s[n],r=t[a].name,o=t[a].value;if(0===r.indexOf("on-")){var h=r.substr(3),c=i[o];c instanceof Function?e.on(h,c):soya2d.console.warn('invalid callback "'+o+'" of '+r)}}}function d(t,e){switch(t){case"x":case"w":case"y":case"h":case"z":case"angle":case"scaleX":case"scaleY":case"skewX":case"skewY":case"scrollAngle":case"speed":case"frameRate":case"frameIndex":case"letterSpacing":case"lineSpacing":return parseFloat(e);case"visible":case"autoScroll":case"loop":case"autoplay":case"fixedToCamera":return new Function("return "+e)();default:return e}}function _(t,e,i){var s=new i.objects.map[t](e);return s}function g(t){this.map={},this.game=t}function y(t){this.exp=t,this.times=0,this.priority=0,this.milliseconds=0,this._lastTriggerMilliseconds=-1e3,this._t=[],this._reset=function(){this.times=0,this.milliseconds=0,this._lastTriggerMilliseconds=-1e3,this._t=[],delete this._frameInfo,delete this._timeInfo},this._canUnload=function(){var t=this._timeInfo.hour;if(1===t[2]){if(this._t[2]>t[0])return!0}else if(t[2]>1&&this._t[2]>t[3][t[3].length-1])return!0},this.canTrigger=function(){return p(this)},/^(\*|(?:[0-9]+(?:,[0-9]+)*)|(?:[0-9]+-[0-9]+)|(?:(?:(?:[0-9]+(?:-[0-9]+)?)|\*)\/[0-9]+)) (\*|(?:[0-9]+(?:,[0-9]+)*)|(?:[0-9]+-[0-9]+)|(?:(?:(?:[0-9]+(?:-[0-9]+)?)|\*)\/[0-9]+)) (\*|(?:[0-9]+(?:,[0-9]+)*)|(?:[0-9]+-[0-9]+)|(?:(?:(?:[0-9]+(?:-[0-9]+)?)|\*)\/[0-9]+))$/.test(t)||soya2d.console.error("invalid timer expression -- "+t);var e=m(RegExp.$1),i=m(RegExp.$2),s=m(RegExp.$3);this._timeInfo={sec:e,min:i,hour:s}}function m(t){var e,i,s,n,a;if("*"==t)e=-1,i=0,s=-1;else if((i=parseInt(t))==t)s=1,e=0;else if(2===(a=t.split("/")).length){e=parseInt(a[1]);var r;if(2===(r=a[0].split("-")).length){n=[];for(var o=r[0]>>0,h=r[1]>>0;h>=o;o++)n.push(o);n.sort(function(t,e){return t-e}),s=n.length}else(i=parseInt(a[0]))||(i=0),s=-1}else if((a=t.split(",")).length>1){n=[];for(var e=a.length;e--;)n.push(a[e]>>0);n.sort(function(t,e){return t-e}),s=a.length}else if(2===(a=t.split("-")).length){n=[];for(var o=a[0]>>0,h=a[1]>>0;h>=o;o++)n.push(o);n.sort(function(t,e){return t-e}),s=n.length}return[e,i,s,n]}function p(t){var e=t.milliseconds/1e3,i=t._t[0]=e%60>>0,s=t._t[1]=e/60%60>>0,n=t._t[2]=e/60/60>>0;return v(t._timeInfo.hour,n)?v(t._timeInfo.min,s)?v(t._timeInfo.sec,i)?!0:!1:!1:!1}function v(t,e){if(1===t[2]){if(t[1]!==e)return!1}else if(-1===t[2]&&-1===t[0]);else if(t[3]&&!t[0]){if(t[3].indexOf(e)<0)return!1}else if(-1===t[2]&&t[0]>0||t[0]>0&&t[3]){if(t[3]&&t[3].indexOf(e)<0)return!1;var i=e-t[1];if(0>=i&&0!=t[1])return!1;if(i%t[0])return!1}return!0}function w(t){this.map={},this.game=t}function x(t){this.game=t,this.__newInstanceAndAppend=function(t,e){e.game=this.game;var i=new this.game.objects.map[t](e);return this.game.world.add(i),i}}function b(t,e){if(/^(-?\d+)%$/.test(t)){var i=parseFloat(RegExp.$1)/100;return A(e,i)}return t}function T(t,e){if(/^(-?\d+)%$/.test(t)){var i=parseFloat(RegExp.$1)/100;return O(e,i)}return t}function E(t,e){if(!isNaN(t))return parseFloat(t);var i=e,s=0;return/^(-?\d+)%$/.test(t)&&(s=parseFloat(RegExp.$1)/100),i*s}function A(t,e){var i=t.w;return 0===i&&t.parent?A(t.parent,e):i*e}function O(t,e){var i=t.h;return 0===i&&t.parent?O(t.parent,e):i*e}function R(t,e,i){for(var s=t.children.length;s--;){var n=t.children[s];e(n)&&i.push(n),n.children&&n.children.length>0&&R(n,e,i)}}function S(t){if(t.transform(),t.__renderable=!0,t.children)for(var e=t.children.length;e--;){var i=t.children[e];i.visible&&S(i)}}function C(t,e,i){for(var s=t.length;s--;){var n=t[s];n._onUpdate&&n._onUpdate(e,i),n.onUpdate&&n.onUpdate(e,i),n.children&&n.children.length>0&&C(n.children,e,i)}}function k(t,e,i){for(var s=t.length;s--;){var n=t[s];n._onPostUpdate&&n._onPostUpdate(e,i),n.onPostUpdate&&n.onPostUpdate(e,i),n.children&&n.children.length>0&&k(n.children,e,i)}}function I(t,e,i,s,n){var a;switch(e){case soya2d.ROTATEMODE_90:a="rotate(90deg)";break;case soya2d.ROTATEMODE_180:a="rotate(180deg)";break;case soya2d.ROTATEMODE_270:a="rotate(270deg)";break;case soya2d.ROTATEMODE_0:default:a="rotate(0deg)",n.__rotat=soya2d.ROTATEMODE_0}if(i.style.transform=i.style.webkitTransform=i.style.mozTransform=i.style.msTransform=i.style.oTransform=a,i.style.left=i.style.top=0,e===soya2d.ROTATEMODE_90||e===soya2d.ROTATEMODE_270){var r=i.offsetWidth,o=i.offsetHeight;if(t===soya2d.SCALEMODE_NOBORDER){var h=this.game.w,c=this.game.h;r=r>c?c:r,o=o>h?h:o}if(s.resize(o,r),t===soya2d.SCALEMODE_EXACTFIT){var l=(r-o)/2;l=o%2===0?l:Math.floor(l);var u=(o-r)/2;u=r%2===0?u:Math.floor(u),i.style.left=l+"px",i.style.top=u+"px"}}}function M(){var t,e=window.innerWidth,i=window.innerHeight;return t=e>i?"landscape":"portrait"}function D(t,e,i,s,n,a,r,o){i=r&&i>r?r:i,s=o&&s>o?o:s;var h=Math.max(i/t,s/e),c=t*h,l=e*h;return[c,l]}function L(t,e,i,s,n,a,r,o){i=r&&i>r?r:i,s=o&&s>o?o:s;var h=1;(t>i||e>s)&&(h=Math.min(i/t,s/e));var c=t*h,l=e*h;return[c,l]}function P(t,e,i,s,n,a,r,o){var h,c;return h=n&&n>i?n:r&&i>r?r:i,c=a&&a>s?a:o&&s>o?o:s,[h,c]}function N(t,e,i){this.frames=t,this.index=0,this.lastUpdateTime=0,this.frameRate=e||10,this.loop=i===!1?!1:i||!0}t.soya2d=new function(){function t(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,t.prototype._super=e.prototype}this.__roIndex=0,this.version={v:[2,0,0],state:"beta2",toString:function(){return soya2d.version.v.join(".")+" "+soya2d.version.state}},this.website="http://soya2d.com",this.ext=function(t,e,i){for(var s=Object.keys(e),n=s.length;n--;){var a=s[n];(!t.hasOwnProperty(a)||i)&&(t[a]=e[a])}},this.class=function(e,i){var s=i.constructor,n=i.extends,a=function(){n&&n.apply(this,arguments),s&&s.apply(this,arguments)};n&&t(a,n);for(var r in i)"extends"!==r&&"constructor"!==r&&(a.prototype[r]=i[r]);if(e){var o=e.split("."),h=o[o.length-1],c=self;if(o.length>1)for(var l=0;l<o.length;l++)o[l]!==h&&(c=c[o[l]],c||(c={}));c[h]=a,a.prototype.class=e}return a},this.module=new function(){var t={};this.install=function(e,i){t[e]=i},this._getAll=function(){return t}},this.render=function(t,e,i,s){var n=new soya2d.Game({w:e,h:i,container:t});return n.start(),n.scene.start(s),n}},t.soya=soya2d,self.Int8Array=self.Int8Array||Array,self.Uint8Array=self.Uint8Array||Array,self.Int16Array=self.Int16Array||Array,self.Uint16Array=self.Uint16Array||Array,self.Int32Array=self.Int32Array||Array,self.Uint32Array=self.Uint32Array||Array,self.Float32Array=self.Float32Array||Array,self.console=self.console||new function(){this.log=function(){},this.info=function(){},this.debug=function(){},this.error=function(){},this.warn=function(){}},soya2d.console=new function(){var t=1;this.level=function(e){t=0==e?0:e||1},this.debug=function(e,i){1==t&&(soya2d.Device.ie?console.debug(e):console.debug("%c"+e,i||"padding:1px 50px;font-size:14px;color:#fff;background:#0069D6;"))},this.info=function(e,i){1>t||t>2||(soya2d.Device.ie?console.log(e):console.log("%c"+e,i||"padding:1px 50px;font-size:14px;color:#fff;background:#2DB008;"))},this.warn=function(e,i){1>t||t>3||(soya2d.Device.ie?console.warn(e):console.warn("%c"+e,i||"padding:1px 50px;font-size:14px;color:#fff;background:#FFB502;"))},this.error=function(e,i){1>t||(soya2d.Device.ie?console.error(e):console.error("%c"+e,i||"padding:1px 50px;font-size:14px;color:#fff;background:#ff0000;"))}},self.cancelAFrame=function(t){return t.cancelAnimationFrame||t.webkitCancelRequestAnimationFrame||t.msCancelRequestAnimationFrame||t.mozCancelRequestAnimationFrame||t.oCancelRequestAnimationFrame||t.clearTimeout}(self),self.requestAFrame=function(t){return t.requestAnimationFrame||t.webkitRequestAnimationFrame||t.msRequestAnimationFrame||t.mozRequestAnimationFrame||t.oRequestAnimationFrame||function(e){return t.setTimeout(function(){e(Date.now())},16.7)}}(self),soya2d.BLEND_NORMAL="source-over",soya2d.BLEND_LIGHTER="lighter",soya2d.BLEND_MASK="destination-in",soya2d.BLEND_CLEAR="destination-out",soya2d.LINECAP_BUTT="butt",soya2d.LINECAP_ROUND="round",soya2d.LINECAP_SQUARE="square",soya2d.LINEJOIN_BEVEL="bevel",soya2d.LINEJOIN_ROUND="round",soya2d.LINEJOIN_MITER="miter",soya2d.TEXTALIGN_LEFT="left",soya2d.TEXTALIGN_CENTER="center",soya2d.TEXTALIGN_RIGHT="right",soya2d.TEXTVALIGN_TOP="hanging",soya2d.TEXTVALIGN_MIDDLE="middle",soya2d.TEXTVALIGN_BOTTOM="alphabetic",soya2d.TEXTDIR_LTR="ltr",soya2d.TEXTDIR_RTL="rtl",soya2d.GRADIENT_LINEAR=1,soya2d.GRADIENT_RADIAL=2,e.prototype={follow:function(t){var e=this.__game.world.find(function(e){return t.roid===e.roid?!0:void 0},!0);e.length<0&&soya2d.console.error("camera: "+t.toString()+" must be a child node of game.world"),this.target=t},unfollow:function(){this.target=null},moveTo:function(t,e){this.target||(this.__view.x=t,this.__view.y=e,this.__checkBounds())},moveBy:function(t,e){this.target||(this.__view.x+=t,this.__view.y+=e,this.__checkBounds())},reset:function(){this.__view.x=this.__view.y=0},__checkBounds:function(){var t=this.__game.world.bounds,e=t.x,i=t.y,s=t.w,n=t.h,a=this.__view.x;e>a&&(this.__view.x=e),s>0&&a+this.__view.w>s&&(this.__view.x=s-this.__view.w);var r=this.__view.y;i>r&&(this.__view.y=i),n>0&&r+this.__view.h>n&&(this.__view.y=n-this.__view.h)},setFreezone:function(t){t&&(this.freezone=t)},__onUpdate:function(){if(this.target&&this.target.game){var t,e,i=this.target.worldPosition;t=i.x,e=i.y;{var s=this.target.w,n=this.target.h;t-this.__view.x,e-this.__view.y}if(this.freezone){var a=this.freezone.x,r=this.freezone.y,o=this.freezone.w,h=this.freezone.h,c=this.__view.x+a,l=this.__view.y+r,u=this.__view.x+a+o,f=this.__view.y+r+h,d=s/2,_=n/2;c>t-d?this.__view.x=t-a-d:t+d>u&&(this.__view.x=t-o-a+d),l>e-_?this.__view.y=e-r-_:e+_>f&&(this.__view.y=e-h-r+_)}else this.__view.x=t-this.__view.w/2,this.__view.y=e-this.__view.h/2;this.__checkBounds()}},__cull:function(t){for(var e=t.children,s=e.length;s--;)i(e[s],this.__view)},__viewport:function(t){for(var e=t.children,i=e.length;i--;)s(e[i],this.__view)}},soya2d.Math={PI:3.141592654,PIM2:6.283185307,PID2:1.570796327,PID4:.785398163,ONERAD:.017453292,ONEANG:57.295779513,toRadian:function(t){return t*this.ONERAD},toAngle:function(t){return t*this.ONEANG},randomf:function(t,e){return t+Math.random()*(e-t)},randomi:function(t,e){return t+Math.random()*(e-t)>>0},round:function(t){return.5+t>>0},floor:function(t){return 0|t},len2D:function(t,e,i,s){return Math.sqrt((s-e)*(s-e)+(i-t)*(i-t))},len2Df:function(t,e){t=Math.abs(t),e=Math.abs(e);var i=Math.min(t,e);return t+e-(i>>1)-(i>>2)+(i>>4)},SINTABLE:function(){for(var t=new Float32Array(361),e=.017453292,i=0;360>=i;i++){var s=i*e,n=Math.sin(s);t[i]=n}return t}(),COSTABLE:function(){for(var t=new Float32Array(361),e=.017453292,i=0;360>=i;i++){var s=i*e,n=Math.cos(s);t[i]=n}return t}()},n.prototype={image:function(t){return this.__assets.image[t]},sound:function(t){return this.__assets.sound[t]},imageFont:function(t){return this.__assets.imageFont[t]},atlas:function(t){return this.__assets.atlas[t]},text:function(t){return this.__assets.text[t]},xml:function(t){return this.__assets.xml[t]},json:function(t){return this.__assets.json[t]}},soya2d.Atlas=function(t,e){this.texs={},e.forEach(function(e){var i=document.createElement("canvas");i.width=e.w,i.height=e.h;var s=i.getContext("2d");s.translate(e.w/2,e.h/2),s.rotate((e.r||0)*Math.PI/180);var n=e.w>>0,a=e.h>>0;return 0===n||0===a?(soya2d.console.error("soya2d.Atlas: invalid ssheet unit，w/h must be a positive;[w:"+n+",h:"+a+"] "),void 0):(s.drawImage(t,e.x>>0,e.y>>0,n,a,-n/2>>0,-a/2>>0,n,a),this.texs[e.n]=i,void 0)},this)},soya2d.Atlas.prototype={getAll:function(t){var e=[];for(var i in this.texs)(!t||"*"===t||t&&0===i.indexOf(t))&&e.push(this.texs[i]);return e},getByIndex:function(t,e){for(var i=[],s=Object.keys(this.texs),n=t;e>=n;n++){var a=this.texs[s[n]];i.push(a)}return i},get:function(t){return this.texs[t]},destroy:function(){this.texs=null}},a.prototype={on:function(t,e,i){if(this instanceof soya2d.DisplayObject)switch(t){case"pointdown":t=soya2d.Device.mobile?"touchstart":"mousedown";break;case"pointmove":t=soya2d.Device.mobile?"touchmove":"mousemove";break;case"pointup":t=soya2d.Device.mobile?"touchend":"mouseup"}return this.__signalHandler.on(t,e,i,this),this},once:function(t,e,i){return this.__signalHandler.once(t,e,i,this),this},off:function(t,e){return this.__signalHandler.off(t,e,this),this},emit:function(){for(var t=[arguments[0],this],e=1;e<arguments.length;e++)t.push(arguments[e]);return this.__signalHandler.emit.apply(this.__signalHandler,t),this}},r.prototype={on:function(t,e,i,s){for(var n=t.replace(/\s+/gm," ").split(" "),a=n.length;a--;){var r=this.map[n[a]];r||(r=this.map[n[a]]=[]),r.push([e,s,i])}},once:function(t,e,i,s){for(var n=t.replace(/\s+/gm," ").split(" "),a=n.length;a--;){var r=this.map[n[a]];r||(r=this.map[n[a]]=[]),r.push([e,s,i,!0])}},off:function(t,e,i){var s=null;s=t?t.replace(/\s+/gm," ").split(" "):Object.keys(this.map);for(var n=s.length;n--;){var a=this.map[s[n]];if(a){for(var r=[],o=a.length;o--;)i!==a[o][1]||(e?a[o][0]!==e:0)||r.push(a[o]);r.forEach(function(t){var e=a.indexOf(t);a.splice(e,1)})}}},emit:function(){var t=this.map[arguments[0]];if(t){for(var e=arguments[1],i=[e],s=2;s<arguments.length;s++)i.push(arguments[s]);t.sort(function(t,e){return e[2]-t[2]}),t.filter(function(t){t[1]===e&&t[0].apply(t[1],i)});var n=t.filter(function(t){return t[3]?void 0:!0});this.map[arguments[0]]=n}}};var B=soya2d.class("",{"extends":a,timeout:5e3,constructor:function(t){this.__signalHandler=new r,this.__assetsQueue=[],this.game=t,this.__assets=t.assets.__assets,this.baseUrl="";var e=!0;Object.defineProperties(this,{show:{set:function(t){e=t},get:function(){return e}},fillStyle:{set:function(t){this.__tip.fillStyle=t},get:function(){return this.__tip.fillStyle}}}),this.__logo=new soya2d.Shape({game:t,opacity:0,x:t.w/2-11,y:t.h/2-30-20,z:9999});var i=new soya2d.Shape({w:23,h:20,skewY:-30,game:t,fillStyle:"#69CA14",onRender:function(t){t.beginPath(),t.fillStyle(this.fillStyle),t.rect(0,0,this.w,this.h),t.fill(),t.closePath()}}),s=new soya2d.Shape({game:t,w:23,h:20,skewY:30,y:13,opacity:.9,fillStyle:"#2A5909",onRender:function(t){t.beginPath(),t.fillStyle(this.fillStyle),t.rect(0,0,this.w,this.h),t.fill(),t.closePath()}}),n=new soya2d.Shape({game:t,w:23,h:20,skewY:-30,y:28,blendMode:soya2d.BLEND_LIGHTER,fillStyle:"#69CA14",onRender:function(t){t.beginPath(),t.fillStyle(this.fillStyle),t.rect(0,0,this.w,this.h),t.fill(),t.closePath()}}),a=new soya2d.Font("normal 400 23px/normal Arial,Helvetica,sans-serif");this.__tip=new soya2d.Text({game:t,x:-70,y:70,font:a,text:"Loading... 0/0",w:200,fillStyle:"#000"}),this.__logo.add(i,s,n,this.__tip),t.world.add(this.__logo)},__addToAssets:function(t,e){for(var i in e)this.__assetsQueue.push({type:t,k:i,data:e[i],baseUrl:this.baseUrl})},image:function(t){var e=t;t instanceof Array&&(e={},t.forEach(function(t){var i=t.lastIndexOf("/")+1,s=t.lastIndexOf("."),n=t.substring(i,s);e[n]=t})),this.__addToAssets("image",e)},sound:function(t){this.__addToAssets("sound",t)},font:function(t){this.__addToAssets("font",t)},imageFont:function(t){this.__addToAssets("imageFont",t)},atlas:function(t){var e=t;if(4===arguments.length){e={};var i=arguments[0],s=arguments[1],n=arguments[2],a=arguments[3];e[i]=[s,n,a]}this.__addToAssets("atlas",e)},text:function(t){this.__addToAssets("text",t)},xml:function(t){this.__addToAssets("xml",t)},json:function(t){this.__addToAssets("json",t)},__loadImage:function(t,e,i){var s=new Image;void 0!==this.crossOrigin&&(s.crossOrigin=this.crossOrigin),s.path=e;s.onload=function(){i("load",this),this.onerror=null,this.onload=null},s.onerror=function(){i("error",this.path),this.onerror=null,this.onload=null},s.src=t+e,s.complete&&(i("load",s),s.onerror=null,s.onload=null)},__loadSound:function(t,e,i){for(var s=e instanceof Array?e:[e],n=s.length;n--;)s[n]=t+s[n];new Howl({src:s,onload:function(){var t=new soya2d.Sound;t.__handler=this,i("load",t)},onloaderror:function(t){var e=soya2d.MEDIA_ERR_DECODE;t&&(e=t.type),i("error",this._src,e)}})},__loadFont:function(t,e,i,s){for(var n=["serif","sans-serif"],a="border:none;position:absolute;top:-999px;left:-999px;font-size:100px;width:auto;height:auto;line-height:normal;margin:0;padding:0;font-variant:normal;white-space:nowrap;font-family:",r={},o={},c={},l=n.length;l--;){var u=document.createElement("div");u.style.cssText=a+"'"+n[l]+"'",u.innerHTML=e,document.body.appendChild(u),c[n[l]]=u,r[n[l]]=u.offsetWidth,o[n[l]]=u.offsetHeight}var f=document.createElement("style");f.id="FontLoader_"+(new Date).getTime(),f.innerHTML="@font-face {font-family: '"+e+"';src: url("+t+i+")}",document.head.appendChild(f);for(var l in c)c[l].style.fontFamily=e+","+c[l].style.fontFamily;var d=(new Date).getTime(),_=this;setTimeout(function(){h(d,_.timeout,c,r,o,function(t){s("timeout",t)},function(t){s("load",t)},e)},100)},__loadAtlas:function(t,e,i,s){var n=this;this.__loadImage(t,i[0],function(a,r){if("load"===a)if("string"==typeof i[1]&&2===i.length)n.__getXhr(t,i[1],function(t,e){var i=e;if("load"===t){var n;try{n=new Function("return "+e.responseText)()}catch(a){n=a}i=new soya2d.Atlas(r,n)}s(t,i)});else{var o=i[1];if(i.length>2){o=[];for(var h=r.width,c=r.height,l=i[1],u=i[2],f=1,d=u;c>=d;d+=u)for(var _=l;h>=_;_+=l)o.push({n:e+"_"+f,x:_-l,y:d-u,w:l,h:u}),f++}var g=new soya2d.Atlas(r,o);s(a,g)}else s(a,r)})},__getXhr:function(t,e,i){o(t+e,this.timeout,function(){i("timeout",e)},function(){i("error",e)},function(t){i("load",t)})},__loadAssets:function(){var t=this;this.__assetsQueue.forEach(function(e){switch(e.type){case"image":t.__loadImage(e.baseUrl,e.data,function(i,s){"load"===i&&(t.__assets.image[e.k]=s),t.__onLoad(i,s)});break;case"sound":if(!soya2d.Sound)return soya2d.console.warn("can't load sounds, module [sound] needs to be loaded"),void 0;t.__loadSound(e.baseUrl,e.data,function(i,s){"load"===i&&(t.__assets.sound[e.k]=s),t.__onLoad(i,s,arguments[2])});break;case"atlas":t.__loadAtlas(e.baseUrl,e.k,e.data,function(i,s){"load"===i&&(t.__assets.atlas[e.k]=s),t.__onLoad(i,s)});break;case"font":t.__loadFont(e.baseUrl,e.k,e.data,function(i,s){var n=s;"load"===i&&(n=(new soya2d.Font).family(s),t.__assets.imageFont[e.k]=n),t.__onLoad(i,n)});break;case"imageFont":t.__loadAtlas(e.baseUrl,e.k,e.data,function(i,s){var n=s;"load"===i&&(n=new soya2d.ImageFont(s),t.__assets.imageFont[e.k]=n),t.__onLoad(i,n)});break;case"text":t.__getXhr(e.baseUrl,e.data,function(i,s){var n=s;"load"===i&&(t.__assets.text[e.k]=s.responseText,n=s.responseText),t.__onLoad(i,n)});break;case"xml":t.__getXhr(e.baseUrl,e.data,function(i,s){var n=s;"load"===i&&(n=t.__assets.xml[e.k]=s.responseXML),t.__onLoad(i,n)});break;case"json":t.__getXhr(e.baseUrl,e.data,function(i,s){var n=s;if("load"===i){try{n=new Function("return "+s.responseText)()}catch(a){n=a}t.__assets.json[e.k]=n}t.__onLoad(i,n)})}})},__onLoad:function(t,e){this.__tip.setText("Loading... "+ ++this.__index+"/"+this.__assetsQueue.length),"load"===t?this.emit(t,e,this.__index,this.__assetsQueue.length):this.emit(t,e,arguments[2]),this.__index==this.__assetsQueue.length&&(this.__assetsQueue=[],this.emit("end"),this.__logo.parent.remove(this.__logo),this.__logo.opacity=0)},start:function(){this.__index=0,this.show&&(this.__logo.parent||this.game.world.add(this.__logo),this.__logo.opacity=1),this.__loadAssets()}});soya2d.MEDIA_ERR_UNCERTAIN=-1,soya2d.MEDIA_ERR_ABORTED=1,soya2d.MEDIA_ERR_NETWORK=2,soya2d.MEDIA_ERR_DECODE=3,soya2d.MEDIA_ERR_SRC_NOT_SUPPORTED=4,soya2d.MEDIA_ERR_SRC_NOT_FORTHCOMING=101,c.prototype={setView:function(t){var e=t.children[0];l(this,e,this.game.world,this.game)},findView:function(t){return this.map[t]}},g.prototype={start:function(t,e){var i=this,s=this.game;t="string"==typeof t?this.map[t]:new c(t,s),s.currentScene=t,e&&(s.world.clear(!0),s.world.off(),s.camera.reset()),t.onPreload?(t.onPreload(s),s.load.once("end",function(){s.currentScene.onInit&&setTimeout(function(){s.currentScene.onInit(s)},0)}),s.load.start()):t.onInit&&t.onInit(s);var n=soya2d.module._getAll();for(var a in n)n[a].onSceneChange&&n[a].onSceneChange(i,t);return this},add:function(t,e){return this.map[t]=new c(e,game),this.map[t]}};var F=soya2d.class("",{"extends":a,constructor:function(){this.__signalHandler=new r,this.triggerList=[],this.expMap={},this.threshold=1e3},on:function(t,e,i){var s=this;return t=t.replace(/\[(.*?)\]/gm,function(t,e){if(!s.expMap[e]){var i=new y(e);s.triggerList.push(i),s.expMap[e]=i}return e.replace(/\s+/gm,"_")}),this._super.on.call(this,t,e,i)},once:function(t,e,i){var s=this;return t=t.replace(/\[(.*?)\]/gm,function(t,e){if(!s.expMap[e]){var i=new y(e);s.triggerList.push(i),s.expMap[e]=i}return e.replace(/\s+/gm,"_")}),this._super.once.call(this,t,e,i)},off:function(t,e){var i=[];t=t.replace(/\[(.*?)\]/gm,function(t,e){return i.push(e),e.replace(/\s+/gm,"_")}),this._super.off.call(this,t,e),i.forEach(function(t){var e=this.__signalHandler.map[t.replace(/\s+/gm,"_")];Object.keys(e).length<1&&(this.expMap[t]=null,this.__removeTrigger(t))},this)},__scan:function(t){for(var e=[],i=[],s=this.triggerList.length;s--;){var n=this.triggerList[s],a=this.__signalHandler.map[n.exp.replace(/\s+/gm,"_")],r=!1;n.milliseconds+=t;var o=n.milliseconds-n._lastTriggerMilliseconds;n.canTrigger()&&o>=this.threshold&&(r=!0,n._lastTriggerMilliseconds=n.milliseconds),n._canUnload()&&e.push(n.exp),r&&(n.times++,a.forEach(function(t){t[3]&&i.push([n.exp,t[0]]),t[0].call(this,n.milliseconds,n.times,n._t)},this))}for(var s=e.length;s--;)this.__removeTrigger(e[s]);for(var s=i.length;s--;)this.off(i[s][0],i[s][1])},__removeTrigger:function(t){for(var e=this.triggerList.length;e--;){var i=this.triggerList[e];if(i.exp===t)break}this.triggerList.splice(e,1)}});soya2d.Circle=function(t,e,i){this.x=t||0,this.y=e||0,this.r=i||0},soya2d.Circle.prototype={toString:function(){return"{x:"+this.x+",y:"+this.y+",r:"+this.r+"}"},clone:function(){return new soya2d.Circle(this.x,this.y,this.r)},intersectWith:function(t){if(t instanceof soya2d.Circle&&t.r>0){if(soya2d.Math.len2Df(t.x-this.x,t.y-this.y)<=this.r+t.r)return!1}else if(t instanceof soya2d.Rectangle&&t.w>0&&t.h>0){var e=t.w/2,i=t.h/2,s=this.x-(t.x+e),n=this.y-(t.y+i);if(s>e+this.r||n>i+this.r)return!1;var a=Math.min(s,e),r=Math.max(a,-e),o=Math.min(n,i),h=Math.max(o,-i);return(r-s)*(r-s)+(h-n)*(h-n)<=this.r*this.r}return!0}},soya2d.Polygon=function(t){this.vtx=t},soya2d.Polygon.prototype={toString:function(){return this.vtx},clone:function(){return new soya2d.Polygon(this.vtx.concat())}},soya2d.Rectangle=function(t,e,i,s){this.x=t||0,this.y=e||0,this.w=i||0,this.h=s||0},soya2d.Rectangle.prototype={toString:function(){return"{x:"+this.x+",y:"+this.y+",w:"+this.w+",h:"+this.h+"}"},clone:function(){return new soya2d.Rectangle(this.x,this.y,this.w,this.h)},getRight:function(){return this.x+this.w},getBottom:function(){return this.y+this.h},contains:function(t,e){return t<this.x||t>this.x+this.w?!1:e<this.y||e>this.y+this.h?!1:!0},intersectWith:function(t){if(t instanceof soya2d.Rectangle&&t.w>0&&t.h>0){if(this.x>t.x+t.w||this.y>t.y+t.h)return!1;if(this.x+this.w<t.x||this.y+this.h<t.y)return!1}else if(t instanceof soya2d.Circle&&t.r>0)return t.intersectWith(this);return!0}},soya2d.Point=function(t,e){this.x=t||0,this.y=e||0},soya2d.Point.prototype={toString:function(){return"{x:"+this.x+",y:"+this.y+"}"},clone:function(){return new soya2d.Point(this.x,this.y)},set:function(t,e){return this.x=t,this.y=e,this}},soya2d.Matrix2x2=function(){this.e=new Float32Array(4),this.identity()},soya2d.Matrix2x2.prototype={toString:function(){return"["+this.e[0]+","+this.e[1]+","+this.e[2]+","+this.e[3]+"]"},set:function(t,e,i,s){var n=this.e;return n[0]=0==t?0:t||1,n[1]=e||0,n[2]=i||0,n[3]=0==s?0:s||1,this},clone:function(){return(new soya2d.Matrix2x2).set(this.e[0],this.e[1],this.e[2],this.e[3])},identity:function(){return this.set(1,0,0,1),this},mul:function(t){var e=this.e[0],i=this.e[1],s=this.e[2],n=this.e[3],a=t.e;return this.e[0]=a[0]*e+a[2]*i,this.e[1]=a[1]*e+a[3]*i,this.e[2]=a[0]*s+a[2]*n,this.e[3]=a[1]*s+a[3]*n,this},scale:function(t,e){return this.e[0]*=t,this.e[1]*=e,this.e[2]*=t,this.e[3]*=e,this},rotate:function(t){if(!t)return this;var e=soya2d.Math;t=0>t?360+t%360:t,t>360&&(t%=360);var i=this.e[0],s=this.e[1],n=this.e[2],a=this.e[3],r=e.SINTABLE[t],o=e.COSTABLE[t];return void 0===r&&(r=Math.sin(t*e.ONERAD),o=Math.cos(t*e.ONERAD)),this.e[0]=i*o+s*-r,this.e[1]=i*r+s*o,this.e[2]=n*o+a*-r,this.e[3]=n*r+a*o,this},skew:function(t,e){var i=this.e[0],s=this.e[1],n=this.e[2],a=this.e[3];if(t){var r;this.skewX===t&&this.sx?r=this.sx:(r=Math.tan(.017453292*t),this.sx=r),this.e[0]+=s*r,this.e[2]+=a*r}if(e){var o;this.skewY===t&&this.sy?o=this.sy:(o=Math.tan(.017453292*e),this.sy=o),this.e[1]+=i*o,this.e[3]+=n*o}return this}},soya2d.Vector=function(t,e){this.e=new Float32Array(2),this.e[0]=t||0,this.e[1]=e||0},soya2d.Vector.prototype={toString:function(){return"{x:"+this.e[0]+",y:"+this.e[1]+"}"},clone:function(){return new soya2d.Vector(this.e[0],this.e[1])},set:function(t,e){return this.e[0]=t||0,this.e[1]=e||0,this},dot:function(t){return this.e[0]*t.e[0]+this.e[1]*t.e[1]},negate:function(){return this.e[0]*=-1,this.e[1]*=-1,this},add:function(t){return this.e[0]+=t.e[0],this.e[1]+=t.e[1],this},sub:function(t){return this.e[0]-=t.e[0],this.e[1]-=t.e[1],this},mul:function(t){return this.e[0]*=t,this.e[1]*=t,this},div:function(t){return t?(this.e[0]/=t,this.e[1]/=t):(this.e[0]=0,this.e[1]=0),this},getAngle:function(){return Math.atan2(this.e[1],this.e[0])},getAngleBetween:function(t){var e=this.dot(t),i=e/(this.length()*t.length());return Math.acos(i)},rotate:function(t){var e=soya2d.Math,i=e.SINTABLE[t],s=e.COSTABLE[t];void 0===i&&(i=Math.sin(t*e.ONERAD),s=Math.cos(t*e.ONERAD));var n=this.e[0],a=this.e[1];return this.e[0]=n*s-a*i,this.e[1]=n*i+a*s,this},lengthSq:function(){return this.e[0]*this.e[0]+this.e[1]*this.e[1]},length:function(){return Math.sqrt(this.lengthSq())},normalize:function(){return this.div(this.length())}};var U=soya2d.class("",{"extends":a,constructor:function(t){this.__signalHandler=new r,this.sprite=t,this.rigid=null},sensor:function(t){return this.__cbk&&this.__cbk.sensor(this.rigid,t),this},moveTo:function(t,e){return this.__cbk&&this.__cbk.moveTo(this.rigid,t,e),this},moveBy:function(t,e){return this.__cbk&&this.__cbk.moveBy(this.rigid,t,e),this},"static":function(t){return this.__cbk&&this.__cbk.static(this.rigid,t),this},mass:function(t){return this.__cbk&&this.__cbk.mass(this.rigid,t),this},rotateBy:function(t){return this.__cbk&&this.__cbk.rotateBy(this.rigid,t),this},rotateTo:function(t){return this.__cbk&&this.__cbk.rotateTo(this.rigid,t),this},friction:function(t){return this.__cbk&&this.__cbk.friction(this.rigid,t),this},restitution:function(t){return this.__cbk&&this.__cbk.restitution(this.rigid,t),this},velocity:function(t,e){return this.__cbk&&this.__cbk.velocity(this.rigid,t||0,e||0),this},inertia:function(t){return this.__cbk&&this.__cbk.inertia(this.rigid,t||0),this}}),z=soya2d.class("",{"extends":a,constructor:function(){this.__signalHandler=new r,this.running=!1},setup:function(t){this.__cbk=t||{}},start:function(t){t=t||{},t.gravity=t.gravity||[0,1],t.gravity[0]=t.gravity[0]||0,t.gravity[1]=t.gravity[1]||1,t.enableSleeping=t.enableSleeping||!1,this.__cbk.onStart&&this.__cbk.onStart(t),this.running=!0},stop:function(){this.__cbk.onStop&&this.__cbk.onStop(),this.running=!1},update:function(){this.__cbk.onUpdate&&this.__cbk.onUpdate()},bind:function(t){var e;this.__cbk.onBind&&(e=this.__cbk.onBind(t)),t.body.rigid=e,t.body.__cbk=this.__cbk.body,e.__sprite=t},unbind:function(t){var e=t.body.rigid;e&&(t.body.__cbk=null,this.__cbk.onUnbind&&(e.__sprite=null,this.__cbk.onUnbind(e)),t.body={})},enable:function(t){var e=t;if(t instanceof Array||arguments.length>1){arguments.length>1&&(e=arguments);for(var i=e.length;i--;)this.bind(e[i])}else this.bind(e)},unable:function(t){var e=t;if(t instanceof Array||arguments.length>1){arguments.length>1&&(e=arguments);for(var i=e.length;i--;)this.unbind(e[i])}else this.unbind(e)}});soya2d.EVENT_CONTACTSTART="contactstart",soya2d.EVENT_CONTACTEND="contactend",w.prototype={register:function(t,e){this.map[t]=e,e.prototype instanceof soya2d.DisplayObject&&(this.game.add[t]=function(e){return this.__newInstanceAndAppend(t,e)})}},soya2d.class("soya2d.DisplayObject",{"extends":a,__signalHandler:new r,constructor:function(t){if(t=t||{},this.__seq=soya2d.__roIndex++,this.roid="roid_"+this.__seq,this.name=t.name||this.roid,this.visible=t.visible===!1?!1:t.visible||!0,this.layout=t.layout,this.__opacity=0===t.opacity?0:t.opacity||1,this.__x=t.x||0,this.__y=t.y||0,this.__w=t.w||0,this.__h=t.h||0,this.__anchorX=0===t.anchorX?0:t.anchorX||"50%",this.__anchorY=0===t.anchorY?0:t.anchorY||"50%",this.__angle=t.angle||0,this.__scaleX=0==t.scaleX?0:t.scaleX||1,this.__scaleY=0==t.scaleY?0:t.scaleY||1,this.__skewX=t.skewX||0,this.__skewY=t.skewY||0,Object.defineProperties(this,{opacity:{set:function(t){t=0==t?0:parseFloat(t)||1,this.__opacity=0>t?0:t>1?1:t},get:function(){return this.__opacity},enumerable:!0},x:{set:function(t){this.__x=t||0,this.__localChange=!0,this.game.physics.running&&this.body.moveTo(this.__x,this.__y)},get:function(){return this.__x},enumerable:!0},y:{set:function(t){this.__y=t||0,this.__localChange=!0,this.game.physics.running&&this.body.moveTo(this.__x,this.__y)
},get:function(){return this.__y},enumerable:!0},w:{set:function(t){this.__w=t,this.__anchorChange=!0},get:function(){return this.__w},enumerable:!0},h:{set:function(t){this.__h=t,this.__anchorChange=!0},get:function(){return this.__h},enumerable:!0},anchorX:{set:function(t){this.__anchorX=t,this.__anchorChange=!0},get:function(){return this.__anchorX},enumerable:!0},anchorY:{set:function(t){this.__anchorY=t,this.__anchorChange=!0},get:function(){return this.__anchorY},enumerable:!0},angle:{set:function(t){this.__angle=t,this.__localChange=!0,this.game.physics.running&&this.body.rotateTo(this.__angle)},get:function(){return this.__angle},enumerable:!0},scaleX:{set:function(t){this.__scaleX=t,this.__localChange=!0},get:function(){return this.__scaleX},enumerable:!0},scaleY:{set:function(t){this.__scaleY=t,this.__localChange=!0},get:function(){return this.__scaleY},enumerable:!0},skewX:{set:function(t){this.__skewX=t,this.__localChange=!0},get:function(){return this.__skewX},enumerable:!0},skewY:{set:function(t){this.__skewY=t,this.__localChange=!0},get:function(){return this.__skewY},enumerable:!0}}),this.z=t.z||0,this.__localChange=!0,this.__anchorChange=!0,this.__localTransform=new soya2d.Matrix2x2,this.__worldTransform=new soya2d.Matrix2x2,this.worldPosition=new soya2d.Point,this.anchorPosition=new soya2d.Point,this.__screenPosition=new soya2d.Point,this.blendMode=t.blendMode||"source-over",this.__mask=t.mask||null,this.__fixedToCamera=t.fixedToCamera||!1,Object.defineProperties(this,{mask:{set:function(t){t&&(t.__masker&&(t.__masker.__mask=null),this.__mask=t,t.__masker=this)},get:function(){return this.__mask},enumerable:!0},fixedToCamera:{set:function(t){this.__fixedToCamera=t,t&&this.cameraOffset.set(this.x,this.y)},get:function(){return this.__fixedToCamera},enumerable:!0}}),this.__masker=null,this.bounds=t.bounds||new soya2d.Rectangle(0,0,this.__w,this.__h),this.__boundRect=new soya2d.Rectangle(0,0,1,1),this.body=new U(this),this.game=t.game||soya2d.games[0],this.imageCache=null,this.__updateCache=!1,this.cameraOffset=new soya2d.Point,!this.game)throw new Error("soya2d.DisplayObject: invalid param [game]; "+this.game);soya2d.ext(this,t),this.fixedToCamera=this.__fixedToCamera},__onAdded:function(){this.centerX=this.w/2,this.centerY=this.h/2,this.setLayout(this.layout),this.fixedToCamera&&this.layout&&this.cameraOffset.set(this.x,this.y),this.onAdded&&this.onAdded()},setLayout:function(t){if(!t)return this;var e=t.left||0,i=t.top||0,s=t.width,n=t.height,a=t.offsetLeft,r=t.offsetTop;s&&(this.__w=b(s,this.parent)||0),n&&(this.__h=T(n,this.parent)||0);var o=0,h=0;return a&&(o=E(a,this.__w)),r&&(h=E(r,this.__h)),(e||a)&&(this.__x=b(e,this.parent)+o),(i||r)&&(this.__y=T(i,this.parent)+h),this},toString:function(){return'{roid:"'+this.roid+'";name:"'+this.name+'"}'},transform:function(){var t=this.__x,e=this.__y;this.__localChange&&(this.__localTransform.identity(),this.__localTransform.scale(this.__scaleX,this.__scaleY).rotate(this.__angle).skew(this.__skewX,this.__skewY));var i=this.__localTransform,s=this.__worldTransform,n=this.anchorPosition,a=i.e,r=n.x,o=n.y;if(this.__anchorChange&&(r=this.__anchorX,o=this.__anchorY,r="number"==typeof r?r:parseFloat(r)/100*this.__w,o="number"==typeof o?o:parseFloat(o)/100*this.__h,n.set(r,o)),t+=r,e+=o,s.set(a[0],a[1],a[2],a[3]),this.parent){var h=this.parent.__worldTransform,c=h.e,l=this.parent.worldPosition,u=this.parent.anchorPosition,f=u.x*c[0]+u.y*c[2],d=u.x*c[1]+u.y*c[3],_=t*c[0]+e*c[2],g=t*c[1]+e*c[3];t=_+l.x-f,e=g+l.y-d,s.mul(h)}this.body.rigid&&(t-=n.x,e-=n.y),this.worldPosition.set(t,e),this.__localChange=this.__anchorChange=!1},isRendered:function(){if(!this.visible||0===this.opacity)return!1;for(var t=this.parent;t;){if(!t.visible||0===t.opacity)return!1;if(!(t.parent||t instanceof X))return!1;t=t.parent}return!0},clone:function(t,e){e=e||new this.constructor;for(var i=Object.keys(this),s=i.length;s--;){var n=i[s];if("parent"!==n&&"__seq"!==n&&"roid"!==n&&"__localTransform"!==n&&"__worldTransform"!==n&&"worldPosition"!==n&&"anchorPosition"!==n&&"__screenPosition"!==n&&(t||"children"!==n))if(t&&"children"===n&&this[n]&&this[n].length>0){e[n]=[];for(var a=0;a<this[n].length;a++){var r=this[n][a],o=r.clone(t);o.parent=e,e[n].push(o)}}else e[n]=this[n]instanceof Array?this[n].slice(0):this[n]}return e},moveBy:function(){var t=arguments[0]||0,e=0===arguments[1]?0:arguments[1]||t;return this.x+=t,this.y+=e,this},moveTo:function(){var t=arguments[0]||0,e=0===arguments[1]?0:arguments[1]||t;return this.x=t,this.y=e,this},opacifyTo:function(t){return this.opacity=t>1?1:0>t?0:t,this},opacifyBy:function(t){return this.opacity+=t,this.opacity>1&&(this.opacity=1),this.opacity<0&&(this.opacity=0),this},resizeTo:function(){var t=arguments[0]||0,e=0===arguments[1]?0:arguments[1]||t;return this.w=t,this.h=e,this},scaleBy:function(){var t=arguments[0]||0,e=0===arguments[1]?0:arguments[1]||t;return this.scaleX+=t,this.scaleY+=e,this},scaleTo:function(){var t=arguments[0]||0,e=0===arguments[1]?0:arguments[1]||t;return this.scaleX=t,this.scaleY=e,this},skewBy:function(){var t=arguments[0]||0,e=0===arguments[1]?0:arguments[1]||t;return this.skewX+=t,this.skewY+=e,this},skewTo:function(){var t=arguments[0]||0,e=0===arguments[1]?0:arguments[1]||t;return this.skewX=t,this.skewY=e,this},rotateBy:function(t){return this.angle+=t,this},rotateTo:function(t){return this.angle=t,this},anchorBy:function(){var t=arguments[0]||0,e=0===arguments[1]?0:arguments[1]||t;return this.anchorX+=t,this.anchorY+=e,this},anchorTo:function(){var t=arguments[0]||0,e=0===arguments[1]?0:arguments[1]||t;return this.anchorX=t,this.anchorY=e,this},getBoundingPoints:function(){var t=this.__worldTransform.e,e=this.worldPosition,i=this.anchorPosition,s=e.x,n=e.y,a=t[0],r=t[1],o=t[2],h=t[3],c=i.x,l=i.y,u=-c,f=-l,d=this.w-c,_=-l,g=-c,y=this.h-l,m=this.w-c,p=this.h-l;return[u*a+f*o+s,u*r+f*h+n,d*a+_*o+s,d*r+_*h+n,m*a+p*o+s,m*r+p*h+n,g*a+y*o+s,g*r+y*h+n]},getBoundingBox:function(){var t,e,i,s,n=this.getBoundingPoints();i=n[0],t=n[0],s=n[1],e=n[1];for(var a=n.length;a--;)a%2===0?(n[a]>i&&(i=n[a]),n[a]<t&&(t=n[a])):(n[a]>s&&(s=n[a]),n[a]<e&&(e=n[a]));var r=t,o=e,h=i-t,c=s-e;return this.__boundRect.x=r,this.__boundRect.y=o,this.__boundRect.w=h,this.__boundRect.h=c,this.__boundRect},hitTest:function(t,e){var i=this.worldPosition;if(this.bounds instanceof soya2d.Circle){var s=Math.abs(soya2d.Math.len2D(i.x,i.y,t,e));if(s<=this.bounds.r)return!0}else if(this.bounds instanceof soya2d.Rectangle||this.bounds instanceof soya2d.Polygon){var n;if(this.bounds.vtx){var a=this.__worldTransform.e,r=this.anchorPosition,o=i.x,h=i.y,c=a[0],l=a[1],u=a[2],f=a[3],d=r.x,_=r.y,g=-d,y=-_;n=[];for(var m=0;m<this.bounds.vtx.length;m+=2){var p=this.bounds.vtx[m]+g,v=this.bounds.vtx[m+1]+y;n.push(p*c+v*u+o,p*l+v*f+h)}}else n=this.getBoundingPoints();for(var w=!1,m=0;m<n.length;m+=2){var p=n[m],v=n[m+1],x=n[m+2]||n[0],b=n[m+3]||n[1];if(p===t&&v===e||x===t&&b===e)return!0;if(e>v&&b>=e||v>=e&&e>b){var T=(e-v)/(b-v)*(x-p)+p;if(T===t)return!0;T>t&&(w=!w)}}return w}return!1},intersectWith:function(t){var e=this.getBoundingBox(),i=t.getBoundingBox();return e.intersectWith(i)},getAnchorPosition:function(){var t=this.__worldTransform.e,e=this.worldPosition,i=this.anchorPosition,s=e.x,n=e.y,a=t[0],r=t[1],o=t[2],h=t[3],c=i.x,l=i.y,u=-c,f=-l,d=this.w*parseInt(this.anchorX)/100,_=this.h*parseInt(this.anchorY)/100,g=Math.sqrt(_*_+d*d),y=Math.atan2(_,d);return d=Math.cos(y)*g+u,_=Math.sin(y)*g+f,new soya2d.Point(d*a+_*o+s,d*r+_*h+n)},cache:function(){if(!(this.__w>1024||this.__h>1024)){this.imageCache||(this.imageCache=document.createElement("canvas")),this.imageCache.width=this.__w,this.imageCache.height=this.__h,this.transform(),this.__updateCache=!0,this.__renderable=!0;var t=this.imageCache.getContext("2d"),e=new soya2d.CanvasGraphics(t);this.game.renderer.renderDO(this.game.camera.__view,t,this,e,!0),this.__updateCache=!1}},destroy:function(){if(this.game.physics.unbind(this),this.off(),this.__seq){this.children.length>0&&this.children.forEach(function(t){t.destroy()});for(var t=Object.keys(this),e=t.length;e--;)t[e].indexOf("__")<0||(this[t[e]]=null);this.parent&&this.parent.remove(this),this.onRender=this.onUpdate=this.parent=this.children=this.imageCache=this.fillStyle=this.game=this.body=null}}}),soya2d.class("soya2d.DisplayObjectContainer",{"extends":soya2d.DisplayObject,constructor:function(){this.children=[],this.parent=null},add:function(){for(var t=0;t<arguments.length;t++){var e=arguments[t];e.parent&&e.parent.remove(e),this.children.push(e),e.parent=this,e.__onAdded()}return this},remove:function(){for(var t=0;t<arguments.length;t++){var e=arguments[t],i=this.children.indexOf(e);0>i||(this.children.splice(i,1),e.parent=null)}return this},clear:function(t){for(var e=this.children.length;e--;)this.children[e].parent=null;var i=this.children;if(this.children=[],t)for(var e=i.length;e--;)i[e].destroy();return i},find:function(t,e){if(this.children.length<1)return[];var i;return e?(i=[],R(this,t,i)):i=this.children.filter(t),i}});var X=soya2d.class("",{"extends":soya2d.DisplayObjectContainer,constructor:function(t){this.game=t.game,this.__anchorX=this.__anchorY=0,this.minWidth=0,this.minHeight=0,this.maxWidth=0,this.maxHeight=0,this.autoScale=!0,this.orientation=M();var e,i=this;window.addEventListener("orientationchange",function(){clearTimeout(e),e=setTimeout(function(){i.orientation=M()},500),i.autoScale&&i.__scan()},!1),window.addEventListener("resize",function(){i.orientation=M(),i.autoScale&&i.__scan()},!1),this.__bg=null,this.__rotat=soya2d.ROTATEMODE_0;var s=soya2d.ALIGNMODE_CENTER,n=soya2d.SCALEMODE_SHOWALL;Object.defineProperties(this,{scaleMode:{set:function(t){n=t,this.__scan()},get:function(){return n}},alignMode:{set:function(t){if(t&&this.scaleMode===soya2d.SCALEMODE_SHOWALL){var e=this.game.renderer.getCanvas();switch(s=t,t){case soya2d.ALIGNMODE_LEFT:e.style.left=0,e.style.right="auto";break;case soya2d.ALIGNMODE_RIGHT:e.style.left="auto",e.style.right=0;break;case soya2d.ALIGNMODE_CENTER:default:e.style.left=0,e.style.right=0,s=soya2d.ALIGNMODE_CENTER}e.style.margin="auto"}},get:function(){return s}},rotateMode:{set:function(t){this.__rotat=t,this.__scan()},get:function(){return this.__rotat}}})},__updateMatrix:function(){S(this)},__preUpdate:function(t,e){this.children&&C(this.children,t,e)},__postUpdate:function(t,e){this.children&&k(this.children,t,e)},onRender:function(t){this.__bg&&(t.fillStyle(this.__bg),t.fillRect(0,0,this.w,this.h))},background:function(t){if("string"==typeof t)this.__bg=t;else if(t instanceof self.Image)this.__bg=this.game.renderer.createPattern(t,arguments[1]);else if(!isNaN(t)){var e={};arguments[4]&&soya2d.ext(e,arguments[4]),e.type=t;var i=this.game.renderer.createGradient(arguments[1],arguments[2],arguments[3]||1,e);this.__bg=i}},__scan:function(){var t,e=this.game.w,i=this.game.h;switch(this.scaleMode){case soya2d.SCALEMODE_NOSCALE:break;case soya2d.SCALEMODE_NOBORDER:t=D;break;case soya2d.SCALEMODE_EXACTFIT:t=P;break;case soya2d.SCALEMODE_SHOWALL:default:t=L}if(t){var s=this.game.renderer,n=s.getCanvas().parentNode,a=n.clientWidth,r=n.clientHeight;"BODY"===n.tagName&&(r=window.innerHeight);var o=t(e,i,a,r,this.minWidth,this.minHeight,this.maxWidth,this.maxHeight);s.resize(o[0],o[1]),I(this.scaleMode,this.__rotat,s.getCanvas(),s,this)}}});soya2d.SCALEMODE_NOSCALE=0,soya2d.SCALEMODE_SHOWALL=1,soya2d.SCALEMODE_NOBORDER=2,soya2d.SCALEMODE_EXACTFIT=3,soya2d.ALIGNMODE_LEFT=1,soya2d.ALIGNMODE_CENTER=2,soya2d.ALIGNMODE_RIGHT=3,soya2d.ROTATEMODE_0=1,soya2d.ROTATEMODE_90=2,soya2d.ROTATEMODE_180=3,soya2d.ROTATEMODE_270=4,soya2d.BG_REPEAT="repeat",soya2d.BG_NOREPEAT="no-repeat",soya2d.BG_REPEAT_X="repeat-x",soya2d.BG_REPEAT_Y="repeat-y";var j=soya2d.class("",{"extends":soya2d.DisplayObjectContainer,constructor:function(){this.__soya_type="world"},setBounds:function(t,e){this.bounds.w=t,this.bounds.h=e,this.w=t,this.h=e}});soya2d.class("soya2d.Shape",{"extends":soya2d.DisplayObjectContainer}),N.prototype.reset=function(){this.index=0,this.lastUpdateTime=0};var G=soya2d.class("",{"extends":a,__signalHandler:new r,constructor:function(t,e){this.map={};for(var i=[],s=0;e>s;s++)i.push(s);this.defaultAnimation=new N(i),this.animation=null,this.playingK=null},destroy:function(){this.defaultAnimation=null,this.animation=null,this.playingK=null,this.__signalHandler=null},add:function(t,e,i,s){return this.map[t]=new N(e,i,s),this},play:function(t){return this.playingK===t?this:(this.animation=t?this.map[t]:this.defaultAnimation,this.playingK=t||!0,this)},stop:function(){return this.playingK=null,this.animation&&this.animation.reset(),this.animation=null,this}});soya2d.class("soya2d.Sprite",{"extends":soya2d.DisplayObjectContainer,constructor:function(t){var e=t.images;e&&(this.animations=null,this.setImages(e),this.w=t.w||this.images[0].width,this.h=t.h||this.images[0].height,this.frameIndex=t.frameIndex||0,this.__scale9grid=t.scale9grid,!this.__scale9grid||this.__w==this.images[0].width&&this.__h==this.images[0].height||this.__parseScale9(),Object.defineProperties(this,{scale9grid:{set:function(t){t instanceof soya2d.Rectangle&&(this.__scale9grid=t,this.__cacheGrid=!0,this.__parseScale9())},get:function(){return this.__scale9grid},enumerable:!0}}))},clone:function(t){var e=new this.constructor({images:this.images.concat()});return soya2d.DisplayObject.prototype.clone.call(this,t,e)},_onUpdate:function(){this.__cacheGrid&&this.__scale9grid instanceof soya2d.Rectangle&&(this.__w!=this.__cacheW||this.__h!=this.__cacheH)&&(this.cache(),this.__cacheW=this.__w,this.__cacheH=this.__h)},__parseScale9:function(){var t=this.images[0].width,e=this.images[0].height,i=this.__scale9grid.y+this.__scale9grid.h,s=e-i,n=this.__scale9grid.x+this.__scale9grid.w,a=t-n,r=this.__w-this.__scale9grid.x-a,o=this.__h-this.__scale9grid.y-s,h=r+this.__scale9grid.x,c=o+this.__scale9grid.y,l=this.__scale9grid.x,u=this.__scale9grid.y,f=this.__scale9grid.w,d=this.__scale9grid.h;this.__scale9Data={t1:{x:0,y:0,w:l,h:u},t2:{x:l,y:0,w:f,h:u,dw:r},t3:{x:n,y:0,w:a,h:u,dx:h},m1:{x:0,y:u,w:l,h:d,dh:o},m2:{x:l,y:u,w:f,h:d,dw:r,dh:o},m3:{x:n,y:u,w:a,h:d,dx:h,dh:o},b1:{x:0,y:i,w:l,h:s,dy:c},b2:{x:l,y:i,w:f,h:s,dw:r,dy:c},b3:{x:n,y:i,w:a,h:s,dx:h,dy:c}}},onRender:function(t){if(this.animations.playingK){var e=this.animations.animation;e.lastUpdateTime||(e.lastUpdateTime=(new Date).getTime());var i=(new Date).getTime(),s=i-e.lastUpdateTime,n=s/(16.7*e.frameRate)>>0;if(n>0){if(e.index+=n,e.index>=e.frames.length){if(!e.loop){var a=this.animations.playingK;return this.animations.stop(),this.animations.emit("stop",a),void 0}e.index=0}e.lastUpdateTime=i}var r=e.frames[e.index];t.map(this.images[r],0,0,this.w,this.h)}else if(this.__scale9grid&&this.__updateCache){var o=this.images[0],h=this.__scale9Data,c=h.t1,l=h.t2,u=h.t3,f=h.m1,d=h.m2,_=h.m3,g=h.b1,y=h.b2,m=h.b3;t.map(o,c.x,c.y,c.w,c.h,c.x,c.y,c.w,c.h),t.map(o,l.x,l.y,l.dw,l.h,l.x,l.y,l.w,l.h),t.map(o,u.dx,u.y,u.w,u.h,u.x,u.y,u.w,u.h),t.map(o,f.x,f.y,f.w,f.dh,f.x,f.y,f.w,f.h),t.map(o,d.x,d.y,d.dw,d.dh,d.x,d.y,d.w,d.h),t.map(o,_.dx,_.y,_.w,_.dh,_.x,_.y,_.w,_.h),t.map(o,g.x,g.dy,g.w,g.h,g.x,g.y,g.w,g.h),t.map(o,y.x,y.dy,y.dw,y.h,y.x,y.y,y.w,y.h),t.map(o,m.dx,m.dy,m.w,m.h,m.x,m.y,m.w,m.h)}else t.map(this.images[this.frameIndex],0,0,this.w,this.h)},nextFrame:function(t){this.frameIndex++,this.frameIndex>=this.images.length&&(this.frameIndex=t?0:this.images.length-1)},prevFrame:function(t){this.frameIndex--,this.frameIndex<0&&(t?frameIndex=this.images.length-1:this.frameIndex=0)},setImages:function(t,e){if("string"==typeof t)this.images=[this.game.assets.image(t)];else if(t instanceof self.Image||t.getContext&&1==t.nodeType)this.images=[t];else if(t instanceof Array){var i=[];t.forEach(function(t){"string"==typeof t?i.push(this.game.assets.image(t)):i.push(t)},this),this.images=i}else this.images=[];return this.images[0]||soya2d.console.error("soya2d.Sprite: invalid param [images]; "+this.images[0]),this.frameIndex=0,e&&(this.w=this.images[0].width,this.h=this.images[0].height),this.animations&&this.animations.destroy(),this.animations=new G(this,this.images.length),this}}),soya2d.class("soya2d.TileSprite",{"extends":soya2d.DisplayObjectContainer,constructor:function(t){this.sprite=null,this.sprite=t.sprite instanceof soya2d.Sprite?t.sprite:new soya2d.Sprite({images:t.sprite}),this.w=t.w||this.sprite.w,this.h=t.h||this.sprite.h,this.autoScroll=t.autoScroll||!1,this.speed=t.speed||1,this.scrollAngle=t.scrollAngle||0,this.__tileOffx=0,this.__tileOffy=0},scroll:function(t,e){if(t||e)this.__tileOffx+=t||0,this.__tileOffy+=e||0;else{var i=(this.scrollAngle>>0)%360;this.__tileOffx+=soya2d.Math.COSTABLE[i]*this.speed,this.__tileOffy+=soya2d.Math.SINTABLE[i]*this.speed}},clone:function(t){var e=new this.constructor({sprite:this.sprite});return soya2d.DisplayObject.prototype.clone.call(this,t,e),e},_onUpdate:function(){if(this.autoScroll){var t=(this.scrollAngle>>0)%360;this.__tileOffx+=soya2d.Math.COSTABLE[t]*this.speed,this.__tileOffy+=soya2d.Math.SINTABLE[t]*this.speed}},onRender:function(t){t.beginPath(),t.push(),t.rect(0,0,this.w,this.h),t.clip();var e=this.sprite,i=e.w,s=e.h,n=i*e.scaleX,a=s*e.scaleY;n=0>n?-1*n:n,a=0>a?-1*a:a;var r=(this.w/n>>0)+2,o=(this.h/a>>0)+2,h=this.__tileOffx%n,c=this.__tileOffy%a;this.__tileOffx>0&&(h-=n),this.__tileOffy>0&&(c-=a);for(var l=this.sprite.images[0],u=o;u--;)for(var f=r;f--;){var d=f*n,_=u*a;t.map(l,d+h,_+c,n,a,0,0,i,s)}t.pop()}}),soya2d.CanvasGraphics=function(t){this.ctx=t,this.opacity=function(t){return 0===t||t?(this.ctx.globalAlpha=t,this):this.ctx.globalAlpha},this.closePath=function(){return this.ctx.closePath(),this},this.moveTo=function(t,e){return this.ctx.moveTo(t,e),this},this.lineTo=function(t,e){return this.ctx.lineTo(t,e),this},this.quadraticCurveTo=function(t,e,i,s){return this.ctx.quadraticCurveTo(t,e,i,s),this},this.bezierCurveTo=function(t,e,i,s,n,a){return this.ctx.bezierCurveTo(t,e,i,s,n,a),this},this.arcTo=function(t,e,i,s,n){return this.ctx.arcTo(t,e,i,s,n),this},this.arc=function(t,e,i,s,n){return this.ctx.arc(t,e,i,s||0,n||soya2d.Math.PIM2),this},this.eArc=function(e,i,s,n,a,r){a=(a||0)>>0,r=(r||360)>>0;var o=soya2d.Math,h=e+s*o.COSTABLE[a],c=i+n*o.SINTABLE[a];t.moveTo(h,c);var l=0;l=a>r?360-a+r:r-a;for(var u=1;l>=u;u++){var f=(a+u)%360;h=e+s*o.COSTABLE[f],c=i+n*o.SINTABLE[f],t.lineTo(h,c)}return this},this.rect=function(t,e,i,s){return this.ctx.rect(t,e,i,s),this},this.polygon=function(t){var e=this.ctx,i=t.length-1;e.moveTo(t[0],t[1]);for(var s=2;i>s;s+=2)e.lineTo(t[s],t[s+1]);return this},this.ellipse=function(t,e,i,s){var n=.5522848,a=i/2*n,r=s/2*n,o=t+i,h=e+s,c=t+i/2,l=e+s/2,u=this.ctx;return u.moveTo(t,l),u.bezierCurveTo(t,l-r,c-a,e,c,e),u.bezierCurveTo(c+a,e,o,l-r,o,l),u.bezierCurveTo(o,l+r,c+a,h,c,h),u.bezierCurveTo(c-a,h,t,l+r,t,l),this},this.roundRect=function(t,e,i,s,n){var a=this.ctx;return a.moveTo(t+n,e),a.lineTo(t+(i-(n<<1)),e),a.arc(t+i-n,e+n,n,3*Math.PI/2,0),a.lineTo(t+i,e+s-n),a.arc(t+i-n,e+s-n,n,0,soya2d.Math.PID2),a.lineTo(t+n,e+s),a.arc(t+n,e+s-n,n,soya2d.Math.PID2,Math.PI),a.lineTo(t,e+n),a.arc(t+n,e+n,n,Math.PI,3*Math.PI/2),this},this.regularPolygon=function(t,e,i,s,n){t=t||0,e=e||0,i=3>i?3:i;for(var a=soya2d.Math,r=[],o=360/i,h=0,c=0;360>h;h+=o,c++){var l=s;n&&(l=c%2!==0?s:n),a.COSTABLE[h]?r.push(t+l*a.COSTABLE[h],e+l*a.SINTABLE[h]):r.push(t+l*a.COSTABLE[Math.round(h)],e+l*a.SINTABLE[Math.round(h)])}return this.polygon(r),this},this.blendMode=function(t){return t?(this.ctx.globalCompositeOperation=t,this):this.ctx.globalCompositeOperation},this.strokeStyle=function(t){return t?(this.ctx.strokeStyle=t,this):this.ctx.strokeStyle},this.fillStyle=function(t){return t?(this.ctx.fillStyle=t,this):this.ctx.fillStyle},this.shadow=function(t,e,i,s){return this.ctx.shadowBlur=t,this.ctx.shadowColor=e,this.ctx.shadowOffsetX=i,this.ctx.shadowOffsetY=s,this},this.lineStyle=function(t,e,i,s){var n=this.ctx;return n.lineWidth=t,n.lineCap=e||n.lineCap,n.lineJoin=i||n.lineJoin,n.miterLimit=s||n.miterLimit,this},this.font=function(t){var e=this.ctx;return e.font=t.getDesc(),this},this.clip=function(){return this.ctx.clip(),this},this.push=function(){return this.ctx.save(),this},this.pop=function(){return this.ctx.restore(),this},this.beginPath=function(){return this.ctx.beginPath(),this},this.closePath=function(){return this.ctx.closePath(),this},this.fill=function(){return this.ctx.fill(),this},this.stroke=function(){return this.ctx.stroke(),this},this.path=function(t){t._insQ.forEach(function(t){var e=t[0].toLowerCase();switch(e){case"m":this.ctx.moveTo(t[1][0],t[1][1]);break;case"l":var i=t[1];if(i.length>2)for(var s=0;s<i.length;s+=2)this.ctx.lineTo(i[s],i[s+1]);else this.ctx.lineTo(i[0],i[1]);break;case"c":var i=t[1];if(i.length>6)for(var s=0;s<i.length;s+=6)this.ctx.bezierCurveTo(i[s],i[s+1],i[s+2],i[s+3],i[s+4],i[s+5]);else this.ctx.bezierCurveTo(i[0],i[1],i[2],i[3],i[4],i[5]);break;case"q":var i=t[1];if(i.length>4)for(var s=0;s<i.length;s+=4)this.ctx.quadraticCurveTo(i[s],i[s+1],i[s+2],i[s+3]);else this.ctx.quadraticCurveTo(i[0],i[1],i[2],i[3]);break;case"z":this.ctx.closePath()}},this)},this.fillRect=function(t,e,i,s){return this.ctx.fillRect(t,e,i,s),this},this.strokeRect=function(t,e,i,s){return this.ctx.strokeRect(t,e,i,s),this},this.clearRect=function(t,e,i,s){return this.ctx.clearRect(t,e,i,s),this},this.map=function(t,e,i,s,n,a,r,o,h){return a=a||0,r=r||0,o=o||t.width,h=h||t.height,0!==o&&0!==h&&0!==s&&0!==n?(this.ctx.drawImage(t,a>>0,r>>0,o>>0,h>>0,e>>0,i>>0,s>>0,n>>0),this):void 0},this.fillText=function(t,e,i,s){return s?this.ctx.fillText(t,e||0,i||0,s):this.ctx.fillText(t,e||0,i||0),this},this.strokeText=function(t,e,i,s){return s?this.ctx.strokeText(t,e||0,i||0,s):this.ctx.strokeText(t,e||0,i||0),this}},soya2d.CanvasRenderer=function(t){function e(t){t.stroke=function(){},t.fill=function(){},t.fillRect=function(e,i,s,n){t.rect(e,i,s,n)},t.strokeRect=function(e,i,s,n){t.rect(e,i,s,n)},t.drawImage=function(e,i,s,n,a,r,o,h,c){3===arguments.length?t.rect(i,s,e.width,e.height):5===arguments.length?t.rect(i,s,n,a):9===arguments.length&&t.rect(r,o,h,c)},t.fillText=function(){},t.strokeText=function(){},t.beginPath=function(){},t.closePath=function(){}}function i(t){t.stroke=d.stroke,t.fill=d.fill,t.fillRect=d.fillRect,t.strokeRect=d.strokeRect,t.drawImage=d.drawImage,t.fillText=d.fillText,t.strokeText=d.strokeText,t.beginPath=d.beginPath,t.closePath=d.closePath}function s(t,e){if(e.onRender){var i=e.__worldTransform.e,n=e.worldPosition;t.setTransform(i[0],i[1],i[2],i[3],n.x,n.y);var a=e.anchorPosition;t.translate(-a.x,-a.y),e.onRender(u)}if(e.children&&e.children.length>0)for(var r=e.children,o=0;o<r.length;o++)s(t,r[o])}function n(t,a,r,o,h,c){if(0!==r.opacity&&r.visible&&!r.__masker&&r.__renderable){if(r.mask instanceof soya2d.DisplayObject&&(a.save(),a.beginPath(),e(a),s(a,r.mask),a.clip(),i(a),a.closePath()),r.onRender){var l=r.__worldTransform.e,u=r.__screenPosition,f=r.anchorPosition;if(r.__updateCache){var d=f.x,_=f.y;a.setTransform(1,0,0,1,d,_)}else{var d=u.x,_=u.y;a.setTransform(l[0],l[1],l[2],l[3],d,_)}c&&r.opacity<=1&&r.opacity!==c.opacity&&(c.opacity=r.opacity,a.globalAlpha=r.opacity),c&&c.blendMode!==r.blendMode&&(c.blendMode=r.blendMode,a.globalCompositeOperation=r.blendMode),a.translate(-f.x,-f.y),r.imageCache&&!r.__updateCache?a.drawImage(r.imageCache,0,0):r.onRender(o)}if(r.__renderable=!1,r.children&&r.children.length>0&&!r.__updateCache){var g=r.children;h&&g.sort(function(t,e){return t.z===e.z?t.__seq-e.__seq:t.z-e.z});for(var y=0;y<g.length;y++)n(t,a,g[y],o,h,c,"world"==g[y].__soya_type||r instanceof X?!1:!0)}r.mask instanceof soya2d.DisplayObject&&a.restore()}}t=t||{};var a=t.container;this.w=t.w||(a?a.clientWidth:0),this.h=t.h||(a?a.clientHeight:0),this.autoClear=void 0===t.autoClear?!0:t.autoClear,this.sortEnable=t.sortEnable||!1;var r=t.smoothEnable===!1?!1:t.smoothEnable||!0,o=t.crispEnable||!1,h=document.createElement("canvas");h.style.position="absolute";var c=window.getComputedStyle(t.container,null).position;"absolute"!==c&&"relative"!==c&&(a.style.position="relative"),c=null,a.appendChild(h),a=null;var l=h.getContext("2d"),u=new soya2d.CanvasGraphics(l);h.width=this.w,h.height=this.h,this.ctx=l,l.textBaseline=soya2d.TEXTVALIGN_TOP;var f={opacity:1,blendMode:"source-over"};this.getCanvas=function(){return h},this.render=function(t,e){if(!(!t instanceof X)){l.setTransform(1,0,0,1,0,0),this.autoClear&&l.clearRect(0,0,this.w,this.h);var i=e.__view;n(i,l,t,u,this.sortEnable,f)}};var d={stroke:l.stroke,fill:l.fill,fillRect:l.fillRect,strokeRect:l.strokeRect,drawImage:l.drawImage,fillText:l.fillText,strokeText:l.strokeText,beginPath:l.beginPath,closePath:l.closePath};this.renderDO=n,this.destroy=function(){h.parentNode.removeChild(h),d=u=this.ctx=null},this.resize=function(t,e){var i=h.width,s=h.height;this.hr=t/i,this.vr=e/s,h.style.width=t+"px",h.style.height=e+"px"},this.hr=1,this.vr=1,this.smooth=function(t){return void 0!==t?(l.imageSmoothingEnabled=l.mozImageSmoothingEnabled=l.oImageSmoothingEnabled=l.msImageSmoothingEnabled=t,r=t,this):r},this.smooth(r),this.crisp=function(t){t?(h.style["image-rendering"]="optimizeSpeed",h.style["image-rendering"]="crisp-edges",h.style["image-rendering"]="-moz-crisp-edges",h.style["image-rendering"]="-webkit-optimize-contrast",h.style["image-rendering"]="optimize-contrast",h.style["image-rendering"]="pixelated",h.style.msInterpolationMode="nearest-neighbor"):(h.style["image-rendering"]="auto",h.style.msInterpolationMode="bicubic")},this.crisp(o),this.getImageData=function(t,e,i,s){return t=t||0,e=e||0,i=i||this.w,s=s||this.h,l.getImageData(t,e,i,s)},this.toDataURL=function(t){return h.toDataURL(t||"image/png")},this.createPattern=function(t,e){return l.createPattern(t,e||"repeat")},this.createGradient=function(t,e,i,s){var n=0,a=0,r=0,o=soya2d.GRADIENT_LINEAR,h=0,c=0;s&&(n=s.angle||0,a=s.x||0,r=s.y||0,o=s.type||soya2d.GRADIENT_LINEAR,h=s.focalRatio||0,c=s.focalRadius||0);var u,f=soya2d.Math;switch(n=Math.abs((n||0)>>0),o){case soya2d.GRADIENT_LINEAR:u=l.createLinearGradient(a,r,a+i*f.COSTABLE[n],r+i*f.SINTABLE[n]);for(var d=0,_=t.length;_>d;d++)u.addColorStop(t[d],e[d]||"RGBA(0,0,0,0)");break;case soya2d.GRADIENT_RADIAL:var g=i*h;u=l.createRadialGradient(a,r,c,a+g*f.COSTABLE[n],r+g*f.SINTABLE[n],i);for(var d=0,_=t.length;_>d;d++)u.addColorStop(t[d],e[d]||"RGBA(0,0,0,0)")}return u}},soya2d.CanvasRenderer.prototype.getImageFrom=function(t,e,i){var s=document.createElement("canvas");s.width=e||t.w,s.height=i||t.h;var n=s.getContext("2d"),a=new soya2d.CanvasGraphics(n),r=new Image;return r.src=s.toDataURL("image/png"),a=null,s=null,r},soya2d.Path=function(t){this.d=t||"",this.cmd=["m","l","c","q","z"],this._insQ=[],this.__parse()},soya2d.ext(soya2d.Path.prototype,{__parse:function(){var t=new RegExp("["+this.cmd.join("")+"]([^"+this.cmd.join("")+"]+|$)","img"),e=this.d.replace(/^\s+|\s+$/,"").match(t);e.forEach(function(t){t=t.replace(/^\s+|\s+$/,"");var e=t[0].toLowerCase();if(this.cmd.indexOf(e)>-1){var i=t.substr(1).replace(/^\s/gm,"").split(/\n|,|\s/gm);this._insQ.push([e,i])}},this)},setPath:function(t){this.d=t,this.__parse()}}),soya2d.Device=new function(){var t=this.userAgent=self.navigator.userAgent.toLowerCase(),e=t.indexOf("windows")>0?!0:!1,i=t.indexOf("linux")>0?!0:!1,s=t.indexOf("mac os")>0?!0:!1,n=t.indexOf("android")>0?!0:!1,a=t.indexOf("iphone")>0?!0:!1,r=t.indexOf("ipad")>0?!0:!1,o=t.indexOf("windows phone")>0?!0:!1;this.iphone=a,this.ipad=r,this.ios=a||r,this.android=n,this.wp=o,this.mobile=this.ios||n||o,this.windows=e,this.linux=i,this.mac=s;var h={Firefox:t.indexOf("firefox")+1,Opera:t.indexOf("opera")+1,Chrome:t.indexOf("chrome")+1,Safari:t.indexOf("safari")>-1&&t.indexOf("chrome")<0};this.ie=/msie|trident.*rv:/.test(t.toLowerCase()),this.ff=h.Firefox?!0:!1,this.opera=h.Opera?!0:!1,this.chrome=h.Chrome?!0:!1,this.safari=h.Safari?!0:!1},soya2d.Font=function(t){var e=document.createElement("span"),i=["padding:0 !important;","margin:0 !important;","top:-9999px !important;","left:-9999px !important;","white-space:nowrap !important;","position:absolute !important;"];e.style.cssText=i.join("")+"font:"+(t||"normal 400 13px/normal sans-serif"),document.body.appendChild(e),this.fontString=e.style.font,this.__textRenderer=function(t){if(t.font(this.font),this.__lines){t.fillStyle(this.fillStyle);for(var e=0,i=this.__lines.length;i>e;e++){var s=this.__lines[e];if(this.letterSpacing>0)for(var n=0,a=0,r=s.length;r>a;a++)t.fillText(s[a],n,(this.__lh+this.lineSpacing)*e),n+=this.letterSpacing+this.__uw;else t.fillText(s,0,(this.__lh+this.lineSpacing)*e)}}},this.clone=function(){return new soya2d.Font(this.getDesc())},this.getDesc=function(){return e.style.font},this.style=function(t){return arguments.length>0?(e.style.fontStyle=t,this.fontString=e.style.font,this):e.style.fontStyle},this.weight=function(t){return arguments.length>0?(e.style.fontWeight=t,this.fontString=e.style.font,this):e.style.fontWeight},this.size=function(t){return arguments.length>0?(e.style.fontSize=t+"px",this.fontString=e.style.font,this):e.style.fontSize},this.family=function(t){return arguments.length>0?(t&&(e.style.fontFamily=t,this.fontString=e.style.font),this):e.style.fontFamily},this.getBounds=function(t){e.innerText=t;var i=e.offsetHeight,s=e.offsetWidth;return{w:s,h:i}}},soya2d.ImageFont=function(t,e){this.__fontMap=t;var i=t.texs[Object.keys(t.texs)[0]].height;this.fontSize=e||i,this.fontWidth=t.texs[Object.keys(t.texs)[0]].width;var s=1;this.__textRenderer=function(t){if(this.__lines)for(var e=0,i=0,n=0,a=this.__lines.length;a>n;n++){for(var r=this.__lines[n],o=0,h=0,c=r.length;c>h;h++){var l=r[h],u=this.font.__fontMap.get(l);if(u){var f=u.width*s,d=u.height*s;i=f,t.map(u,o,e,f,d,0,0,u.width,u.height)}o+=i+this.letterSpacing}e+=this.font.fontSize+this.lineSpacing}},this.clone=function(){return new soya2d.ImageFont(this.__fontMap)},this.size=function(t){return arguments.length>0?(this.fontSize=parseInt(t)||i,s=this.fontSize/i,this):this.fontSize},this.getBounds=function(t){var e=t.length;return{w:e*this.fontWidth*s,h:this.fontSize}},e&&this.size(e)},soya2d.class("soya2d.Text",{"extends":soya2d.DisplayObjectContainer,constructor:function(t){this.text=t.text||"",this.letterSpacing=t.letterSpacing||0,this.lineSpacing=t.lineSpacing||0,this.font=t.font,"string"==typeof this.font?this.font=new soya2d.Font(this.font):this.font instanceof soya2d.Atlas&&(this.font=new soya2d.ImageFont(this.font,t.size));var e=this.font||new soya2d.Font;this.font=e,this.__changed=!0,this.__lines,this.__renderer=this.font.__textRenderer,this.fillStyle=t.fillStyle||"#000";var i=this.font.getBounds(this.text);this.w||(this.w=i.w),this.h||(this.h=i.h)},onRender:function(t){this.__renderer(t)},refresh:function(){this.__changed=!0},setFont:function(t){t&&(this.font=t,this.__renderer=this.font.__textRenderer)},setText:function(t,e){return this.text=t+"",this.refresh(),e&&(this.w=this.font.getBounds(this.text).w),this},_onUpdate:function(){if(!this.__lh){var t=this.font.getBounds("s"),e=this.font.getBounds("豆");this.__lh=(t.h+e.h)/2>>0,this.__uw=(t.w+e.w)/2>>0}this.__changed&&(this.__lines=this.__calc(),this.__changed=!1)},__calc:function(){var t=this.letterSpacing,e=this.w/(this.__uw+t)>>0;1>e&&(this.w=1.5*this.__uw,e=1);for(var i=this.font,s=this.text.split("\n"),n=[],a=0,r=s.length;r>a;a++){var o=s[a];if(o)for(var h=o.length,c=0;h>c;){var l=o.substr(c,e+1),u=i.getBounds(l).w+l.length*t;if(u>this.w){for(var f=e+1;f--;)if(l=l.substr(0,l.length-1),u=i.getBounds(l).w+l.length*t,u<=this.w){if(0===u)return;n.push(l),c+=l.length;break}}else{for(var d=c,f=1;h-c>f;f++){if(l=o.substr(c,e+1+f),u=i.getBounds(l).w+l.length*t,u>this.w){n.push(l.substr(0,l.length-1)),c+=l.length-1;break}if(l===o){e=o.length-1;break}}if(c===d){l=o.substr(c,e+1),n.push(l);break}}}else n.push("")}return n}}),soya2d.Game=function(t){function i(t){f.running&&(u=requestAFrame(function(e){0===d&&(d=e);var s=e-d;if(d=e,m>l){var n=Date.now();
t&&t(n,s),m%=l}m+=s,i(t)}))}t=t||{};var s=t.container||document.body;"string"==typeof s&&(s=document.querySelector(s));var o=(t.rendererType||soya2d.RENDERER_TYPE_CANVAS,s.offsetWidth||100),h=s.offsetHeight||100,c=null;c=new soya2d.CanvasRenderer({smoothEnable:t.smoothEnable,autoClear:t.autoClear,container:s,sortEnable:!0,w:t.w||o,h:t.h||h}),soya2d.ext(this,t),this.renderer=c,this.objects=new w(this),this.add=new x(this),this.events=new a,this.events.__signalHandler=new r,this.scene=new g(this),this.stage=new X({game:this,w:c.w,h:c.h}),this.world=new j({game:this,w:c.w,h:c.h}),this.stage.add(this.world),this.camera=new e(c.w,c.h,this),this.assets=new n,this.load=new B(this),this.timer=new F,this.physics=new z,this.w=c.w,this.h=c.h,this.running=!1,this.start=function(){if(!this.running){this.running=!0,this.stage.__scan(this.w,this.h,s,c);var t=soya2d.module._getAll(),e=[],n=[],a=[],r=[],o=[];for(var h in t)t[h].onStart&&t[h].onStart(this),t[h].onBeforeUpdate&&e.push([t[h],t[h].onBeforeUpdate]),t[h].onUpdate&&n.push([t[h],t[h].onUpdate]),t[h].onAfterUpdate&&a.push([t[h],t[h].onAfterUpdate]),t[h].onBeforeRender&&r.push([t[h],t[h].onBeforeRender]),t[h].onAfterRender&&o.push([t[h],t[h].onAfterRender]);return l=1e3/y,i(function(t,i){e.forEach(function(e){e[1].call(e[0],f,t,i)}),n.length>0&&(t=Date.now(),n.forEach(function(e){e[1].call(e[0],f,t,i)})),f.physics.running&&game.physics.update(),f.camera.__onUpdate(),f.timer.__scan(i),f.currentScene.onUpdate&&f.currentScene.onUpdate(f,i),f.stage.__preUpdate(f,i),f.stage.__updateMatrix(),f.stage.__postUpdate(f,i),a.length>0&&(t=Date.now(),a.forEach(function(e){e[1].call(e[0],f,t,i)})),f.camera.__cull(f.stage),f.camera.__viewport(f.world),r.length>0&&(t=Date.now(),r.forEach(function(e){e[1].call(e[0],f,t,i)})),c.render(f.stage,f.camera),o.length>0&&(t=Date.now(),o.forEach(function(e){e[1].call(e[0],f,t,i)}))}),this}};var l,u,f=this,d=0,_=60,y=60,m=0;this.setFPS=function(t){return y=parseInt(t)||_,y=y>_?_:y,l=1e3/y,this},this.stop=function(){cancelAFrame(u),this.running=!1;var t=soya2d.module._getAll();for(var e in t)t[e].onStop&&t[e].onStop(this);return this},this.destroy=function(){this.running&&this.stop();var t=soya2d.module._getAll();for(var e in t)t[e].onDestroy&&t[e].onDestroy(this);this.renderer.destroy(),this.stage.destroy();var i=soya2d.games.indexOf(this);i>-1&&soya2d.games.splice(i,1)};var p=soya2d.module._getAll(),v=0;for(var b in p)p[b].onInit&&p[b].onInit(this),v++;this.objects.register("shape",soya2d.Shape),this.objects.register("sprite",soya2d.Sprite),this.objects.register("tileSprite",soya2d.TileSprite),this.objects.register("group",soya2d.DisplayObjectContainer),this.objects.register("text",soya2d.Text);var T="soya2d Game instance created...",E=v+" plugins loaded...";soya2d.console.info(T),soya2d.console.info(E),soya2d.games.push(this)},soya2d.games=[];var H="soya2d "+soya2d.version.toString()+" is working...",Y="==== thank you for using soya2d, you'll love it! ====";soya2d.console.info(H),soya2d.console.info(Y),soya2d.RENDERER_TYPE_AUTO=1,soya2d.RENDERER_TYPE_CANVAS=2,soya2d.RENDERER_TYPE_WEBGL=3}(window||this);